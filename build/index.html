<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.11.26' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"code_editor_font_size": 14, "default_width": "full", "theme": "light", "dataframes": "rich", "cell_output": "above"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000, "pythonpath": []}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "poetry"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "full", "app_title": "Causal Inference", "auto_download": ["ipynb", "html"]}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>Causal Inference</title>
    <script type="module" crossorigin src="./assets/index-BVerm-H3.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-C2fFKqQX.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.11.26%22%0Aapp%20%3D%20marimo.App(%0A%20%20%20%20width%3D%22full%22%2C%0A%20%20%20%20app_title%3D%22Causal%20Inference%22%2C%0A%20%20%20%20auto_download%3D%5B%22ipynb%22%2C%20%22html%22%5D%2C%0A)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20from%20IPython.display%20import%20Image%0A%20%20%20%20mo.as_html(Image(url%3D%22https%3A%2F%2Fimgs.xkcd.com%2Fcomics%2Fcorrelation_2x.png%22)).center()%0A%20%20%20%20return%20Image%2C%20mo%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_()%3A%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20import%20seaborn%20as%20sns%0A%20%20%20%20from%20sklearn.linear_model%20import%20LinearRegression%0A%20%20%20%20return%20LinearRegression%2C%20np%2C%20pd%2C%20plt%2C%20sns%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%22%22%22%23%20Understanding%20Causal%20Inference%20with%20IHDP%3A%20From%20Theory%20to%20Practice%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20In%20predictive%20modeling%2C%20we%20often%20focus%20on%20finding%20correlations%20between%20variables.%20However%2C%20for%20decision-making%2C%20we%20need%20to%20understand%20the%20*causal*%20relationship%20between%20actions%20and%20outcomes.%0A%0A%20%20%20%20%20%20%20%20The%20fundamental%20problem%20of%20causal%20inference%20is%20that%20we%20can%20never%20observe%20both%20potential%20outcomes%20for%20the%20same%20unit%20-%20we%20can't%20simultaneously%20observe%20what%20happens%20when%20a%20person%20receives%20a%20treatment%20and%20doesn't%20receive%20a%20treatment.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.callout(%22%22%22%0A%20%20%20%20In%20causal%20inference%2C%20a%20confounder%20is%20a%20variable%20that%20affects%20both%20the%20treatment%20(or%20independent%20variable)%20and%20the%20outcome%20(or%20dependent%20variable)%2C%20potentially%20creating%20a%20spurious%20association%20if%20not%20controlled%20for.%20For%20example%2C%20when%20studying%20the%20effect%20of%20alcohol%20consumption%20on%20lung%20cancer%20risk%2C%20smokers%20tend%20to%20drink%20more%20and%20smoking%20is%20a%20direct%20cause%20of%20lung%20cancer%2C%20so%20smoking%20acts%20as%20a%20confounder%20that%20can%20distort%20the%20observed%20relationship%20between%20alcohol%20and%20cancer.%0A%20%20%20%20%22%22%22%2C%20kind%3D%22info%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(LinearRegression%2C%20mo%2C%20np%2C%20pd%2C%20plt)%3A%0A%20%20%20%20%23%20Set%20random%20seed%20for%20reproducibility%0A%20%20%20%20np.random.seed(42)%0A%0A%20%20%20%20%23%20Generate%20data%20to%20illustrate%20correlation%20vs%20causation%0A%20%20%20%20n%20%3D%201000%0A%0A%20%20%20%20%23%20Common%20cause%20(confounder)%0A%20%20%20%20confounder%20%3D%20np.random.normal(0%2C%201%2C%20n)%0A%0A%20%20%20%20%23%20Treatment%20influenced%20by%20confounder%0A%20%20%20%20treatment%20%3D%200.7%20*%20confounder%20%2B%20np.random.normal(0%2C%200.5%2C%20n)%0A%0A%20%20%20%20%23%20Outcome%20influenced%20by%20both%20treatment%20and%20confounder%0A%20%20%20%20outcome%20%3D%200.3%20*%20treatment%20%2B%200.7%20*%20confounder%20%2B%20np.random.normal(0%2C%200.5%2C%20n)%0A%0A%20%20%20%20%23%20Create%20a%20DataFrame%0A%20%20%20%20data%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20'Treatment'%3A%20treatment%2C%0A%20%20%20%20%20%20%20%20'Outcome'%3A%20outcome%2C%0A%20%20%20%20%20%20%20%20'Confounder'%3A%20confounder%0A%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Create%20model%20for%20the%20regression%20line%0A%20%20%20%20model%20%3D%20LinearRegression()%0A%20%20%20%20model.fit(data%5B%5B'Treatment'%5D%5D%2C%20data%5B'Outcome'%5D)%0A%0A%0A%20%20%20%20fig_1%20%3D%20plt.figure(figsize%3D(12%2C%205))%0A%0A%20%20%20%20%23%20Plot%201%3A%20Treatment%20vs%20Outcome%20(shows%20correlation)%0A%20%20%20%20ax1%20%3D%20plt.subplot(1%2C%202%2C%201)%0A%20%20%20%20ax1.scatter(data%5B'Treatment'%5D%2C%20data%5B'Outcome'%5D%2C%20alpha%3D0.5)%0A%0A%20%20%20%20%23%20Add%20regression%20line%0A%20%20%20%20x_range%20%3D%20np.linspace(data%5B'Treatment'%5D.min()%2C%20data%5B'Treatment'%5D.max()%2C%20100)%0A%20%20%20%20ax1.plot(x_range%2C%20model.predict(x_range.reshape(-1%2C%201))%2C%20'r-'%2C%20linewidth%3D2)%0A%20%20%20%20ax1.set_title('Correlation%3A%20Treatment%20vs%20Outcome%5CnCorrelation%20%3D%20%7B%3A.2f%7D'.format(%0A%20%20%20%20%20%20%20%20np.corrcoef(data%5B'Treatment'%5D%2C%20data%5B'Outcome'%5D)%5B0%2C%201%5D))%0A%20%20%20%20ax1.set_xlabel('Treatment')%0A%20%20%20%20ax1.set_ylabel('Outcome')%0A%0A%20%20%20%20%23%20Plot%202%3A%20Treatment%20vs%20Outcome%20with%20confounder%20as%20color%0A%20%20%20%20ax2%20%3D%20plt.subplot(1%2C%202%2C%202)%0A%20%20%20%20scatter%20%3D%20ax2.scatter(data%5B'Treatment'%5D%2C%20data%5B'Outcome'%5D%2C%20c%3Ddata%5B'Confounder'%5D%2C%20cmap%3D'viridis'%2C%20alpha%3D0.5)%0A%20%20%20%20plt.colorbar(scatter%2C%20label%3D'Confounder')%0A%20%20%20%20ax2.set_title('Causal%20Structure%3A%20Treatment%2C%20Outcome%2C%20and%20Confounder')%0A%20%20%20%20ax2.set_xlabel('Treatment')%0A%20%20%20%20ax2.set_ylabel('Outcome')%0A%0A%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%23%20Return%20interactive%20plot%20for%20marimo%0A%20%20%20%20mo.mpl.interactive(fig_1)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20ax1%2C%0A%20%20%20%20%20%20%20%20ax2%2C%0A%20%20%20%20%20%20%20%20confounder%2C%0A%20%20%20%20%20%20%20%20data%2C%0A%20%20%20%20%20%20%20%20fig_1%2C%0A%20%20%20%20%20%20%20%20model%2C%0A%20%20%20%20%20%20%20%20n%2C%0A%20%20%20%20%20%20%20%20outcome%2C%0A%20%20%20%20%20%20%20%20scatter%2C%0A%20%20%20%20%20%20%20%20treatment%2C%0A%20%20%20%20%20%20%20%20x_range%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20grid%3B%20grid-template-columns%3A%201fr%201fr%3B%20gap%3A%2020px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Ch3%3ELeft%20Plot%3C%2Fh3%3E%0A%20%20%20%20%20%20%20%20Shows%20the%20correlation%20between%20treatment%20and%20outcome%20(0.78)%2C%20with%20a%20regression%20line%20indicating%20a%20strong%20positive%20relationship.%20This%20is%20what%20you%20might%20see%20in%20an%20observational%20study%20without%20accounting%20for%20confounders.%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Ch3%3ERight%20Plot%3C%2Fh3%3E%0A%20%20%20%20%20%20%20%20The%20same%20data%20points%2C%20but%20colored%20by%20the%20confounder%20value.%20This%20reveals%20the%20underlying%20structure%20-%20points%20with%20similar%20confounder%20values%20cluster%20together%2C%20showing%20that%20the%20apparent%20treatment-outcome%20relationship%20is%20largely%20driven%20by%20the%20confounder.%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.callout(%22%22%22%0A%20%20%20%20The%20simulation%20demonstrates%20that%20despite%20seeing%20a%20strong%20correlation%20(0.78)%2C%20the%20actual%20causal%20effect%20of%20the%20treatment%20on%20the%20outcome%20is%20weaker%20(0.3%20in%20the%20data%20generation).%20The%20rest%20of%20the%20association%20is%20due%20to%20the%20confounder%20creating%20a%20spurious%20correlation%20-%20a%20classic%20example%20of%20%22correlation%20does%20not%20imply%20causation.%22%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%202.%20Theoretical%20Foundations%20of%20Causal%20Inference%20%7B%23foundations%7D%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Creating%20application%20domain%20columns%0A%20%20%20%20healthcare%20%3D%20mo.md(%0A%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%23%20Healthcare%0A%20%20%20%20-%20Evaluating%20treatment%20effectiveness%0A%20%20%20%20-%20Understanding%20disease%20progression%0A%20%20%20%20-%20Personalizing%20medical%20decisions%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%0A%20%20%20%20policy%20%3D%20mo.md(%0A%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%23%20Policy%0A%20%20%20%20-%20Program%20evaluation%0A%20%20%20%20-%20Social%20interventions%20assessment%0A%20%20%20%20-%20Education%20policy%20design%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%0A%20%20%20%20business%20%3D%20mo.md(%0A%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%23%20Business%0A%20%20%20%20-%20Marketing%20strategy%20optimization%0A%20%20%20%20-%20Product%20feature%20evaluations%0A%20%20%20%20-%20Customer%20retention%20strategies%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Real-world%20applications%20section%20with%20columns%0A%20%20%20%20applications_title%20%3D%20mo.md(%22%23%23%23%202.1%20Real-World%20Applications%20%7B%23applications%7D%5Cn%5CnCausal%20inference%20is%20crucial%20in%20various%20domains%3A%22)%0A%20%20%20%20applications_columns%20%3D%20mo.hstack(%5Bhealthcare%2C%20policy%2C%20business%5D)%0A%0A%20%20%20%20%23%20Key%20concepts%20section%0A%20%20%20%20concepts%20%3D%20mo.md(%0A%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%23%202.2%20Key%20Concepts%20in%20Causal%20Inference%20%7B%23concepts%7D%0A%0A%20%20%20%20**The%20Potential%20Outcomes%20Framework**%0A%0A%20%20%20%20Developed%20by%20Rubin%2C%20this%20framework%20formalizes%20causal%20inference%20through%20potential%20outcomes.%20For%20each%20unit%20i%3A%0A%20%20%20%20-%20Y_i(1)%3A%20Outcome%20if%20unit%20i%20receives%20treatment%0A%20%20%20%20-%20Y_i(0)%3A%20Outcome%20if%20unit%20i%20doesn't%20receive%20treatment%0A%0A%20%20%20%20The%20individual%20treatment%20effect%20is%20defined%20as%3A%0A%0A%20%20%20%20%5C%5C%5B%20%5C%5Ctau_i%20%3D%20Y_i(1)%20-%20Y_i(0)%20%5C%5C%5D%0A%0A%20%20%20%20However%2C%20we%20can%20only%20observe%20one%20of%20these%20outcomes%20for%20each%20unit%2C%20which%20is%20known%20as%20the%20**fundamental%20problem%20of%20causal%20inference**.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Display%20all%20sections%0A%20%20%20%20mo.vstack(%5Bapplications_title%2C%20applications_columns%2C%20concepts%5D)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20applications_columns%2C%0A%20%20%20%20%20%20%20%20applications_title%2C%0A%20%20%20%20%20%20%20%20business%2C%0A%20%20%20%20%20%20%20%20concepts%2C%0A%20%20%20%20%20%20%20%20healthcare%2C%0A%20%20%20%20%20%20%20%20policy%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%202.3%20Types%20of%20Treatment%20Effects%20in%20Causal%20Inference%20%7B%23effects%7D%0A%0A%20%20%20%20%20%20%20%20%23%23%23%20What%20are%20%22Treatments%22%20in%20Causal%20Inference%3F%0A%0A%20%20%20%20%20%20%20%20In%20causal%20inference%2C%20a%20**treatment**%20refers%20to%20the%20intervention%20or%20manipulation%20being%20studied%20to%20determine%20its%20causal%20effect%20on%20an%20outcome%20of%20interest.%20Despite%20the%20medical-sounding%20terminology%2C%20treatments%20extend%20far%20beyond%20healthcare%20settings%3A%0A%0A%20%20%20%20%20%20%20%20-%20Medical%20interventions%20(medications%2C%20surgical%20procedures)%0A%20%20%20%20%20%20%20%20-%20Policy%20changes%20(minimum%20wage%20increases%2C%20educational%20reforms)%20%0A%20%20%20%20%20%20%20%20-%20Business%20decisions%20(pricing%20strategies%2C%20marketing%20campaigns)%0A%20%20%20%20%20%20%20%20-%20Social%20interventions%20(training%20programs%2C%20behavioral%20modifications)%0A%0A%20%20%20%20%20%20%20%20The%20**treatment%20variable**%20typically%20represents%20whether%20subjects%20received%20the%20intervention%2C%20usually%20coded%20as%20a%20binary%20variable%20(1%3Dreceived%20treatment%2C%200%3Dcontrol%2Fplacebo)%2C%20though%20it%20can%20sometimes%20be%20categorical%20for%20different%20treatment%20types%20or%20doses.%0A%0A%20%20%20%20%20%20%20%20%23%23%23%20Why%20Calculate%20Treatment%20Effects%3F%0A%0A%20%20%20%20%20%20%20%20Treatment%20effects%20measure%20the%20causal%20effect%20of%20a%20treatment%20on%20an%20outcome.%20We%20calculate%20them%20to%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Establish%20causality%2C%20not%20just%20correlation**%3A%20Determine%20the%20independent%20effect%20of%20a%20treatment%20when%20other%20factors%20are%20controlled%20for%0A%20%20%20%20%20%20%20%202.%20**Understand%20counterfactuals**%3A%20Estimate%20what%20would%20have%20happened%20to%20treated%20units%20had%20they%20not%20received%20treatment%20(and%20vice%20versa)%0A%20%20%20%20%20%20%20%203.%20**Quantify%20impact**%3A%20Measure%20not%20just%20whether%20an%20intervention%20worked%2C%20but%20how%20well%20it%20worked%20and%20for%20whom%0A%20%20%20%20%20%20%20%204.%20**Inform%20decision-making**%3A%20Make%20better%20decisions%20about%20implementing%20interventions%20and%20targeting%20specific%20populations%0A%0A%20%20%20%20%20%20%20%20%23%23%23%20Key%20Treatment%20Effect%20Measures%0A%0A%20%20%20%20%20%20%20%20**Average%20Treatment%20Effect%20(ATE)%3A**%0A%20%20%20%20%20%20%20%20The%20average%20effect%20of%20the%20treatment%20across%20the%20entire%20population.%0A%0A%20%20%20%20%20%20%20%20%5C%5C%5B%20ATE%20%3D%20E%5BY(1)%20-%20Y(0)%5D%20%5C%5C%5D%0A%0A%20%20%20%20%20%20%20%20Where%20Y(1)%20represents%20the%20potential%20outcome%20if%20treated%2C%20and%20Y(0)%20represents%20the%20potential%20outcome%20if%20not%20treated.%20This%20measures%20the%20expected%20difference%20in%20outcomes%20if%20everyone%20in%20the%20population%20received%20treatment%20versus%20if%20no%20one%20did.%0A%0A%20%20%20%20%20%20%20%20**Conditional%20Average%20Treatment%20Effect%20(CATE)%3A**%0A%20%20%20%20%20%20%20%20The%20average%20effect%20of%20the%20treatment%20conditional%20on%20specific%20covariates%20or%20characteristics.%0A%0A%20%20%20%20%20%20%20%20%5C%5C%5B%20CATE(X%3Dx)%20%3D%20E%5BY(1)%20-%20Y(0)%20%7C%20X%3Dx%5D%20%5C%5C%5D%0A%0A%20%20%20%20%20%20%20%20This%20measures%20how%20treatment%20effects%20vary%20across%20different%20subgroups%20defined%20by%20characteristics%20X.%20CATE%20helps%20identify%20which%20groups%20benefit%20most%20from%20treatment%2C%20enabling%20more%20targeted%20interventions.%0A%0A%20%20%20%20%20%20%20%20**Average%20Treatment%20Effect%20on%20the%20Treated%20(ATT%2FATET)%3A**%0A%20%20%20%20%20%20%20%20The%20average%20effect%20among%20those%20who%20actually%20received%20the%20treatment.%0A%0A%20%20%20%20%20%20%20%20%5C%5C%5B%20ATT%20%3D%20E%5BY(1)%20-%20Y(0)%20%7C%20T%3D1%5D%20%5C%5C%5D%0A%0A%20%20%20%20%20%20%20%20This%20answers%3A%20%22How%20much%20did%20those%20who%20received%20the%20treatment%20actually%20benefit%3F%22%20It's%20particularly%20useful%20when%20evaluating%20programs%20that%20were%20targeted%20at%20specific%20populations%20or%20when%20treatment%20assignment%20wasn't%20random.%0A%0A%20%20%20%20%20%20%20%20%23%23%23%20Challenges%20in%20Estimation%0A%0A%20%20%20%20%20%20%20%20A%20fundamental%20challenge%20is%20that%20we%20never%20observe%20both%20potential%20outcomes%20for%20the%20same%20unit%E2%80%94known%20as%20the%20%22fundamental%20problem%20of%20causal%20inference%22.%20Various%20methods%20address%20this%20challenge%2C%20including%3A%0A%0A%20%20%20%20%20%20%20%20-%20Randomized%20experiments%0A%20%20%20%20%20%20%20%20-%20Regression%20adjustment%0A%20%20%20%20%20%20%20%20-%20Matching%20methods%0A%20%20%20%20%20%20%20%20-%20Instrumental%20variables%0A%20%20%20%20%20%20%20%20-%20Inverse%20probability%20weighting%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20the%20header%0A%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%202.4%20Key%20Assumptions%20in%20Causal%20Inference%20%7B%23assumptions%7D%22)%0A%0A%20%20%20%20%23%20Create%20separate%20elements%20for%20each%20assumption%20as%20callouts%20with%20fixed%20height%0A%20%20%20%20assumption1%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%201.%20Unconfoundedness%20(Ignorability)%0A%20%20%20%20%20%20%20%20%20%20%20%20Treatment%20assignment%20is%20independent%20of%20potential%20outcomes%20given%20observed%20covariates.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%5C%5C%5B%20(Y(0)%2C%20Y(1))%20%5C%5Cperp%20T%20%7C%20X%20%5C%5C%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20assumption2%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%202.%20Positivity%20(Overlap)%0A%20%20%20%20%20%20%20%20%20%20%20%20Every%20unit%20has%20a%20non-zero%20probability%20of%20receiving%20either%20treatment%20or%20control.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%5C%5C%5B%200%20%3C%20P(T%3D1%7CX%3Dx)%20%3C%201%20%5C%5Ctext%7B%20for%20all%20%7D%20x%20%5C%5C%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20)%0A%0A%20%20%20%20assumption3%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%203.%20SUTVA%0A%20%20%20%20%20%20%20%20%20%20%20%20**Stable%20Unit%20Treatment%20Value%20Assumption**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20*%20No%20interference%3A%20One%20unit's%20treatment%20doesn't%20affect%20another%20unit's%20outcome%0A%20%20%20%20%20%20%20%20%20%20%20%20*%20No%20hidden%20variations%20of%20treatment%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Stack%20the%20header%20and%20the%20columns%20of%20assumptions%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bassumption1%2C%20assumption2%2C%20assumption3%5D)%0A%20%20%20%20%5D)%0A%20%20%20%20return%20assumption1%2C%20assumption2%2C%20assumption3%2C%20header%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo%2C%20np%2C%20plt)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20the%20overlap%20assumption%0A%20%20%20%20%20%20%20%20%23%20Use%20local%20variables%20with%20unique%20names%20to%20avoid%20conflicts%0A%20%20%20%20%20%20%20%20sample_size%20%3D%201000%20%20%23%20Instead%20of%20reusing%20'n'%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20two%20features%0A%20%20%20%20%20%20%20%20X1%20%3D%20np.random.normal(0%2C%201%2C%20sample_size)%0A%20%20%20%20%20%20%20%20X2%20%3D%20np.random.normal(0%2C%201%2C%20sample_size)%0A%0A%20%20%20%20%20%20%20%20%23%20Scenario%201%3A%20Good%20overlap%0A%20%20%20%20%20%20%20%20p_good%20%3D%201%20%2F%20(1%20%2B%20np.exp(-(0.5%20*%20X1)))%0A%20%20%20%20%20%20%20%20treatment_good%20%3D%20np.random.binomial(1%2C%20p_good%2C%20sample_size)%0A%0A%20%20%20%20%20%20%20%20%23%20Scenario%202%3A%20Poor%20overlap%0A%20%20%20%20%20%20%20%20p_poor%20%3D%201%20%2F%20(1%20%2B%20np.exp(-(3%20*%20X1%20%2B%202%20*%20X2)))%0A%20%20%20%20%20%20%20%20treatment_poor%20%3D%20np.random.binomial(1%2C%20p_poor%2C%20sample_size)%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20-%20use%20a%20different%20variable%20name%20than%20'fig'%0A%20%20%20%20%20%20%20%20overlap_fig%2C%20axes%20%3D%20plt.subplots(1%2C%202%2C%20figsize%3D(10%2C%205))%0A%0A%20%20%20%20%20%20%20%20%23%20Good%20overlap%0A%20%20%20%20%20%20%20%20axes%5B0%5D.scatter(X1%2C%20X2%2C%20c%3Dtreatment_good%2C%20cmap%3D'coolwarm'%2C%20alpha%3D0.6)%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_title('Good%20Overlap')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_xlabel('X1')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_ylabel('X2')%0A%0A%20%20%20%20%20%20%20%20%23%20Poor%20overlap%0A%20%20%20%20%20%20%20%20axes%5B1%5D.scatter(X1%2C%20X2%2C%20c%3Dtreatment_poor%2C%20cmap%3D'coolwarm'%2C%20alpha%3D0.6)%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_title('Poor%20Overlap%20(Positivity%20Violation)')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_xlabel('X1')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_ylabel('X2')%0A%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Use%20marimo's%20display%20method%20instead%20of%20plt.show()%0A%20%20%20%20%20%20%20%20return%20mo.mpl.interactive(overlap_fig)%0A%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20header%20for%20the%20DAG%20section%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%202.5%20Interactive%20Causal%20Diagram%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20mermaid%20diagram%20for%20the%20IHDP%20causal%20structure%0A%20%20%20%20%20%20%20%20diagram%20%3D%20mo.mermaid(%22%22%22%0A%20%20%20%20%20%20%20%20graph%20TB%0A%20%20%20%20%20%20%20%20%20%20%20%20subgraph%20%22Covariates%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20BR%5B%22Birth%20Related%5Cnx_0%2C%20x_1%2C%20x_2%2C%20x_5%2C%20x_6%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20M%5B%22Mother's%20Characteristics%5Cnx_3%2C%20x_4%2C%20x_8%2C%20x_13-x_16%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20P%5B%22Pregnancy%20Behaviors%5Cnx_9%2C%20x_10%2C%20x_11%2C%20x_18%2C%20x_19%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20S%5B%22Socioeconomic%5Cnx_17%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20L%5B%22Location%5Cnx_20-x_24%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20BR%20--%3E%20T%5B%22Treatment%5CnIHDP%20Intervention%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20M%20--%3E%20T%0A%20%20%20%20%20%20%20%20%20%20%20%20P%20--%3E%20T%0A%20%20%20%20%20%20%20%20%20%20%20%20S%20--%3E%20T%0A%20%20%20%20%20%20%20%20%20%20%20%20L%20--%3E%20T%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20BR%20--%3E%20Y%5B%22Outcome%5CnCognitive%20Score%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20M%20--%3E%20Y%0A%20%20%20%20%20%20%20%20%20%20%20%20P%20--%3E%20Y%0A%20%20%20%20%20%20%20%20%20%20%20%20S%20--%3E%20Y%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20--%3E%20Y%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20T%20fill%3A%23ff9999%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20Y%20fill%3A%2399ccff%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20BR%20fill%3A%23f9f9f9%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20M%20fill%3A%23f9f9f9%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20P%20fill%3A%23f9f9f9%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20S%20fill%3A%23f9f9f9%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20L%20fill%3A%23f9f9f9%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20This%20directed%20acyclic%20graph%20(DAG)%20represents%20the%20assumed%20causal%20structure%20in%20the%20IHDP%20dataset%3A%0A%0A%20%20%20%20%20%20%20%20-%20**Covariates**%20(various%20characteristics)%20affect%20both%20treatment%20assignment%20and%20outcomes%0A%20%20%20%20%20%20%20%20-%20**Treatment**%20(IHDP%20intervention)%20affects%20the%20outcome%0A%20%20%20%20%20%20%20%20-%20The%20arrows%20represent%20causal%20relationships%0A%0A%20%20%20%20%20%20%20%20This%20structure%20illustrates%20why%20we%20need%20causal%20inference%20methods%20-%20the%20treatment%20effect%20is%20confounded%20by%20covariates%20that%20affect%20both%20treatment%20assignment%20and%20outcomes.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20the%20combined%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bheader%2C%20diagram%2C%20explanation%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20a%20two-column%20explanation%0A%20%20%20%20left_column%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%23%23%23%20Good%20Overlap%20(Left%20Plot)%0A%0A%20%20%20%20In%20this%20scenario%2C%20treatment%20assignment%20is%20weakly%20related%20to%20feature%20X1%3A%0A%20%20%20%20-%20Blue%20points%20(control)%20and%20red%20points%20(treatment)%20are%20well-mixed%20throughout%0A%20%20%20%20-%20Units%20across%20the%20entire%20covariate%20space%20have%20a%20reasonable%20probability%20of%20being%20in%20either%20treatment%20or%20control%20group%0A%20%20%20%20-%20Treatment%20probability%20is%20calculated%20using%20a%20mild%20logistic%20function%3A%20p%3D11%2Bexp(-(0.5%E2%8B%85X1))p%20%3D%201%2F(1%20%2B%20exp(-(0.5%20*%20X1)))%0A%20%20%20%20-%20This%20satisfies%20the%20positivity%20assumption%20because%200%3CP(T%3D1%E2%88%A3X%3Dx)%3C10%20%3C%20P(T%3D1%7CX%3Dx)%20%3C%201%20for%20all%20values%20of%20x%0A%20%20%20%20-%20Makes%20reliable%20causal%20inference%20possible%20because%20counterfactuals%20exist%20for%20all%20covariate%20values%0A%20%20%20%20-%20Allows%20for%20unbiased%20estimation%20of%20treatment%20effects%20(ATE%2C%20CATE%2C%20ATT)%0A%20%20%20%20%22%22%22).callout(kind%3D%22success%22)%0A%0A%20%20%20%20right_column%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%23%23%23%20Poor%20Overlap%20(Right%20Plot)%0A%0A%20%20%20%20In%20this%20scenario%2C%20treatment%20assignment%20is%20strongly%20determined%20by%20X1%20and%20X2%3A%0A%20%20%20%20-%20Clear%20separation%20between%20blue%20points%20(control)%20and%20red%20points%20(treatment)%0A%20%20%20%20-%20Left%20region%20has%20almost%20exclusively%20control%20units%0A%20%20%20%20-%20Right%20region%20has%20almost%20exclusively%20treatment%20units%0A%20%20%20%20-%20Treatment%20probability%20uses%20a%20steep%20logistic%20function%3A%20%60p%20%3D%201%2F(1%20%2B%20exp(-(3%20*%20X1%20%2B%202%20*%20X2)))%60%0A%20%20%20%20-%20Violates%20the%20positivity%20assumption%20because%20for%20some%20values%20of%20x%2C%20P(T%3D1%7CX%3Dx)%20%E2%89%88%200%20or%20P(T%3D1%7CX%3Dx)%20%E2%89%88%201%0A%20%20%20%20-%20Makes%20causal%20inference%20unreliable%20in%20regions%20without%20overlap%0A%20%20%20%20-%20Requires%20strong%20modeling%20assumptions%20or%20extrapolation%20to%20estimate%20treatment%20effects%0A%20%20%20%20-%20May%20lead%20to%20biased%20estimates%2C%20especially%20in%20subgroups%20with%20poor%20representation%20in%20one%20treatment%20condition%0A%20%20%20%20%22%22%22).callout(kind%3D%22danger%22)%0A%0A%20%20%20%20%23%20Display%20the%20two%20columns%20side%20by%20side%0A%20%20%20%20mo.hstack(%5Bleft_column%2C%20right_column%5D)%0A%20%20%20%20return%20left_column%2C%20right_column%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20header%20for%20the%20advanced%20causal%20inference%20methods%20section%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%202.6%20Advanced%20Causal%20Inference%20Methods%20%7B%23advanced-methods%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20description%20of%20propensity%20score%20methods%0A%20%20%20%20%20%20%20%20ps_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Propensity%20Score%20Methods%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Propensity%20score%20methods%20are%20statistical%20techniques%20for%20reducing%20selection%20bias%20in%20observational%20data.%20They%20work%20by%20balancing%20treatment%20groups%20on%20confounding%20factors%20to%20increase%20the%20validity%20of%20causal%20inference.%20The%20propensity%20score%20represents%20the%20probability%20of%20receiving%20treatment%20given%20a%20set%20of%20observed%20covariates.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Key%20applications%20include%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Matching**%3A%20Pairing%20treated%20and%20control%20units%20with%20similar%20propensity%20scores%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Stratification**%3A%20Grouping%20units%20into%20strata%20based%20on%20propensity%20scores%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Inverse%20Probability%20Weighting**%3A%20Weighting%20observations%20by%20the%20inverse%20of%20their%20propensity%20score%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Covariate%20adjustment**%3A%20Including%20propensity%20scores%20as%20covariates%20in%20regression%20models%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20While%20propensity%20score%20methods%20can%20be%20powerful%2C%20they%20only%20adjust%20for%20observed%20confounders%20and%20may%20have%20limitations%20when%20the%20functional%20form%20is%20misspecified.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20description%20of%20difference-in-differences%20design%0A%20%20%20%20%20%20%20%20did_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Difference-in-Differences%20(DiD)%20Design%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20Difference-in-Differences%20design%20is%20a%20quasi-experimental%20approach%20that%20estimates%20causal%20effects%20by%20comparing%20the%20changes%20in%20outcomes%20over%20time%20between%20a%20treatment%20group%20and%20a%20control%20group.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**This%20method%20is%20particularly%20useful%20when%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Random%20assignment%20to%20treatment%20is%20not%20feasible%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Pre-treatment%20data%20is%20available%20for%20both%20groups%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20The%20parallel%20trends%20assumption%20holds%20(both%20groups%20would%20follow%20the%20same%20trend%20in%20the%20absence%20of%20treatment)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20DiD%20isolates%20the%20effect%20of%20a%20treatment%20by%20removing%20biases%20from%20permanent%20differences%20between%20groups%20and%20from%20shared%20time%20trends.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20the%20combined%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bheader%2C%20ps_methods%2C%20did_methods%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20descriptions%20of%20more%20advanced%20methods%0A%20%20%20%20%20%20%20%20rdd_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Regression%20Discontinuity%20Design%20(RDD)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Regression%20discontinuity%20design%20is%20an%20important%20quasi-experimental%20approach%20that%20can%20be%20implemented%20when%20treatment%20assignment%20is%20determined%20by%20whether%20a%20continuous%20variable%20crosses%20a%20specific%20threshold.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20RDD%20exploits%20the%20fact%20that%20units%20just%20above%20and%20just%20below%20the%20cutoff%20threshold%20are%20similar%20in%20all%20respects%20except%20for%20treatment%20assignment%2C%20creating%20a%20situation%20similar%20to%20random%20assignment%20around%20the%20threshold.%20This%20design%20estimates%20causal%20treatment%20effects%20by%20comparing%20outcomes%20for%20units%20near%20this%20threshold.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Key%20elements%20of%20RDD%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20A%20continuous%20**running%20variable**%20(or%20assignment%20variable)%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20A%20clear%20**cutoff%20threshold**%20that%20determines%20treatment%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Sharp%20RDD**%3A%20Treatment%20is%20deterministically%20assigned%20based%20on%20the%20threshold%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Fuzzy%20RDD**%3A%20Threshold%20increases%20probability%20of%20treatment%20but%20doesn't%20determine%20it%20completely%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20description%20of%20synthetic%20control%20methods%0A%20%20%20%20%20%20%20%20scm_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Synthetic%20Control%20Methods%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Synthetic%20control%20methods%20allow%20for%20causal%20inference%20when%20we%20have%20as%20few%20as%20one%20treated%20unit%20and%20many%20control%20units%20observed%20over%20time.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**The%20approach%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Creates%20a%20weighted%20combination%20of%20control%20units%20that%20resembles%20the%20treated%20unit%20before%20intervention%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Uses%20this%20%22synthetic%20control%22%20to%20estimate%20what%20would%20have%20happened%20to%20the%20treated%20unit%20without%20treatment%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Is%20especially%20useful%20for%20policy%20interventions%20affecting%20entire%20regions%20or%20populations%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20This%20method%20has%20been%20described%20as%20%22the%20most%20important%20development%20in%20program%20evaluation%20in%20the%20last%20decade%22%20by%20some%20researchers%20and%20is%20particularly%20valuable%20for%20case%20studies%20with%20a%20small%20number%20of%20treated%20units.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20the%20combined%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Brdd_methods%2C%20scm_methods%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20descriptions%20of%20more%20advanced%20methods%0A%20%20%20%20%20%20%20%20sensitivity_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Sensitivity%20Analysis%20for%20Unobserved%20Confounding%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Unobserved%20confounding%20is%20a%20central%20barrier%20to%20drawing%20causal%20inferences%20from%20observational%20data.%20Sensitivity%20analysis%20explores%20how%20sensitive%20causal%20conclusions%20are%20to%20potential%20unobserved%20confounding%2C%20helping%20researchers%20understand%20the%20robustness%20of%20their%20findings.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Key%20approaches%20include%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Rosenbaum%20bounds**%3A%20Quantifies%20how%20strong%20an%20unobserved%20confounder%20would%20need%20to%20be%20to%20invalidate%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**E-values**%3A%20Measures%20the%20minimum%20strength%20of%20association%20an%20unmeasured%20confounder%20would%20need%20to%20have%20with%20both%20treatment%20and%20outcome%20to%20explain%20away%20an%20observed%20association%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Simulation-based%20methods**%3A%20Creating%20plausible%20scenarios%20with%20simulated%20confounders%20to%20test%20result%20stability%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20While%20methods%20like%20propensity%20score%20matching%20can%20adjust%20for%20observed%20confounding%2C%20sensitivity%20analysis%20helps%20address%20the%20%22Achilles%20heel%22%20of%20most%20nonexperimental%20studies%20-%20the%20potential%20impact%20of%20unmeasured%20confounding.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22danger%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20description%20of%20heterogeneous%20treatment%20effects%0A%20%20%20%20%20%20%20%20hte_methods%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Heterogeneous%20Treatment%20Effects%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Treatment%20effects%20often%20vary%20across%20different%20subpopulations%2C%20a%20phenomenon%20known%20as%20treatment%20effect%20heterogeneity.%20Understanding%20this%20heterogeneity%20is%20crucial%20for%20targeting%20interventions%20effectively.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Methods%20for%20estimating%20heterogeneous%20effects%20include%3A**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Subgroup%20analysis**%3A%20Estimating%20treatment%20effects%20within%20predefined%20subgroups%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Interaction%20terms**%3A%20Including%20treatment-covariate%20interactions%20in%20regression%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Causal%20trees%2Fforests**%3A%20Machine%20learning%20approaches%20that%20adaptively%20identify%20subgroups%20with%20different%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Meta-learners**%3A%20Two-stage%20approaches%20that%20separate%20the%20estimation%20of%20outcome%20and%20treatment%20effect%20models%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Discovering%20heterogeneous%20effects%20allows%20for%20personalized%20interventions%20and%20can%20reveal%20important%20insights%20about%20treatment%20mechanisms%20that%20might%20be%20masked%20when%20looking%20only%20at%20average%20effects.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20the%20combined%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bsensitivity_methods%2C%20hte_methods%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20header%20for%20the%20key%20terms%20section%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%202.7%20Key%20Terms%20in%20Causal%20Inference%20%7B%23key-terms%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20tabular%20layout%20of%20key%20causal%20inference%20terms%0A%20%20%20%20%20%20%20%20left_terms%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%7C%20Term%20%7C%20Definition%20%7C%0A%20%20%20%20%20%20%20%20%7C------%7C------------%7C%0A%20%20%20%20%20%20%20%20%7C%20**Potential%20Outcomes%20Framework**%20%7C%20The%20formal%20mathematical%20framework%20for%20causal%20inference%20where%20each%20unit%20has%20potential%20outcomes%20under%20different%20treatment%20conditions%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Average%20Treatment%20Effect%20(ATE)**%20%7C%20The%20expected%20difference%20between%20potential%20outcomes%20if%20the%20entire%20population%20received%20treatment%20versus%20control%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Average%20Treatment%20Effect%20on%20the%20Treated%20(ATT%2FATET)**%20%7C%20The%20average%20effect%20for%20those%20who%20actually%20received%20the%20treatment%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Conditional%20Average%20Treatment%20Effect%20(CATE)**%20%7C%20Treatment%20effects%20for%20specific%20subgroups%20defined%20by%20covariates%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Unconfoundedness%2FIgnorability**%20%7C%20The%20assumption%20that%20treatment%20assignment%20is%20independent%20of%20potential%20outcomes%20given%20observed%20covariates%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Positivity%2FOverlap**%20%7C%20The%20assumption%20that%20every%20unit%20has%20a%20non-zero%20probability%20of%20receiving%20each%20treatment%20condition%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Stable%20Unit%20Treatment%20Value%20Assumption%20(SUTVA)**%20%7C%20The%20assumption%20that%20one%20unit's%20treatment%20doesn't%20affect%20another%20unit's%20outcome%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Instrumental%20Variables**%20%7C%20Variables%20that%20affect%20treatment%20assignment%20but%20not%20outcomes%20directly%20%7C%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20right_terms%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%7C%20Term%20%7C%20Definition%20%7C%0A%20%20%20%20%20%20%20%20%7C------%7C------------%7C%0A%20%20%20%20%20%20%20%20%7C%20**Mediation%20Analysis**%20%7C%20The%20study%20of%20how%20treatments%20affect%20outcomes%20through%20intermediate%20variables%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Heterogeneous%20Treatment%20Effects**%20%7C%20Variation%20in%20treatment%20effects%20across%20different%20subpopulations%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Doubly%20Robust%20Estimation**%20%7C%20Methods%20that%20remain%20consistent%20if%20either%20the%20outcome%20model%20or%20the%20treatment%20assignment%20model%20is%20correctly%20specified%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Selection%20Bias**%20%7C%20Bias%20arising%20when%20treatment%20groups%20differ%20systematically%20in%20ways%20that%20affect%20outcomes%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Confounding%20Bias**%20%7C%20Bias%20due%20to%20variables%20that%20affect%20both%20treatment%20assignment%20and%20outcomes%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Common%20Support%2FOverlap%20Region**%20%7C%20The%20range%20of%20propensity%20scores%20where%20both%20treated%20and%20control%20units%20exist%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**G-methods**%20%7C%20A%20class%20of%20causal%20inference%20methods%20for%20time-varying%20treatments%20(g-formula%2C%20marginal%20structural%20models)%20%7C%0A%20%20%20%20%20%20%20%20%7C%20**Causal%20Diagram%2FDAG**%20%7C%20Directed%20acyclic%20graphs%20that%20visually%20represent%20causal%20relationships%20between%20variables%20%7C%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20note%20about%20the%20importance%20of%20terminology%0A%20%20%20%20%20%20%20%20note%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Understanding%20these%20terms%20is%20crucial%20for%20effectively%20applying%20causal%20inference%20methods%20and%20correctly%20interpreting%20results.%20Many%20of%20these%20concepts%20are%20interrelated%20and%20build%20upon%20each%20other%20to%20form%20the%20foundation%20of%20causal%20reasoning%20from%20observational%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20the%20combined%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bheader%2C%20mo.hstack(%5Bleft_terms%2C%20right_terms%5D)%2C%20note%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%203.%20The%20IHDP%20Dataset%20%7B%23ihdp-intro%7D%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%203.1%20Overview%20of%20the%20IHDP%20Dataset%0A%0A%20%20%20%20%20%20%20%20The%20Infant%20Health%20and%20Development%20Program%20(IHDP)%20was%20conducted%20from%201985%20to%201988%20and%20was%20designed%20to%20evaluate%20the%20effect%20of%20educational%20and%20family%20support%20services%20along%20with%20pediatric%20follow-up%20on%20the%20development%20of%20low%20birth%20weight%20infants.%0A%0A%20%20%20%20%20%20%20%20The%20intervention%20consisted%20of%3A%0A%20%20%20%20%20%20%20%20-%20Home%20visits%20by%20specialists%0A%20%20%20%20%20%20%20%20-%20Child%20development%20center%20attendance%0A%20%20%20%20%20%20%20%20-%20Parent%20group%20meetings%0A%0A%20%20%20%20%20%20%20%20For%20causal%20inference%20studies%2C%20the%20dataset%20has%20been%20modified%20by%20Jennifer%20Hill%20(2011)%20to%20create%20a%20semi-synthetic%20version%20where%3A%0A%20%20%20%20%20%20%20%20-%20Some%20participants%20from%20the%20treatment%20group%20were%20removed%20to%20create%20selection%20bias%0A%20%20%20%20%20%20%20%20-%20The%20outcomes%20were%20simulated%20while%20preserving%20the%20relationships%20with%20covariates%0A%0A%20%20%20%20%20%20%20%20This%20modification%20allows%20researchers%20to%20know%20the%20%22ground%20truth%22%20causal%20effects%2C%20making%20it%20an%20ideal%20benchmark%20dataset%20for%20causal%20inference%20methods.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.callout(%22%22%22%0A%20%20%20%20Dataset%20Context%3A%20The%20Infant%20Health%20and%20Development%20Program%20was%20a%20randomized%20controlled%20intervention%20designed%20to%20evaluate%20the%20effect%20of%20home%20visits%20by%20specialists%20on%20the%20cognitive%20development%20of%20premature%20infants.%22%22%22%2C%20kind%3D%22info%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(pd)%3A%0A%20%20%20%20from%20sklearn.model_selection%20import%20train_test_split%0A%20%20%20%20import%20urllib.request%0A%20%20%20%20import%20os%0A%0A%20%20%20%20%23%20Function%20to%20download%20and%20load%20the%20IHDP%20dataset%0A%20%20%20%20def%20load_ihdp_data()%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Load%20the%20IHDP%20dataset%20for%20causal%20inference%0A%0A%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20DataFrame%20with%20treatment%2C%20outcome%2C%20and%20covariates%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20directory%20for%20the%20data%20if%20it%20doesn't%20exist%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20not%20os.path.exists('data')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20os.makedirs('data')%0A%0A%20%20%20%20%20%20%20%20%23%20Download%20the%20data%20if%20it%20doesn't%20exist%0A%20%20%20%20%20%20%20%20if%20not%20os.path.exists('data%2Fihdp_npci_1.csv')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22Downloading%20IHDP%20dataset...%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20url%20%3D%20%22https%3A%2F%2Fraw.githubusercontent.com%2FAMLab-Amsterdam%2FCEVAE%2Fmaster%2Fdatasets%2FIHDP%2Fcsv%2Fihdp_npci_1.csv%22%0A%20%20%20%20%20%20%20%20%20%20%20%20urllib.request.urlretrieve(url%2C%20'data%2Fihdp_npci_1.csv')%0A%0A%20%20%20%20%20%20%20%20%23%20Load%20the%20data%0A%20%20%20%20%20%20%20%20data%20%3D%20pd.read_csv('data%2Fihdp_npci_1.csv')%0A%0A%20%20%20%20%20%20%20%20%23%20Rename%20columns%20for%20clarity%0A%20%20%20%20%20%20%20%20column_names%20%3D%20%5B'treatment'%5D%0A%20%20%20%20%20%20%20%20column_names.extend(%5Bf'y_%7Bi%7D'%20for%20i%20in%20range(2)%5D)%20%20%23%20factual%20and%20counterfactual%20outcomes%0A%20%20%20%20%20%20%20%20column_names.extend(%5Bf'mu_%7Bi%7D'%20for%20i%20in%20range(2)%5D)%20%20%23%20expected%20outcomes%20without%20noise%0A%20%20%20%20%20%20%20%20column_names.extend(%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(25)%5D)%20%20%23%20covariates%0A%0A%20%20%20%20%20%20%20%20data.columns%20%3D%20column_names%0A%0A%20%20%20%20%20%20%20%20%23%20Rename%20for%20more%20intuitive%20understanding%0A%20%20%20%20%20%20%20%20data.rename(columns%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'y_0'%3A%20'y_factual'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'y_1'%3A%20'y_cfactual'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'mu_0'%3A%20'mu_0'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'mu_1'%3A%20'mu_1'%0A%20%20%20%20%20%20%20%20%7D%2C%20inplace%3DTrue)%0A%0A%20%20%20%20%20%20%20%20return%20data%0A%0A%20%20%20%20%23%20Load%20the%20IHDP%20dataset%0A%20%20%20%20ihdp_data%20%3D%20load_ihdp_data()%0A%20%20%20%20return%20ihdp_data%2C%20load_ihdp_data%2C%20os%2C%20train_test_split%2C%20urllib%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%204.%20Exploratory%20Data%20Analysis%20%7B%23eda%7D%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.1%20IHDP%20Dataset%20Preview%20%7B%23overview%7D%22)%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(ihdp_data.head())%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2Cm2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.2%20Dataset%20Information%22)%0A%20%20%20%20%20%20%20%20info_md%20%3D%20f%22%22%22%0A%20%20%20%20%20%20%20%20-%20**Number%20of%20samples%3A**%20%7Bihdp_data.shape%5B0%5D%7D%0A%20%20%20%20%20%20%20%20-%20**Number%20of%20variables%3A**%20%7Bihdp_data.shape%5B1%5D%7D%0A%20%20%20%20%20%20%20%20-%20**Treatment%20assignment%20rate%3A**%20%7Bihdp_data%5B'treatment'%5D.mean()%3A.2f%7D%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20m3%20%3D%20mo.md(info_md)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2Cm3%5D))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo%2C%20pd)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.3%20Column%20Types%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20intermediate%20dataframe%0A%20%20%20%20%20%20%20%20dtype_df%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Column'%3A%20list(ihdp_data.dtypes.index)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Data%20Type'%3A%20%5Bstr(x)%20for%20x%20in%20ihdp_data.dtypes.values%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(dtype_df)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2Cm2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo%2C%20plt%2C%20sns)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.4%20Treatment%20Distribution%22)%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(8%2C%205))%0A%20%20%20%20%20%20%20%20sns.countplot(x%3D'treatment'%2C%20data%3Dihdp_data%2C%20ax%3Dax)%0A%20%20%20%20%20%20%20%20ax.set_title('Distribution%20of%20Treatment%20Assignment')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('Treatment%20(0%3DControl%2C%201%3DTreated)')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Count')%0A%20%20%20%20%20%20%20%20%23%20Use%20mo.mpl.interactive%20instead%20of%20just%20passing%20the%20figure%0A%20%20%20%20%20%20%20%20interactive_fig%20%3D%20mo.mpl.interactive(fig)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20interactive_fig%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo%2C%20plt%2C%20sns)%3A%0A%20%20%20%20%23%20Visualize%20outcome%20distributions%20by%20treatment%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.5%20Outcome%20Distributions%20by%20Treatment%22)%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20sns.boxplot(x%3D'treatment'%2C%20y%3D'y_factual'%2C%20data%3Dihdp_data%2C%20ax%3Dax)%0A%20%20%20%20%20%20%20%20ax.set_title('Factual%20Outcome%20Distribution%20by%20Treatment%20Group')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('Treatment%20(0%3DControl%2C%201%3DTreated)')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Outcome')%0A%20%20%20%20%20%20%20%20%23%20Convert%20to%20interactive%20plot%0A%20%20%20%20%20%20%20%20interactive_fig%20%3D%20mo.mpl.interactive(fig)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20interactive_fig%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.6%20Summary%20Statistics%22)%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(ihdp_data.describe())%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20m2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pd)%3A%0A%20%20%20%20%23%20Define%20covariate%20descriptions%0A%20%20%20%20covariate_descriptions%20%3D%20%7B%0A%20%20%20%20%20%20%20%20'x_0'%3A%20%22Birth%20weight%22%2C%0A%20%20%20%20%20%20%20%20'x_1'%3A%20%22Birth%20order%22%2C%0A%20%20%20%20%20%20%20%20'x_2'%3A%20%22Head%20circumference%20at%20birth%22%2C%0A%20%20%20%20%20%20%20%20'x_3'%3A%20%22Mother's%20age%22%2C%0A%20%20%20%20%20%20%20%20'x_4'%3A%20%22Mother's%20education%20level%22%2C%0A%20%20%20%20%20%20%20%20'x_5'%3A%20%22Child%20is%20first%20born%22%2C%0A%20%20%20%20%20%20%20%20'x_6'%3A%20%22Child%20is%20male%22%2C%0A%20%20%20%20%20%20%20%20'x_7'%3A%20%22Twin%22%2C%0A%20%20%20%20%20%20%20%20'x_8'%3A%20%22Mother's%20race%2Fethnicity%22%2C%0A%20%20%20%20%20%20%20%20'x_9'%3A%20%22Mother%20smoked%20during%20pregnancy%22%2C%0A%20%20%20%20%20%20%20%20'x_10'%3A%20%22Mother%20drank%20alcohol%20during%20pregnancy%22%2C%0A%20%20%20%20%20%20%20%20'x_11'%3A%20%22Mother%20had%20drugs%20during%20pregnancy%22%2C%0A%20%20%20%20%20%20%20%20'x_12'%3A%20%22Neonatal%20health%20index%22%2C%0A%20%20%20%20%20%20%20%20'x_13'%3A%20%22Mother%20is%20married%22%2C%0A%20%20%20%20%20%20%20%20'x_14'%3A%20%22Mother%20worked%20during%20pregnancy%22%2C%0A%20%20%20%20%20%20%20%20'x_15'%3A%20%22Mother%20had%20prenatal%20care%22%2C%0A%20%20%20%20%20%20%20%20'x_16'%3A%20%22Mother's%20weight%20gain%20during%20pregnancy%22%2C%0A%20%20%20%20%20%20%20%20'x_17'%3A%20%22Family%20income%22%2C%0A%20%20%20%20%20%20%20%20'x_18'%3A%20%22Preterm%20birth%22%2C%0A%20%20%20%20%20%20%20%20'x_19'%3A%20%22Birth%20complications%22%2C%0A%20%20%20%20%20%20%20%20'x_20'%3A%20%22Site%201%22%2C%0A%20%20%20%20%20%20%20%20'x_21'%3A%20%22Site%202%22%2C%0A%20%20%20%20%20%20%20%20'x_22'%3A%20%22Site%203%22%2C%0A%20%20%20%20%20%20%20%20'x_23'%3A%20%22Site%204%22%2C%0A%20%20%20%20%20%20%20%20'x_24'%3A%20%22Site%205%22%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%20Create%20a%20DataFrame%20for%20UI%20display%0A%20%20%20%20covariates_df%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20'Variable'%3A%20list(covariate_descriptions.keys())%2C%0A%20%20%20%20%20%20%20%20'Description'%3A%20list(covariate_descriptions.values())%0A%20%20%20%20%7D)%0A%20%20%20%20return%20covariate_descriptions%2C%20covariates_df%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(covariates_df%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20markdown%20header%20for%20covariate%20descriptions%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.7%20Covariate%20Descriptions%20%7B%23covariates%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20covariate%20descriptions%20as%20an%20interactive%20dataframe%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(covariates_df)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20vertically%20stacked%20components%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20m2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Define%20numerical%20covariates%0A%20%20%20%20%20%20%20%20numerical_covs%20%3D%20%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(5)%5D%20%2B%20%5B'x_12'%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20markdown%20header%20for%20numerical%20statistics%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.8%20Numerical%20Covariate%20Statistics%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20summary%20statistics%20as%20an%20interactive%20dataframe%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(ihdp_data%5Bnumerical_covs%5D.describe())%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20vertically%20stacked%20components%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20m2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(covariate_descriptions%2C%20ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Define%20binary%20covariates%0A%20%20%20%20%20%20%20%20binary_covs%20%3D%20%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(5%2C%2025)%20if%20i%20!%3D%2012%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20binary%20rates%0A%20%20%20%20%20%20%20%20binary_rates%20%3D%20ihdp_data%5Bbinary_covs%5D.mean().reset_index()%0A%20%20%20%20%20%20%20%20binary_rates.columns%20%3D%20%5B'Variable'%2C%20'Rate'%5D%0A%20%20%20%20%20%20%20%20binary_rates%5B'Description'%5D%20%3D%20binary_rates%5B'Variable'%5D.map(covariate_descriptions)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20markdown%20header%20for%20binary%20rates%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.9%20Binary%20Covariate%20Rates%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20binary%20rates%20as%20an%20interactive%20dataframe%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.ui.dataframe(binary_rates)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20vertically%20stacked%20components%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20m2%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20dropdown%20for%20covariate%20selection%0A%20%20%20%20available_covs%20%3D%20%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(5)%5D%20%2B%20%5B'x_12'%5D%0A%20%20%20%20covariate_selector%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Davailable_covs%2C%0A%20%20%20%20%20%20%20%20value%3D'x_0'%2C%0A%20%20%20%20%20%20%20%20label%3D%22Select%20covariate%20to%20visualize%22%0A%20%20%20%20)%0A%20%20%20%20return%20available_covs%2C%20covariate_selector%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(covariate_descriptions%2C%20covariate_selector%2C%20ihdp_data%2C%20mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20distribution%20of%20selected%20covariate%0A%20%20%20%20%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20%20%20%20%20import%20seaborn%20as%20sns%0A%0A%20%20%20%20%20%20%20%20def%20plot_distribution(selected_cov)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20%20%20%20%20sns.histplot(ihdp_data%5Bselected_cov%5D%2C%20ax%3Dax%2C%20kde%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20desc%20%3D%20covariate_descriptions.get(selected_cov%2C%20%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(desc)%20%3E%2030%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20desc%20%3D%20desc%5B%3A30%5D%20%2B%20%22...%22%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_title(f%22%7Bselected_cov%7D%3A%20%7Bdesc%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_xlabel(selected_cov)%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_ylabel(%22Count%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20fig%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20header%20and%20layout%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%23%23%23%204.10%20Distribution%20of%20Key%20Numerical%20Covariates%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Get%20description%20for%20the%20selected%20covariate%0A%20%20%20%20%20%20%20%20selected_desc%20%3D%20mo.md(f%22**Selected%20variable**%3A%20%7Bcovariate_selector.value%7D%20-%20%7Bcovariate_descriptions.get(covariate_selector.value%2C%20'')%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20plot%20based%20on%20selected%20covariate%0A%20%20%20%20%20%20%20%20plot_fig%20%3D%20plot_distribution(covariate_selector.value)%0A%20%20%20%20%20%20%20%20interactive_plot%20%3D%20mo.mpl.interactive(plot_fig)%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20output%20with%20interactive%20components%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20m1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bcovariate_selector%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20selected_desc%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20interactive_plot%0A%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20m1%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%201.%20Strong%20positive%20correlation%20(0.85)%20between%20x0x_0%20(child's%20birth%20weight)%20and%20x1x_1%20(child's%20birth%20order).%20This%20indicates%20that%20higher%20birth%20order%20(later-born%20children)%20tends%20to%20be%20associated%20with%20higher%20birth%20weight.%0A%20%20%20%20%20%20%20%202.%20Strong%20negative%20correlation%20(-0.76%20and%20-0.7)%20between%20x2x_2%20(head%20circumference)%20and%20both%20birth%20weight%20(x0x_0)%20and%20birth%20order%20(x1x_1).%20This%20is%20somewhat%20counterintuitive%2C%20as%20we%20might%20expect%20larger%20babies%20to%20have%20larger%20head%20circumferences.%20This%20inverse%20relationship%20could%20suggest%20measurement%20issues%20or%20certain%20medical%20conditions%20in%20the%20dataset.%0A%20%20%20%20%20%20%20%203.%20Most%20demographic%20variables%20(x3x_3%20-%20mother's%20age%2C%20x4x_4%20-%20mother's%20education)%20show%20weak%20correlations%20with%20other%20variables%2C%20suggesting%20independence.%0A%20%20%20%20%20%20%20%204.%20Child's%20neonatal%20health%20index%20(x12x_12)%20has%20mostly%20weak%20correlations%20with%20other%20variables%2C%20with%20the%20strongest%20being%20a%20mild%20positive%20correlation%20(0.13)%20with%20mother's%20age.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20m2%20%3D%20mo.callout(%22For%20causal%20inference%2C%20these%20correlations%20are%20important%20because%20strongly%20correlated%20variables%20can%20create%20confounding%20issues.%20For%20example%2C%20if%20treatment%20assignment%20is%20related%20to%20birth%20weight%2C%20birth%20order%20might%20inadvertently%20become%20a%20confounder%20due%20to%20its%20strong%20correlation%20with%20birth%20weight.%22%2C%20kind%3D%22info%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bm1%2C%20m2%5D))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%205.%20Setting%20Up%20for%20Causal%20Analysis%20%7B%23analysis-setup%7D%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%205.1%20Data%20Preparation%20%7B%23data-prep%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%94%A7%20**Step%201**%3A%20Properly%20prepare%20the%20data%20for%20causal%20analysis%0A%0A%20%20%20%20%20%20%20%20Before%20implementing%20causal%20inference%20methods%2C%20we%20need%20to%20prepare%20our%20data%20appropriately.%20This%20includes%3A%0A%0A%20%20%20%20%20%20%20%201.%20Splitting%20the%20data%20into%20training%20and%20test%20sets%0A%20%20%20%20%20%20%20%202.%20Scaling%20continuous%20features%0A%20%20%20%20%20%20%20%203.%20Identifying%20the%20types%20of%20variables%20(continuous%20vs.%20binary)%0A%20%20%20%20%20%20%20%204.%20Handling%20any%20missing%20values%20(if%20present)%0A%0A%20%20%20%20%20%20%20%20This%20preparation%20ensures%20that%20our%20causal%20inference%20methods%20will%20work%20properly%20and%20produce%20reliable%20estimates.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(ihdp_data%2C%20mo%2C%20pd%2C%20plt%2C%20sns%2C%20train_test_split)%3A%0A%20%20%20%20%23%20Identify%20continuous%20and%20binary%20variables%0A%20%20%20%20continuous_vars%20%3D%20%5B'x_0'%2C%20'x_1'%2C%20'x_2'%2C%20'x_3'%2C%20'x_4'%2C%20'x_12'%5D%0A%20%20%20%20binary_vars%20%3D%20%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(5%2C%2025)%20if%20i%20!%3D%2012%5D%0A%0A%20%20%20%20%23%20Check%20for%20missing%20values%0A%20%20%20%20missing_values%20%3D%20ihdp_data.isnull().sum()%0A%20%20%20%20print(f%22Missing%20values%20in%20dataset%3A%20%7Bmissing_values.sum()%7D%22)%0A%0A%20%20%20%20%23%20Split%20the%20data%20into%20features%2C%20treatment%2C%20and%20outcomes%0A%20%20%20%20X%20%3D%20ihdp_data%5B%5Bf'x_%7Bi%7D'%20for%20i%20in%20range(25)%5D%5D%0A%20%20%20%20T%20%3D%20ihdp_data%5B'treatment'%5D%0A%20%20%20%20Y%20%3D%20ihdp_data%5B'y_factual'%5D%0A%0A%20%20%20%20%23%20Also%20track%20true%20potential%20outcomes%20for%20evaluation%20(not%20available%20in%20real-world%20scenarios)%0A%20%20%20%20Y0%20%3D%20ihdp_data%5B'mu_0'%5D%0A%20%20%20%20Y1%20%3D%20ihdp_data%5B'mu_1'%5D%0A%0A%20%20%20%20%23%20Split%20into%20training%20and%20test%20sets%20(80%2F20%20split)%0A%20%20%20%20X_train%2C%20X_test%2C%20T_train%2C%20T_test%2C%20Y_train%2C%20Y_test%2C%20Y0_train%2C%20Y0_test%2C%20Y1_train%2C%20Y1_test%20%3D%20train_test_split(%0A%20%20%20%20%20%20%20%20X%2C%20T%2C%20Y%2C%20Y0%2C%20Y1%2C%20test_size%3D0.2%2C%20random_state%3D42%0A%20%20%20%20)%0A%20%20%20%20from%20sklearn.preprocessing%20import%20StandardScaler%0A%0A%20%20%20%20scaler%20%3D%20StandardScaler()%0A%20%20%20%20X_train_scaled%20%3D%20X_train.copy()%0A%20%20%20%20X_test_scaled%20%3D%20X_test.copy()%0A%0A%20%20%20%20for%20var%20in%20continuous_vars%3A%0A%20%20%20%20%20%20%20%20X_train_scaled%5Bvar%5D%20%3D%20scaler.fit_transform(X_train%5B%5Bvar%5D%5D)%0A%20%20%20%20%20%20%20%20X_test_scaled%5Bvar%5D%20%3D%20scaler.transform(X_test%5B%5Bvar%5D%5D)%0A%0A%20%20%20%20%23%20Print%20information%20about%20the%20split%0A%20%20%20%20print(f%22Training%20set%3A%20%7BX_train.shape%5B0%5D%7D%20samples%22)%0A%20%20%20%20print(f%22Test%20set%3A%20%7BX_test.shape%5B0%5D%7D%20samples%22)%0A%20%20%20%20print(f%22Treatment%20rate%20in%20training%20set%3A%20%7BT_train.mean()%3A.2f%7D%22)%0A%20%20%20%20print(f%22Treatment%20rate%20in%20test%20set%3A%20%7BT_test.mean()%3A.2f%7D%22)%0A%20%20%20%20print(f%22True%20ATE%20in%20training%20set%3A%20%7B(Y1_train%20-%20Y0_train).mean()%3A.4f%7D%22)%0A%20%20%20%20print(f%22True%20ATE%20in%20test%20set%3A%20%7B(Y1_test%20-%20Y0_test).mean()%3A.4f%7D%22)%0A%0A%0A%20%20%20%20%23%20Set%20plotting%20style%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20plt.style.use('seaborn-v0_8-whitegrid')%0A%20%20%20%20%20%20%20%20sns.set_context(%22notebook%22%2C%20font_scale%3D1.2)%20%20%20%20%0A%0A%20%20%20%20%20%20%20%20%23%20Scale%20continuous%20features%0A%20%20%20%20%20%20%20%20%23%20Visualize%20the%20data%20split%20and%20scaling%20effects%0A%20%20%20%20%20%20%20%20fig%2C%20axes%20%3D%20plt.subplots(1%2C%202%2C%20figsize%3D(10%2C%205))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%201%3A%20Training%20vs%20Test%20split%20by%20treatment%0A%20%20%20%20%20%20%20%20train_counts%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Set'%3A%20%5B'Training'%5D%20*%202%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Treatment'%3A%20%5B'Control'%2C%20'Treated'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Count'%3A%20%5B(T_train%20%3D%3D%200).sum()%2C%20(T_train%20%3D%3D%201).sum()%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20test_counts%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Set'%3A%20%5B'Test'%5D%20*%202%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Treatment'%3A%20%5B'Control'%2C%20'Treated'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Count'%3A%20%5B(T_test%20%3D%3D%200).sum()%2C%20(T_test%20%3D%3D%201).sum()%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20counts_df%20%3D%20pd.concat(%5Btrain_counts%2C%20test_counts%5D)%0A%0A%20%20%20%20%20%20%20%20sns.barplot(x%3D'Set'%2C%20y%3D'Count'%2C%20hue%3D'Treatment'%2C%20data%3Dcounts_df%2C%20ax%3Daxes%5B0%5D)%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_title('Sample%20Distribution%20in%20Training%20and%20Test%20Sets')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_ylabel('Number%20of%20Samples')%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%202%3A%20Effect%20of%20scaling%20on%20a%20continuous%20variable%0A%20%20%20%20%20%20%20%20sns.histplot(X_train%5B'x_0'%5D%2C%20kde%3DTrue%2C%20label%3D'Before%20scaling'%2C%20ax%3Daxes%5B1%5D%2C%20alpha%3D0.5)%0A%20%20%20%20%20%20%20%20sns.histplot(X_train_scaled%5B'x_0'%5D%2C%20kde%3DTrue%2C%20label%3D'After%20scaling'%2C%20ax%3Daxes%5B1%5D%2C%20alpha%3D0.5)%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_title('Effect%20of%20Scaling%20on%20Birth%20Weight%20(x_0)')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_xlabel('Value')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.legend()%0A%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Replace%20plt.show()%20with%20mo.mpl.interactive%20for%20interactivity%0A%20%20%20%20%20%20%20%20return%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20_()%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20StandardScaler%2C%0A%20%20%20%20%20%20%20%20T%2C%0A%20%20%20%20%20%20%20%20T_test%2C%0A%20%20%20%20%20%20%20%20T_train%2C%0A%20%20%20%20%20%20%20%20X%2C%0A%20%20%20%20%20%20%20%20X_test%2C%0A%20%20%20%20%20%20%20%20X_test_scaled%2C%0A%20%20%20%20%20%20%20%20X_train%2C%0A%20%20%20%20%20%20%20%20X_train_scaled%2C%0A%20%20%20%20%20%20%20%20Y%2C%0A%20%20%20%20%20%20%20%20Y0%2C%0A%20%20%20%20%20%20%20%20Y0_test%2C%0A%20%20%20%20%20%20%20%20Y0_train%2C%0A%20%20%20%20%20%20%20%20Y1%2C%0A%20%20%20%20%20%20%20%20Y1_test%2C%0A%20%20%20%20%20%20%20%20Y1_train%2C%0A%20%20%20%20%20%20%20%20Y_test%2C%0A%20%20%20%20%20%20%20%20Y_train%2C%0A%20%20%20%20%20%20%20%20binary_vars%2C%0A%20%20%20%20%20%20%20%20continuous_vars%2C%0A%20%20%20%20%20%20%20%20missing_values%2C%0A%20%20%20%20%20%20%20%20scaler%2C%0A%20%20%20%20%20%20%20%20var%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20analysis_md%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20**Analysis%20of%20Data%20Preparation%3A**%0A%0A%20%20%20%20%20%20%20%20The%20dataset%20preparation%20above%20accomplishes%20several%20important%20steps%20for%20causal%20inference%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Splitting%20the%20data**%20into%20training%20(80%25)%20and%20test%20(20%25)%20sets%20allows%20us%20to%20evaluate%20the%20performance%20of%20our%20causal%20inference%20methods%20on%20unseen%20data%2C%20which%20is%20crucial%20for%20assessing%20their%20generalizability.%0A%0A%20%20%20%20%20%20%20%202.%20**Standardizing%20continuous%20variables**%20ensures%20that%20variables%20with%20different%20scales%20don't%20unduly%20influence%20our%20models.%20This%20is%20particularly%20important%20for%20methods%20that%20are%20sensitive%20to%20the%20scale%20of%20the%20input%20features%2C%20such%20as%20matching%20based%20on%20distances%20or%20regularized%20regression.%0A%0A%20%20%20%20%20%20%20%203.%20**Preserving%20the%20treatment%20assignment%20rate**%20across%20training%20and%20test%20sets%20maintains%20the%20same%20level%20of%20class%20imbalance%2C%20which%20is%20important%20for%20methods%20that%20are%20sensitive%20to%20treatment%20prevalence.%0A%0A%20%20%20%20%20%20%20%204.%20**Verifying%20the%20absence%20of%20missing%20values**%20confirms%20that%20we%20don't%20need%20to%20implement%20imputation%20strategies%2C%20which%20could%20introduce%20additional%20complexity%20and%20potential%20bias.%0A%0A%20%20%20%20%20%20%20%20The%20visualization%20on%20the%20left%20shows%20the%20distribution%20of%20treated%20and%20control%20units%20in%20both%20training%20and%20test%20sets%2C%20confirming%20that%20the%20treatment%20assignment%20rate%20is%20similar%20between%20the%20splits.%20The%20visualization%20on%20the%20right%20illustrates%20the%20effect%20of%20standardization%20on%20the%20birth%20weight%20variable%2C%20transforming%20it%20to%20have%20zero%20mean%20and%20unit%20variance%2C%20which%20makes%20it%20more%20suitable%20for%20many%20statistical%20and%20machine%20learning%20methods.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20mo.callout(analysis_md%2C%20kind%3D%22info%22)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%205.2%20Formulating%20the%20Causal%20Question%20%7B%23causal-question%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%93%8B%20**Step%202**%3A%20Define%20what%20causal%20effect%20you%20want%20to%20estimate%0A%0A%20%20%20%20%20%20%20%20Causal%20inference%20begins%20with%20a%20clear%20formulation%20of%20the%20causal%20question.%20For%20the%20IHDP%20dataset%2C%20our%20primary%20question%20is%3A%0A%0A%20%20%20%20%20%20%20%20**%22What%20is%20the%20effect%20of%20specialist%20home%20visits%20(treatment)%20on%20the%20cognitive%20test%20scores%20(outcome)%20of%20premature%20infants%3F%22**%0A%0A%20%20%20%20%20%20%20%20To%20formalize%20this%20question%2C%20we%20need%20to%20define%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Treatment%20variable%20(T)**%3A%20Binary%20indicator%20for%20receiving%20home%20visits%0A%20%20%20%20%20%20%20%202.%20**Outcome%20variable%20(Y)**%3A%20Cognitive%20test%20scores%0A%20%20%20%20%20%20%20%203.%20**Covariates%20(X)**%3A%20Baseline%20characteristics%20that%20may%20influence%20treatment%20assignment%20or%20outcomes%0A%20%20%20%20%20%20%20%204.%20**Target%20population**%3A%20Premature%20infants%20with%20low%20birth%20weight%0A%20%20%20%20%20%20%20%205.%20**Causal%20estimand**%3A%20The%20specific%20causal%20quantity%20we%20want%20to%20estimate%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20mo%2C%20pd%2C%20plt)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Define%20the%20causal%20question%20components%0A%20%20%20%20%20%20%20%20treatment_var%20%3D%20'Treatment%20(IHDP%20intervention)'%0A%20%20%20%20%20%20%20%20outcome_var%20%3D%20'Cognitive%20test%20scores'%0A%20%20%20%20%20%20%20%20covariates_var%20%3D%20'Baseline%20characteristics%20(25%20variables)'%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20true%20causal%20effects%20(available%20in%20this%20simulated%20dataset)%0A%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20naive%20estimate%0A%20%20%20%20%20%20%20%20naive_ate%20%3D%20Y_train%5BT_train%20%3D%3D%201%5D.mean()%20-%20Y_train%5BT_train%20%3D%3D%200%5D.mean()%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20true%20ATT%20(Average%20Treatment%20Effect%20on%20the%20Treated)%0A%20%20%20%20%20%20%20%20true_att%20%3D%20(Y1_train%5BT_train%20%3D%3D%201%5D%20-%20Y0_train%5BT_train%20%3D%3D%201%5D).mean()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20DataFrame%20for%20visualization%0A%20%20%20%20%20%20%20%20estimands_df%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Estimand'%3A%20%5B'ATE%20(Average%20Treatment%20Effect)'%2C%20'ATT%20(Average%20Treatment%20Effect%20on%20Treated)'%2C%20'Naive%20Difference%20in%20Means'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Value'%3A%20%5Btrue_ate%2C%20true_att%2C%20naive_ate%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Description'%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Expected%20effect%20if%20everyone%20received%20treatment%20vs.%20none'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Average%20effect%20among%20those%20who%20actually%20received%20treatment'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Simple%20difference%20in%20mean%20outcomes%20(biased%20estimate)'%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20causal%20estimands%0A%20%20%20%20%20%20%20%20plt.figure(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20bars%20%3D%20plt.barh(estimands_df%5B'Estimand'%5D%2C%20estimands_df%5B'Value'%5D%2C%20color%3D%5B'skyblue'%2C%20'lightgreen'%2C%20'salmon'%5D)%0A%20%20%20%20%20%20%20%20plt.title('Causal%20Estimands%20in%20the%20IHDP%20Dataset')%0A%20%20%20%20%20%20%20%20plt.xlabel('Effect%20Size')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20value%20labels%20to%20the%20bars%0A%20%20%20%20%20%20%20%20for%20i%2C%20bar%20in%20enumerate(bars)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20plt.text(bar.get_width()%20%2B%200.1%2C%20bar.get_y()%20%2B%20bar.get_height()%2F2%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%7Bestimands_df%5B%22Value%22%5D.iloc%5Bi%5D%3A.4f%7D'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20va%3D'center')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20grid%20lines%20for%20readability%0A%20%20%20%20%20%20%20%20plt.grid(axis%3D'x'%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20table%20of%20key%20causal%20components%0A%20%20%20%20%20%20%20%20causal_components%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Component'%3A%20%5B'Treatment%20Variable'%2C%20'Outcome%20Variable'%2C%20'Covariates'%2C%20'Target%20Population'%2C%20'Primary%20Causal%20Estimand'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Definition'%3A%20%5Btreatment_var%2C%20outcome_var%2C%20covariates_var%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Premature%20infants%20with%20low%20birth%20weight'%2C%20'Average%20Treatment%20Effect%20(ATE)'%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20the%20interactive%20output%0A%20%20%20%20%20%20%20%20causal_question_layout%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Causal%20Components%20in%20the%20IHDP%20Study%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(causal_components)%2C%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Comparison%20of%20Causal%20Estimands%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.mpl.interactive(plt.gcf())%2C%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22**Note%3A**%20In%20real-world%20causal%20inference%2C%20we%20typically%20don't%20know%20the%20true%20causal%20effects.%20%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20IHDP%20dataset%20is%20semi-synthetic%2C%20allowing%20us%20to%20know%20the%20ground%20truth%20for%20evaluation.%22%22%22)%0A%20%20%20%20%20%20%20%20%5D)%0A%20%20%20%20%20%20%20%20mo.output.append(causal_question_layout)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20analysis_md%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20**Analysis%20of%20the%20Causal%20Question%20Formulation%3A**%0A%0A%20%20%20%20%20%20%20%20The%20causal%20question%20has%20been%20clearly%20formulated%2C%20which%20is%20a%20crucial%20first%20step%20in%20any%20causal%20inference%20analysis.%20Key%20observations%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Treatment-Outcome%20Relationship**%3A%20We're%20interested%20in%20the%20effect%20of%20the%20IHDP%20intervention%20(home%20visits)%20on%20cognitive%20test%20scores%2C%20a%20well-defined%20relationship%20that%20aligns%20with%20policy%20and%20educational%20interventions.%0A%0A%20%20%20%20%20%20%20%202.%20**Causal%20Estimands**%3A%20We've%20defined%20multiple%20estimands%20of%20interest%2C%20with%20the%20Average%20Treatment%20Effect%20(ATE)%20as%20our%20primary%20focus.%20The%20ATE%20represents%20the%20expected%20change%20in%20cognitive%20scores%20if%20the%20entire%20population%20received%20the%20treatment%20versus%20if%20none%20did.%0A%0A%20%20%20%20%20%20%20%203.%20**ATT%20vs%20ATE**%3A%20The%20Average%20Treatment%20Effect%20on%20the%20Treated%20(ATT)%20is%20very%20close%20to%20the%20ATE%20in%20this%20dataset%20(difference%20of%20only%200.0041).%20This%20suggests%20that%20the%20treatment%20effect%20is%20relatively%20homogeneous%20across%20the%20population%2C%20or%20that%20selection%20into%20treatment%20wasn't%20strongly%20related%20to%20treatment%20effect%20heterogeneity.%0A%0A%20%20%20%20%20%20%20%204.%20**Naive%20Estimate**%3A%20The%20naive%20difference%20in%20means%20is%20similar%20to%20the%20true%20ATE%20in%20this%20dataset.%20This%20is%20somewhat%20unexpected%2C%20as%20we%20would%20typically%20expect%20selection%20bias%20to%20create%20a%20difference%20between%20the%20naive%20estimate%20and%20the%20true%20causal%20effect.%20This%20similarity%20could%20be%20a%20characteristic%20of%20how%20the%20semi-synthetic%20dataset%20was%20generated.%0A%0A%20%20%20%20%20%20%20%20Formulating%20these%20specific%20causal%20questions%20allows%20us%20to%20select%20appropriate%20methods%20for%20estimation%20and%20evaluate%20their%20performance%20against%20known%20ground%20truth%20values%20in%20this%20unique%20dataset.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20mo.output.append(mo.callout(analysis_md%2C%20kind%3D%22info%22))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%205.3%20Propensity%20Score%20Analysis%20%7B%23propensity-analysis%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%8F%88%20**Step%203**%3A%20Analyze%20propensity%20scores%20to%20check%20assumptions%20and%20prepare%20for%20causal%20methods%0A%0A%20%20%20%20%20%20%20%20Propensity%20scores%20are%20a%20key%20concept%20in%20causal%20inference%2C%20representing%20the%20probability%20of%20receiving%20treatment%20given%20observed%20covariates.%20They're%20useful%20for%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Assessing%20overlap**%3A%20Checking%20the%20positivity%20assumption%20by%20examining%20the%20distribution%20of%20propensity%20scores%0A%20%20%20%20%20%20%20%202.%20**Creating%20balance**%3A%20Helping%20ensure%20that%20treated%20and%20control%20groups%20are%20comparable%0A%20%20%20%20%20%20%20%203.%20**Estimation**%3A%20Using%20in%20various%20estimation%20methods%20like%20inverse%20probability%20weighting%2C%20matching%2C%20and%20stratification%0A%0A%20%20%20%20%20%20%20%20Let's%20estimate%20propensity%20scores%20for%20our%20dataset%20and%20analyze%20their%20properties.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.callout(mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20What%20are%20Propensity%20Scores%3F%0A%0A%20%20%20%20%20%20%20%20Propensity%20scores%20represent%20the%20probability%20that%20a%20unit%20receives%20the%20treatment%2C%20conditional%20on%20observed%20covariates.%20Mathematically%2C%20the%20propensity%20score%20is%20defined%20as%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20e(X)%20%3D%20P(T%3D1%7CX)%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20Where%20%5C(T%5C)%20is%20the%20treatment%20indicator%20and%20%5C(X%5C)%20represents%20the%20covariates.%0A%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Why%20Are%20Propensity%20Scores%20Important%3F%0A%0A%20%20%20%20%20%20%20%20Propensity%20scores%20help%20address%20the%20fundamental%20challenge%20in%20causal%20inference%3A%20units%20are%20either%20treated%20or%20untreated%2C%20never%20both.%20By%20conditioning%20on%20the%20propensity%20score%2C%20we%20can%20create%20balance%20between%20treated%20and%20control%20groups%2C%20mimicking%20a%20randomized%20experiment.%0A%0A%20%20%20%20%20%20%20%20Key%20properties%20of%20propensity%20scores%20include%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Balancing%20score**%3A%20Conditioning%20on%20the%20propensity%20score%20balances%20the%20distribution%20of%20covariates%20between%20treatment%20groups%0A%20%20%20%20%20%20%20%202.%20**Dimensionality%20reduction**%3A%20Reduces%20multiple%20covariates%20to%20a%20single%20score%0A%20%20%20%20%20%20%20%203.%20**Identification%20of%20areas%20of%20common%20support**%3A%20Helps%20identify%20regions%20where%20causal%20inference%20is%20reliable%0A%0A%20%20%20%20%20%20%20%20We'll%20estimate%20propensity%20scores%20using%20logistic%20regression%20and%20also%20explore%20a%20machine%20learning%20approach%20with%20random%20forests.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20))%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo%2C%20plt%2C%20ps_df%2C%20sns)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20figure%20for%20propensity%20score%20distributions%0A%20%20%20%20%20%20%20%20fig%2C%20axes%20%3D%20plt.subplots(1%2C%202%2C%20figsize%3D(14%2C%206))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%201%3A%20Logistic%20regression%20propensity%20score%20distributions%0A%20%20%20%20%20%20%20%20sns.histplot(%0A%20%20%20%20%20%20%20%20%20%20%20%20data%3Dps_df%2C%20x%3D'ps_logistic'%2C%20hue%3D'treatment'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20bins%3D30%2C%20element%3D%22step%22%2C%20common_norm%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20ax%3Daxes%5B0%5D%2C%20alpha%3D0.7%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_title('Propensity%20Score%20Distribution%20(Logistic%20Regression)')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_xlabel('Propensity%20Score')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_ylabel('Count')%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%202%3A%20Random%20forest%20propensity%20score%20distributions%0A%20%20%20%20%20%20%20%20sns.histplot(%0A%20%20%20%20%20%20%20%20%20%20%20%20data%3Dps_df%2C%20x%3D'ps_rf'%2C%20hue%3D'treatment'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20bins%3D30%2C%20element%3D%22step%22%2C%20common_norm%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20ax%3Daxes%5B1%5D%2C%20alpha%3D0.7%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_title('Propensity%20Score%20Distribution%20(Random%20Forest)')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_xlabel('Propensity%20Score')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_ylabel('Count')%0A%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Return%20the%20interactive%20plot%0A%20%20%20%20%20%20%20%20plot%20%3D%20mo.mpl.interactive(fig)%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Propensity%20Score%20Distributions%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bheader%2C%20plot%5D))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20mo%2C%20pd%2C%20propensity_scores%2C%20rf_propensity_scores)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Check%20for%20overlap%2Fpositivity%20assumption%0A%20%20%20%20%20%20%20%20%23%20Calculate%20min%20and%20max%20propensity%20scores%20for%20treated%20and%20control%20groups%0A%20%20%20%20%20%20%20%20ps_stats%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Model'%3A%20%5B'Logistic%20Regression'%2C%20'Random%20Forest'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Min%20(Treated)'%3A%20%5Bpropensity_scores%5BT_train%20%3D%3D%201%5D.min()%2C%20rf_propensity_scores%5BT_train%20%3D%3D%201%5D.min()%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Max%20(Treated)'%3A%20%5Bpropensity_scores%5BT_train%20%3D%3D%201%5D.max()%2C%20rf_propensity_scores%5BT_train%20%3D%3D%201%5D.max()%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Min%20(Control)'%3A%20%5Bpropensity_scores%5BT_train%20%3D%3D%200%5D.min()%2C%20rf_propensity_scores%5BT_train%20%3D%3D%200%5D.min()%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Max%20(Control)'%3A%20%5Bpropensity_scores%5BT_train%20%3D%3D%200%5D.max()%2C%20rf_propensity_scores%5BT_train%20%3D%3D%200%5D.max()%5D%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20common%20support%20region%0A%20%20%20%20%20%20%20%20ps_stats%5B'Common%20Support%20Min'%5D%20%3D%20ps_stats%5B%5B'Min%20(Treated)'%2C%20'Min%20(Control)'%5D%5D.max(axis%3D1)%0A%20%20%20%20%20%20%20%20ps_stats%5B'Common%20Support%20Max'%5D%20%3D%20ps_stats%5B%5B'Max%20(Treated)'%2C%20'Max%20(Control)'%5D%5D.min(axis%3D1)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20percentage%20of%20units%20in%20common%20support%0A%20%20%20%20%20%20%20%20in_support_logistic%20%3D%20((propensity_scores%20%3E%3D%20ps_stats.loc%5B0%2C%20'Common%20Support%20Min'%5D)%20%26%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(propensity_scores%20%3C%3D%20ps_stats.loc%5B0%2C%20'Common%20Support%20Max'%5D)).mean()%20*%20100%0A%20%20%20%20%20%20%20%20in_support_rf%20%3D%20((rf_propensity_scores%20%3E%3D%20ps_stats.loc%5B1%2C%20'Common%20Support%20Min'%5D)%20%26%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(rf_propensity_scores%20%3C%3D%20ps_stats.loc%5B1%2C%20'Common%20Support%20Max'%5D)).mean()%20*%20100%0A%0A%20%20%20%20%20%20%20%20ps_stats%5B'Units%20in%20Common%20Support%20(%25)'%5D%20%3D%20%5Bin_support_logistic%2C%20in_support_rf%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Count%20extreme%20propensity%20scores%20(%3C%200.1%20or%20%3E%200.9)%0A%20%20%20%20%20%20%20%20extreme_ps_logistic%20%3D%20((propensity_scores%20%3C%200.1)%20%7C%20(propensity_scores%20%3E%200.9)).mean()%20*%20100%0A%20%20%20%20%20%20%20%20extreme_ps_rf%20%3D%20((rf_propensity_scores%20%3C%200.1)%20%7C%20(rf_propensity_scores%20%3E%200.9)).mean()%20*%20100%0A%0A%20%20%20%20%20%20%20%20ps_stats%5B'Extreme%20PS%20(%25)'%5D%20%3D%20%5Bextreme_ps_logistic%2C%20extreme_ps_rf%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20markdown%20output%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Overlap%20and%20Common%20Support%20Analysis%22)%0A%0A%20%20%20%20%20%20%20%20explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20To%20satisfy%20the%20positivity%20assumption%20for%20causal%20inference%2C%20we%20need%20sufficient%20overlap%20in%20propensity%20scores%20between%20treated%20and%20control%20groups.%20A%20good%20overlap%20indicates%20that%20units%20with%20similar%20characteristics%20have%20a%20chance%20of%20being%20in%20either%20treatment%20group.%0A%0A%20%20%20%20%20%20%20%20The%20**common%20support%20region**%20is%20the%20range%20of%20propensity%20scores%20where%20both%20treated%20and%20control%20units%20exist.%20Ideally%2C%20we%20want%20most%20units%20to%20fall%20within%20this%20region.%20Units%20outside%20this%20region%20may%20be%20problematic%20for%20causal%20inference.%0A%0A%20%20%20%20%20%20%20%20**Extreme%20propensity%20scores**%20(close%20to%200%20or%201)%20indicate%20units%20that%20are%20very%20likely%20to%20be%20in%20one%20group%20only%2C%20which%20can%20cause%20issues%20for%20some%20causal%20inference%20methods.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20table%20%3D%20mo.ui.table(ps_stats.round(4))%0A%0A%20%20%20%20%20%20%20%20%23%20Assessment%20of%20positivity%20assumption%0A%20%20%20%20%20%20%20%20assessment%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**Assessment%20of%20Positivity%20Assumption%3A**%20%20%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20For%20the%20logistic%20regression%20model%2C%20%7B%3A.1f%7D%25%20of%20units%20are%20within%20the%20common%20support%20region.%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20The%20random%20forest%20model%20shows%20%7B%3A.1f%7D%25%20of%20units%20in%20common%20support.%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Extreme%20propensity%20scores%20affect%20%7B%3A.1f%7D%25%20(logistic)%20and%20%7B%3A.1f%7D%25%20(random%20forest)%20of%20units.%20%20%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20%7B%7D%20model%20provides%20better%20overlap.%20Overall%2C%20the%20positivity%20assumption%20appears%20to%20be%20%7B%7D%20satisfied%2C%20which%20%7B%7D%20for%20reliable%20causal%20inference%20using%20propensity%20score%20methods.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22.format(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20in_support_logistic%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20in_support_rf%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20extreme_ps_logistic%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20extreme_ps_rf%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22logistic%20regression%22%20if%20in_support_logistic%20%3E%20in_support_rf%20else%20%22random%20forest%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22reasonably%20well%22%20if%20max(in_support_logistic%2C%20in_support_rf)%20%3E%2080%20else%20%22partially%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22is%20promising%22%20if%20max(in_support_logistic%2C%20in_support_rf)%20%3E%2080%20else%20%22raises%20some%20concerns%22%0A%20%20%20%20%20%20%20%20%20%20%20%20))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bheader%2C%20explanation%2C%20table%2C%20assessment%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20T_train%2C%0A%20%20%20%20X_train_scaled%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pd%2C%0A%20%20%20%20plt%2C%0A%20%20%20%20propensity_scores%2C%0A%20%20%20%20rf_propensity_scores%2C%0A%20%20%20%20roc_auc_score%2C%0A%20%20%20%20roc_curve%2C%0A)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20figure%20for%20ROC%20curves%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20ROC%20curves%0A%20%20%20%20%20%20%20%20fpr_lr%2C%20tpr_lr%2C%20_%20%3D%20roc_curve(T_train%2C%20propensity_scores)%0A%20%20%20%20%20%20%20%20fpr_rf%2C%20tpr_rf%2C%20_%20%3D%20roc_curve(T_train%2C%20rf_propensity_scores)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20AUC%20scores%0A%20%20%20%20%20%20%20%20auc_lr%20%3D%20roc_auc_score(T_train%2C%20propensity_scores)%0A%20%20%20%20%20%20%20%20auc_rf%20%3D%20roc_auc_score(T_train%2C%20rf_propensity_scores)%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20ROC%20curves%0A%20%20%20%20%20%20%20%20ax.plot(fpr_lr%2C%20tpr_lr%2C%20lw%3D2%2C%20label%3Df'Logistic%20Regression%20(AUC%20%3D%20%7Bauc_lr%3A.3f%7D)')%0A%20%20%20%20%20%20%20%20ax.plot(fpr_rf%2C%20tpr_rf%2C%20lw%3D2%2C%20label%3Df'Random%20Forest%20(AUC%20%3D%20%7Bauc_rf%3A.3f%7D)')%0A%20%20%20%20%20%20%20%20ax.plot(%5B0%2C%201%5D%2C%20%5B0%2C%201%5D%2C%20'k--'%2C%20lw%3D2)%0A%0A%20%20%20%20%20%20%20%20ax.set_xlim(%5B0.0%2C%201.0%5D)%0A%20%20%20%20%20%20%20%20ax.set_ylim(%5B0.0%2C%201.05%5D)%0A%20%20%20%20%20%20%20%20ax.set_xlabel('False%20Positive%20Rate')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('True%20Positive%20Rate')%0A%20%20%20%20%20%20%20%20ax.set_title('ROC%20Curves%20for%20Propensity%20Score%20Models')%0A%20%20%20%20%20%20%20%20ax.legend(loc%3D'lower%20right')%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20standardized%20mean%20differences%20for%20covariates%0A%20%20%20%20%20%20%20%20def%20calc_smd(var%2C%20treatment)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Calculate%20standardized%20mean%20difference%20for%20a%20variable%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20treated_mean%20%3D%20var%5Btreatment%20%3D%3D%201%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20control_mean%20%3D%20var%5Btreatment%20%3D%3D%200%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20treated_var%20%3D%20var%5Btreatment%20%3D%3D%201%5D.var()%0A%20%20%20%20%20%20%20%20%20%20%20%20control_var%20%3D%20var%5Btreatment%20%3D%3D%200%5D.var()%0A%20%20%20%20%20%20%20%20%20%20%20%20pooled_std%20%3D%20np.sqrt((treated_var%20%2B%20control_var)%20%2F%202)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Handle%20zero%20standard%20deviation%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20pooled_std%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20(treated_mean%20-%20control_mean)%20%2F%20pooled_std%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20SMD%20for%20each%20variable%0A%20%20%20%20%20%20%20%20smd_values%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20col%20in%20X_train_scaled.columns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20smd%20%3D%20calc_smd(X_train_scaled%5Bcol%5D%2C%20T_train)%0A%20%20%20%20%20%20%20%20%20%20%20%20smd_values.append(%7B'Variable'%3A%20col%2C%20'SMD'%3A%20smd%7D)%0A%0A%20%20%20%20%20%20%20%20smd_df%20%3D%20pd.DataFrame(smd_values)%0A%0A%20%20%20%20%20%20%20%20%23%20Sort%20by%20absolute%20SMD%0A%20%20%20%20%20%20%20%20smd_df%5B'Abs_SMD'%5D%20%3D%20smd_df%5B'SMD'%5D.abs()%0A%20%20%20%20%20%20%20%20smd_df%20%3D%20smd_df.sort_values('Abs_SMD'%2C%20ascending%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20two-part%20layout%0A%20%20%20%20%20%20%20%20roc_plot%20%3D%20mo.mpl.interactive(fig)%0A%20%20%20%20%20%20%20%20roc_header%20%3D%20mo.md(%22%23%23%23%23%20Propensity%20Score%20Model%20Evaluation%22)%0A%20%20%20%20%20%20%20%20roc_explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20The%20ROC%20curves%20and%20AUC%20scores%20show%20how%20well%20our%20propensity%20score%20models%20discriminate%20between%20treated%20and%20control%20units.%20Higher%20AUC%20indicates%20better%20discrimination.%20%0A%0A%20%20%20%20%20%20%20%20The%20Random%20Forest%20model%20typically%20achieves%20higher%20AUC%2C%20but%20this%20doesn't%20necessarily%20make%20it%20better%20for%20propensity%20score%20estimation.%20In%20fact%2C%20for%20propensity%20score%20analysis%2C%20we%20often%20prefer%20models%20that%20achieve%20good%20covariate%20balance%20rather%20than%20maximizing%20predictive%20performance.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Show%20balance%20table%20for%20top%2010%20most%20imbalanced%20covariates%0A%20%20%20%20%20%20%20%20balance_header%20%3D%20mo.md(%22%23%23%23%23%20Covariate%20Balance%20Assessment%22)%0A%20%20%20%20%20%20%20%20balance_explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20The%20table%20below%20shows%20the%20standardized%20mean%20differences%20(SMD)%20for%20the%20most%20imbalanced%20covariates.%20SMD%20measures%20the%20difference%20in%20means%20between%20treated%20and%20control%20groups%20in%20standard%20deviation%20units.%0A%0A%20%20%20%20%20%20%20%20-%20**SMD%20%3E%200.1**%3A%20Indicates%20meaningful%20imbalance%0A%20%20%20%20%20%20%20%20-%20**SMD%20%3E%200.25**%3A%20Indicates%20substantial%20imbalance%0A%0A%20%20%20%20%20%20%20%20Effective%20propensity%20score%20methods%20should%20reduce%20these%20imbalances%20when%20we%20condition%20on%20the%20propensity%20score.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20balance_table%20%3D%20mo.ui.table(smd_df.head(10).round(4))%0A%0A%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20roc_header%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20roc_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20roc_explanation%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20balance_header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20balance_explanation%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20balance_table%0A%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.callout(mo.md(%22%22%22%0A%20%20%20%20**Summary%20of%20Propensity%20Score%20Analysis%3A**%0A%0A%20%20%20%201.%20We've%20estimated%20propensity%20scores%20using%20both%20logistic%20regression%20and%20random%20forest%20models.%0A%20%20%20%202.%20The%20distributions%20show%20some%20separation%20between%20treated%20and%20control%20groups%2C%20which%20is%20expected%20in%20observational%20data.%0A%20%20%20%203.%20The%20common%20support%20analysis%20confirms%20that%20most%20units%20fall%20within%20regions%20where%20causal%20inference%20is%20reliable.%0A%20%20%20%204.%20The%20covariate%20balance%20assessment%20identifies%20which%20variables%20contribute%20most%20to%20selection%20bias.%0A%0A%20%20%20%20These%20propensity%20scores%20will%20be%20used%20in%20subsequent%20sections%20for%20implementing%20various%20causal%20inference%20methods%20including%3A%0A%20%20%20%20-%20Inverse%20Probability%20Weighting%20(IPW)%0A%20%20%20%20-%20Propensity%20Score%20Matching%0A%20%20%20%20-%20Propensity%20Score%20Stratification%0A%20%20%20%20-%20Doubly%20Robust%20methods%0A%0A%20%20%20%20Each%20method%20leverages%20propensity%20scores%20differently%20to%20estimate%20causal%20effects%20while%20accounting%20for%20confounding.%0A%20%20%20%20%22%22%22)%2C%20kind%3D%22success%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%206.%20Implementing%20Causal%20Inference%20Methods%20%7B%23methods%7D%0A%0A%20%20%20%20%20%20%20%20In%20this%20section%2C%20we'll%20implement%20and%20evaluate%20various%20causal%20inference%20methods%20on%20the%20IHDP%20dataset.%20We'll%20start%20with%20simple%20methods%2C%20then%20move%20to%20propensity%20score-based%20approaches%2C%20and%20finally%20explore%20advanced%20machine%20learning%20methods.%20For%20each%20method%2C%20we'll%3A%0A%0A%20%20%20%20%20%20%20%201.%20Explain%20the%20methodology%20and%20key%20assumptions%0A%20%20%20%20%20%20%20%202.%20Implement%20the%20method%20on%20our%20training%20data%0A%20%20%20%20%20%20%20%203.%20Evaluate%20its%20performance%20against%20the%20known%20ground%20truth%0A%20%20%20%20%20%20%20%204.%20Discuss%20strengths%2C%20weaknesses%2C%20and%20practical%20considerations%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%23%206.1%20Simple%20Causal%20Inference%20Methods%20%7B%23simple-methods%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%94%8D%20**Step%201**%3A%20Start%20with%20simple%20methods%20before%20moving%20to%20more%20complex%20approaches%0A%0A%20%20%20%20%20%20%20%20We'll%20begin%20with%20straightforward%20approaches%20that%20form%20the%20foundation%20of%20causal%20inference.%20These%20methods%20are%20easy%20to%20implement%20and%20interpret%2C%20making%20them%20excellent%20starting%20points%20for%20causal%20analysis.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20a%20description%20of%20naive%20mean%20difference%20approach%0A%20%20%20%20naive_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Naive%20Mean%20Difference%0A%0A%20%20%20%20%20%20%20%20The%20simplest%20approach%20to%20estimating%20causal%20effects%20is%20to%20compare%20the%20average%20outcomes%20between%20treated%20and%20control%20groups%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20%5Chat%7BATE%7D_%7Bnaive%7D%20%3D%20%5Cfrac%7B1%7D%7Bn_1%7D%5Csum_%7Bi%3AT_i%3D1%7DY_i%20-%20%5Cfrac%7B1%7D%7Bn_0%7D%5Csum_%7Bi%3AT_i%3D0%7DY_i%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(n_1%5C)%20is%20the%20number%20of%20treated%20units%20and%20%5C(n_0%5C)%20is%20the%20number%20of%20control%20units.%0A%0A%20%20%20%20%20%20%20%20**Key%20Assumption**%3A%20Treatment%20is%20randomly%20assigned%20(no%20confounding).%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20In%20observational%20studies%2C%20this%20estimate%20is%20often%20biased%20due%20to%20confounding%20factors%20that%20affect%20both%20treatment%20assignment%20and%20outcomes.%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Create%20a%20description%20of%20regression%20adjustment%20approach%0A%20%20%20%20regression_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Regression%20Adjustment%0A%0A%20%20%20%20%20%20%20%20This%20method%20controls%20for%20confounding%20by%20including%20covariates%20in%20a%20regression%20model%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20Y_i%20%3D%20%5Calpha%20%2B%20%5Ctau%20T_i%20%2B%20%5Cbeta%20X_i%20%2B%20%5Cepsilon_i%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20The%20coefficient%20%5C(%5Ctau%5C)%20of%20the%20treatment%20variable%20%5C(T%5C)%20provides%20an%20estimate%20of%20the%20ATE.%0A%0A%20%20%20%20%20%20%20%20**Key%20Assumption**%3A%20The%20regression%20model%20is%20correctly%20specified%20(includes%20all%20confounders%20and%20captures%20their%20relationships%20with%20the%20outcome).%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Simple%20to%20implement%2C%20interpretable%2C%20can%20handle%20continuous%20and%20binary%20covariates.%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20Relies%20on%20strong%20assumptions%20about%20the%20functional%20form%20of%20the%20relationship%20between%20covariates%20and%20outcomes.%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Create%20a%20description%20of%20stratification%20approach%0A%20%20%20%20stratification_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Stratification%2FSubclassification%0A%0A%20%20%20%20%20%20%20%20This%20method%20divides%20the%20data%20into%20subgroups%20(strata)%20based%20on%20important%20covariates%2C%20estimates%20treatment%20effects%20within%20each%20stratum%2C%20and%20takes%20a%20weighted%20average%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20%5Chat%7BATE%7D_%7Bstrat%7D%20%3D%20%5Csum_%7Bs%3D1%7D%5E%7BS%7D%20w_s%20(%5Cbar%7BY%7D_%7Bs%2C1%7D%20-%20%5Cbar%7BY%7D_%7Bs%2C0%7D)%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(%5Cbar%7BY%7D_%7Bs%2C1%7D%5C)%20is%20the%20average%20outcome%20for%20treated%20units%20in%20stratum%20%5C(s%5C)%2C%20%5C(%5Cbar%7BY%7D_%7Bs%2C0%7D%5C)%20is%20the%20average%20for%20control%20units%2C%20and%20%5C(w_s%5C)%20is%20the%20proportion%20of%20units%20in%20stratum%20%5C(s%5C).%0A%0A%20%20%20%20%20%20%20%20**Key%20Assumption**%3A%20Within%20each%20stratum%2C%20treatment%20is%20effectively%20randomly%20assigned.%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Intuitive%2C%20handles%20non-linear%20relationships%2C%20allows%20examination%20of%20effect%20heterogeneity.%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20Can%20only%20stratify%20on%20a%20few%20variables%20before%20encountering%20sparsity%20issues.%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Display%20all%20method%20descriptions%20together%0A%20%20%20%20mo.vstack(%5Bnaive_description%2C%20regression_description%2C%20stratification_description%5D)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20naive_description%2C%0A%20%20%20%20%20%20%20%20regression_description%2C%0A%20%20%20%20%20%20%20%20stratification_description%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20LinearRegression%2C%0A%20%20%20%20T_train%2C%0A%20%20%20%20X_train_scaled%2C%0A%20%20%20%20Y0_train%2C%0A%20%20%20%20Y1_train%2C%0A%20%20%20%20Y_train%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pd%2C%0A%20%20%20%20plt%2C%0A)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%201.%20Naive%20Mean%20Difference%0A%20%20%20%20%20%20%20%20def%20naive_estimator(T%2C%20Y)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Calculate%20naive%20mean%20difference%20between%20treated%20and%20control%20outcomes%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20treated_mean%20%3D%20Y%5BT%20%3D%3D%201%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20control_mean%20%3D%20Y%5BT%20%3D%3D%200%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20treated_mean%20-%20control_mean%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20naive%20ATE%0A%20%20%20%20%20%20%20%20naive_ate%20%3D%20naive_estimator(T_train%2C%20Y_train)%0A%0A%20%20%20%20%20%20%20%20%23%20Get%20true%20ATE%20for%20comparison%0A%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%20%20%20%20%0A%0A%20%20%20%20%20%20%20%20def%20regression_adjustment(X%2C%20T%2C%20Y)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Estimate%20ATE%20using%20regression%20adjustment%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20a%20copy%20of%20X%20to%20avoid%20modifying%20the%20original%0A%20%20%20%20%20%20%20%20%20%20%20%20X_with_treatment%20%3D%20X.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Add%20treatment%20as%20a%20feature%0A%20%20%20%20%20%20%20%20%20%20%20%20X_with_treatment%5B'treatment'%5D%20%3D%20T%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20linear%20regression%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20model%20%3D%20LinearRegression()%0A%20%20%20%20%20%20%20%20%20%20%20%20model.fit(X_with_treatment%2C%20Y)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Extract%20treatment%20coefficient%0A%20%20%20%20%20%20%20%20%20%20%20%20treatment_idx%20%3D%20X_with_treatment.columns.get_loc('treatment')%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20model.coef_%5Btreatment_idx%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20model%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20regression-adjusted%20ATE%0A%20%20%20%20%20%20%20%20reg_ate%2C%20reg_model%20%3D%20regression_adjustment(X_train_scaled%2C%20T_train%2C%20Y_train)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Stratification%20on%20an%20important%20covariate%0A%20%20%20%20%20%20%20%20def%20stratification(X%2C%20T%2C%20Y%2C%20stratify_var%2C%20n_strata%3D5)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Estimate%20ATE%20by%20stratifying%20on%20a%20variable%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20a%20copy%20of%20the%20data%20with%20relevant%20variables%0A%20%20%20%20%20%20%20%20%20%20%20%20data%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'T'%3A%20T%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Y'%3A%20Y%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'strat_var'%3A%20X%5Bstratify_var%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20equal-sized%20strata%20based%20on%20the%20stratification%20variable%0A%20%20%20%20%20%20%20%20%20%20%20%20data%5B'stratum'%5D%20%3D%20pd.qcut(data%5B'strat_var'%5D%2C%20n_strata%2C%20labels%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effect%20within%20each%20stratum%0A%20%20%20%20%20%20%20%20%20%20%20%20strata_effects%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20strata_sizes%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20s%20in%20range(n_strata)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_data%20%3D%20data%5Bdata%5B'stratum'%5D%20%3D%3D%20s%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Only%20calculate%20if%20we%20have%20both%20treated%20and%20control%20units%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(stratum_data%5B'T'%5D%20%3D%3D%201).sum()%20%3E%200%20and%20(stratum_data%5B'T'%5D%20%3D%3D%200).sum()%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_treated%20%3D%20stratum_data%5Bstratum_data%5B'T'%5D%20%3D%3D%201%5D%5B'Y'%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_control%20%3D%20stratum_data%5Bstratum_data%5B'T'%5D%20%3D%3D%200%5D%5B'Y'%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_effect%20%3D%20stratum_treated%20-%20stratum_control%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_size%20%3D%20len(stratum_data)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20strata_effects.append(stratum_effect)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20strata_sizes.append(stratum_size)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20weighted%20average%20(weighted%20by%20stratum%20size)%0A%20%20%20%20%20%20%20%20%20%20%20%20total_size%20%3D%20sum(strata_sizes)%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20%5Bsize%20%2F%20total_size%20for%20size%20in%20strata_sizes%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20weighted_ate%20%3D%20sum(effect%20*%20weight%20for%20effect%2C%20weight%20in%20zip(strata_effects%2C%20weights))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20weighted_ate%2C%20strata_effects%2C%20weights%0A%0A%20%20%20%20%20%20%20%20%23%20Choose%20birth%20weight%20(x_0)%20as%20stratification%20variable%0A%20%20%20%20%20%20%20%20strat_ate%2C%20strat_effects%2C%20strat_weights%20%3D%20stratification(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20'x_0')%0A%0A%20%20%20%20%20%20%20%20%23%20Compile%20results%0A%20%20%20%20%20%20%20%20methods%20%3D%20%5B'Naive%20Mean%20Difference'%2C%20'Regression%20Adjustment'%2C%20'Stratification'%5D%0A%20%20%20%20%20%20%20%20estimates%20%3D%20%5Bnaive_ate%2C%20reg_ate%2C%20strat_ate%5D%0A%20%20%20%20%20%20%20%20biases%20%3D%20%5Best%20-%20true_ate%20for%20est%20in%20estimates%5D%0A%20%20%20%20%20%20%20%20abs_biases%20%3D%20%5Babs(bias)%20for%20bias%20in%20biases%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Print%20results%0A%20%20%20%20%20%20%20%20print(%22Simple%20Methods%20Results%3A%22)%0A%20%20%20%20%20%20%20%20print(f%22True%20ATE%3A%20%7Btrue_ate%3A.4f%7D%22)%0A%20%20%20%20%20%20%20%20print(%22-%22%20*%2050)%0A%20%20%20%20%20%20%20%20for%20method%2C%20estimate%2C%20bias%20in%20zip(methods%2C%20estimates%2C%20biases)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%7Bmethod%7D%3A%20ATE%20%3D%20%7Bestimate%3A.4f%7D%2C%20Bias%20%3D%20%7Bbias%3A.4f%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Return%20all%20relevant%20objects%20for%20use%20in%20visualization%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20figure%20for%20comparing%20estimates%20from%20simple%20methods%0A%20%20%20%20%20%20%20%20fig%2C%20axes%20%3D%20plt.subplots(1%2C%202%2C%20figsize%3D(14%2C%206))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%201%3A%20Bar%20chart%20comparing%20ATE%20estimates%0A%20%20%20%20%20%20%20%20bars%20%3D%20axes%5B0%5D.bar(methods%2C%20estimates%2C%20color%3D%5B'skyblue'%2C%20'lightgreen'%2C%20'salmon'%5D)%0A%20%20%20%20%20%20%20%20axes%5B0%5D.axhline(y%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_title('ATE%20Estimates%20from%20Simple%20Methods')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.set_ylabel('ATE%20Estimate')%0A%20%20%20%20%20%20%20%20axes%5B0%5D.legend()%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20value%20labels%20to%20the%20bars%0A%20%20%20%20%20%20%20%20for%20bar%20in%20bars%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20height%20%3D%20bar.get_height()%0A%20%20%20%20%20%20%20%20%20%20%20%20axes%5B0%5D.text(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bar.get_x()%20%2B%20bar.get_width()%2F2.%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height%20%2B%200.05%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%7Bheight%3A.4f%7D'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ha%3D'center'%2C%20va%3D'bottom'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rotation%3D0%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%202%3A%20Bar%20chart%20for%20bias%0A%20%20%20%20%20%20%20%20biases_df%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20methods%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Absolute%20Bias'%3A%20abs_biases%0A%20%20%20%20%20%20%20%20%7D).sort_values('Absolute%20Bias')%0A%0A%20%20%20%20%20%20%20%20bars%20%3D%20axes%5B1%5D.barh(biases_df%5B'Method'%5D%2C%20biases_df%5B'Absolute%20Bias'%5D%2C%20color%3D%5B'lightgreen'%2C%20'skyblue'%2C%20'salmon'%5D)%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_title('Absolute%20Bias%20of%20Simple%20Methods')%0A%20%20%20%20%20%20%20%20axes%5B1%5D.set_xlabel('Absolute%20Bias')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20value%20labels%20to%20the%20bars%0A%20%20%20%20%20%20%20%20for%20bar%20in%20bars%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20width%20%3D%20bar.get_width()%0A%20%20%20%20%20%20%20%20%20%20%20%20axes%5B1%5D.text(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20width%20%2B%200.005%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bar.get_y()%20%2B%20bar.get_height()%2F2.%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%7Bwidth%3A.4f%7D'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ha%3D'left'%2C%20va%3D'center'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20visualization%20for%20stratification%20results%0A%20%20%20%20%20%20%20%20fig2%2C%20ax2%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20stratum-specific%20effects%0A%20%20%20%20%20%20%20%20strata_indices%20%3D%20list(range(len(strat_effects)))%0A%20%20%20%20%20%20%20%20ax2.bar(strata_indices%2C%20strat_effects%2C%20alpha%3D0.7)%0A%20%20%20%20%20%20%20%20ax2.axhline(y%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%0A%20%20%20%20%20%20%20%20%23%20Set%20labels%20and%20title%0A%20%20%20%20%20%20%20%20ax2.set_title('Treatment%20Effects%20by%20Stratum')%0A%20%20%20%20%20%20%20%20ax2.set_xlabel('Stratum%20(Birth%20Weight%20Quintile)')%0A%20%20%20%20%20%20%20%20ax2.set_ylabel('Treatment%20Effect')%0A%20%20%20%20%20%20%20%20ax2.set_xticks(strata_indices)%0A%20%20%20%20%20%20%20%20ax2.set_xticklabels(%5Bf'Q%7Bi%2B1%7D%5Cn(%7Bw%3A.2f%7D)'%20for%20i%2C%20w%20in%20enumerate(strat_weights)%5D)%0A%20%20%20%20%20%20%20%20ax2.legend()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20layout%20containing%20both%20visualizations%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Simple%20Methods%20Comparison%22)%0A%20%20%20%20%20%20%20%20methods_comparison%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20strat_header%20%3D%20mo.md(%22%23%23%23%23%20Heterogeneous%20Effects%20by%20Birth%20Weight%20Stratum%22)%0A%20%20%20%20%20%20%20%20strat_note%20%3D%20mo.md(%22*Note%3A%20Numbers%20in%20parentheses%20show%20the%20weight%20of%20each%20stratum%20in%20the%20overall%20estimate.*%22)%0A%20%20%20%20%20%20%20%20strat_effects_plot%20%3D%20mo.mpl.interactive(fig2)%0A%0A%20%20%20%20%20%20%20%20methods_analysis%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**Analysis%20of%20Simple%20Methods%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%201.%20**Naive%20Mean%20Difference**%3A%20The%20naive%20estimate%20has%20a%20bias%20of%20%7Bbiases%5B0%5D%3A.4f%7D%2C%20which%20is%20%7Babs_biases%5B0%5D%3A.4f%7D%20in%20absolute%20terms.%20This%20is%20relatively%20%7B'small'%20if%20abs_biases%5B0%5D%20%3C%200.1%20else%20'moderate'%20if%20abs_biases%5B0%5D%20%3C%200.5%20else%20'large'%7D%2C%20suggesting%20that%20selection%20bias%20in%20this%20dataset%20may%20not%20be%20very%20strong.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%202.%20**Regression%20Adjustment**%3A%20This%20method%20has%20a%20bias%20of%20%7Bbiases%5B1%5D%3A.4f%7D%20(absolute%3A%20%7Babs_biases%5B1%5D%3A.4f%7D)%2C%20%7B'improving%20upon'%20if%20abs_biases%5B1%5D%20%3C%20abs_biases%5B0%5D%20else%20'performing%20worse%20than'%7D%20the%20naive%20estimator.%20This%20%7B'improvement'%20if%20abs_biases%5B1%5D%20%3C%20abs_biases%5B0%5D%20else%20'decline'%7D%20in%20performance%20suggests%20that%20the%20linear%20model%20%7B'adequately'%20if%20abs_biases%5B1%5D%20%3C%20abs_biases%5B0%5D%20else%20'inadequately'%7D%20captures%20the%20relationship%20between%20covariates%20and%20outcomes.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%203.%20**Stratification**%3A%20This%20approach%20has%20a%20bias%20of%20%7Bbiases%5B2%5D%3A.4f%7D%20(absolute%3A%20%7Babs_biases%5B2%5D%3A.4f%7D)%2C%20%7B'outperforming'%20if%20abs_biases%5B2%5D%20%3C%20min(abs_biases%5B0%5D%2C%20abs_biases%5B1%5D)%20else%20'underperforming%20compared%20to'%7D%20the%20other%20methods.%20Stratification%20by%20birth%20weight%20reveals%20some%20heterogeneity%20in%20treatment%20effects%20across%20strata%2C%20which%20is%20valuable%20information%20for%20targeting%20interventions.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Overall%2C%20the%20%7B'Regression%20Adjustment'%20if%20abs_biases%5B1%5D%20%3D%3D%20min(abs_biases)%20else%20'Naive%20Mean%20Difference'%20if%20abs_biases%5B0%5D%20%3D%3D%20min(abs_biases)%20else%20'Stratification'%7D%20method%20performs%20best%20in%20terms%20of%20bias%20reduction%20for%20this%20dataset.%20However%2C%20all%20methods%20show%20relatively%20small%20bias%2C%20suggesting%20that%20the%20selection%20mechanism%20in%20this%20semi-synthetic%20dataset%20may%20not%20induce%20strong%20confounding.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20methods_comparison%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20methods_analysis%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_effects_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_note%0A%20%20%20%20%20%20%20%20%5D))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%23%206.2%20Propensity%20Score%20Methods%20%7B%23ps-methods%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%8E%AF%20**Step%202**%3A%20Apply%20propensity%20score-based%20methods%20to%20adjust%20for%20confounding%0A%0A%20%20%20%20%20%20%20%20Building%20on%20the%20propensity%20scores%20we%20estimated%20earlier%2C%20we'll%20now%20implement%20methods%20that%20use%20these%20scores%20to%20create%20balance%20between%20treated%20and%20control%20groups.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20a%20description%20of%20IPW%20approach%0A%20%20%20%20ipw_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Inverse%20Probability%20Weighting%20(IPW)%0A%0A%20%20%20%20%20%20%20%20IPW%20creates%20a%20pseudo-population%20where%20the%20confounding%20influence%20is%20eliminated%20by%20weighting%20each%20observation%20by%20the%20inverse%20of%20its%20probability%20of%20receiving%20the%20treatment%20it%20actually%20received%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20%5Chat%7BATE%7D_%7BIPW%7D%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bi%3D1%7D%5E%7Bn%7D%20%5Cleft(%20%5Cfrac%7BT_i%20Y_i%7D%7Be(X_i)%7D%20-%20%5Cfrac%7B(1-T_i)%20Y_i%7D%7B1-e(X_i)%7D%20%5Cright)%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(e(X_i)%5C)%20is%20the%20propensity%20score%20for%20unit%20%5C(i%5C).%0A%0A%20%20%20%20%20%20%20%20**Key%20Advantages**%3A%0A%20%20%20%20%20%20%20%20-%20Uses%20all%20data%20points%0A%20%20%20%20%20%20%20%20-%20Simple%20to%20implement%0A%20%20%20%20%20%20%20%20-%20Intuitive%20connection%20to%20survey%20sampling%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%0A%20%20%20%20%20%20%20%20-%20Sensitive%20to%20extreme%20propensity%20scores%20(near%200%20or%201)%0A%20%20%20%20%20%20%20%20-%20Can%20have%20high%20variance%0A%20%20%20%20%20%20%20%20-%20Requires%20well-specified%20propensity%20model%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Create%20a%20description%20of%20matching%20approach%0A%20%20%20%20matching_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Propensity%20Score%20Matching%0A%0A%20%20%20%20%20%20%20%20Matching%20pairs%20treated%20units%20with%20control%20units%20that%20have%20similar%20propensity%20scores.%20The%20average%20difference%20in%20outcomes%20between%20matched%20pairs%20provides%20an%20estimate%20of%20the%20ATE%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20%5Chat%7BATE%7D_%7Bmatch%7D%20%3D%20%5Cfrac%7B1%7D%7Bn_1%7D%20%5Csum_%7Bi%3AT_i%3D1%7D%20(Y_i%20-%20Y_%7Bj(i)%7D)%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(j(i)%5C)%20is%20the%20index%20of%20the%20control%20unit%20matched%20to%20treated%20unit%20%5C(i%5C).%0A%0A%20%20%20%20%20%20%20%20**Key%20Advantages**%3A%0A%20%20%20%20%20%20%20%20-%20Intuitive%20and%20easy%20to%20explain%0A%20%20%20%20%20%20%20%20-%20Can%20be%20combined%20with%20exact%20matching%20on%20key%20variables%0A%20%20%20%20%20%20%20%20-%20Preserves%20the%20original%20outcome%20variable%20scale%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%0A%20%20%20%20%20%20%20%20-%20Discards%20units%20that%20cannot%20be%20matched%0A%20%20%20%20%20%20%20%20-%20Choice%20of%20matching%20algorithm%20and%20caliper%20can%20affect%20results%0A%20%20%20%20%20%20%20%20-%20Matches%20may%20not%20be%20perfect%2C%20leaving%20some%20residual%20confounding%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Create%20a%20description%20of%20stratification%20approach%20using%20propensity%20scores%0A%20%20%20%20ps_stratification_description%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Propensity%20Score%20Stratification%0A%0A%20%20%20%20%20%20%20%20This%20method%20divides%20the%20data%20into%20strata%20based%20on%20propensity%20scores%2C%20estimates%20treatment%20effects%20within%20each%20stratum%2C%20and%20computes%20a%20weighted%20average%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%0A%20%20%20%20%20%20%20%20%5Chat%7BATE%7D_%7Bstrat%7D%20%3D%20%5Csum_%7Bs%3D1%7D%5E%7BS%7D%20w_s%20(%5Cbar%7BY%7D_%7Bs%2C1%7D%20-%20%5Cbar%7BY%7D_%7Bs%2C0%7D)%0A%20%20%20%20%20%20%20%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(w_s%5C)%20is%20the%20proportion%20of%20units%20in%20stratum%20%5C(s%5C)%2C%20and%20%5C(%5Cbar%7BY%7D_%7Bs%2C1%7D%5C)%20and%20%5C(%5Cbar%7BY%7D_%7Bs%2C0%7D%5C)%20are%20the%20average%20outcomes%20for%20treated%20and%20control%20units%20in%20that%20stratum.%0A%0A%20%20%20%20%20%20%20%20**Key%20Advantages**%3A%0A%20%20%20%20%20%20%20%20-%20Uses%20all%20data%20points%0A%20%20%20%20%20%20%20%20-%20Examines%20effect%20heterogeneity%20across%20propensity%20score%20strata%0A%20%20%20%20%20%20%20%20-%20Usually%20reduces%20~90%25%20of%20confounding%20bias%20with%20just%205%20strata%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%0A%20%20%20%20%20%20%20%20-%20Less%20precise%20than%20matching%20for%20estimating%20average%20effects%0A%20%20%20%20%20%20%20%20-%20Choice%20of%20strata%20boundaries%20can%20affect%20results%0A%20%20%20%20%20%20%20%20-%20May%20not%20fully%20eliminate%20confounding%20within%20strata%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Display%20all%20method%20descriptions%20together%0A%20%20%20%20mo.vstack(%5Bipw_description%2C%20matching_description%2C%20ps_stratification_description%5D)%0A%20%20%20%20return%20ipw_description%2C%20matching_description%2C%20ps_stratification_description%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20X_train_scaled%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20np%2C%20pd)%3A%0A%20%20%20%20%23%20Implement%20propensity%20score%20methods%0A%20%20%20%20from%20sklearn.linear_model%20import%20LogisticRegression%0A%20%20%20%20from%20sklearn.ensemble%20import%20RandomForestClassifier%0A%20%20%20%20from%20sklearn.metrics%20import%20roc_auc_score%2C%20roc_curve%0A%0A%20%20%20%20%23%20Estimate%20propensity%20scores%20using%20logistic%20regression%0A%20%20%20%20propensity_model%20%3D%20LogisticRegression(max_iter%3D1000%2C%20C%3D1.0)%0A%20%20%20%20propensity_model.fit(X_train_scaled%2C%20T_train)%0A%0A%20%20%20%20%23%20Calculate%20propensity%20scores%20(probability%20of%20receiving%20treatment)%0A%20%20%20%20propensity_scores%20%3D%20propensity_model.predict_proba(X_train_scaled)%5B%3A%2C%201%5D%0A%0A%20%20%20%20%23%20Also%20estimate%20propensity%20scores%20using%20a%20Random%20Forest%20for%20comparison%0A%20%20%20%20rf_propensity_model%20%3D%20RandomForestClassifier(n_estimators%3D100%2C%20min_samples_leaf%3D10%2C%20random_state%3D42)%0A%20%20%20%20rf_propensity_model.fit(X_train_scaled%2C%20T_train)%0A%20%20%20%20rf_propensity_scores%20%3D%20rf_propensity_model.predict_proba(X_train_scaled)%5B%3A%2C%201%5D%0A%0A%20%20%20%20%23%20Create%20DataFrame%20with%20propensity%20scores%0A%20%20%20%20ps_df%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20'treatment'%3A%20T_train%2C%0A%20%20%20%20%20%20%20%20'ps_logistic'%3A%20propensity_scores%2C%0A%20%20%20%20%20%20%20%20'ps_rf'%3A%20rf_propensity_scores%0A%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Evaluate%20propensity%20score%20models%0A%20%20%20%20logistic_auc%20%3D%20roc_auc_score(T_train%2C%20propensity_scores)%0A%20%20%20%20rf_auc%20%3D%20roc_auc_score(T_train%2C%20rf_propensity_scores)%0A%0A%20%20%20%20print(f%22Logistic%20Regression%20AUC%3A%20%7Blogistic_auc%3A.4f%7D%22)%0A%20%20%20%20print(f%22Random%20Forest%20AUC%3A%20%7Brf_auc%3A.4f%7D%22)%0A%0A%20%20%20%20%23%201.%20Implement%20Inverse%20Probability%20Weighting%20(IPW)%0A%20%20%20%20%23%20Calculate%20true%20ATE%20for%20comparison%0A%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%23%20Function%20to%20calculate%20IPW%20estimate%0A%20%20%20%20def%20ipw_estimator(T%2C%20Y%2C%20ps%2C%20stabilized%3DTrue%2C%20trimming%3DNone)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Calculate%20ATE%20using%20inverse%20probability%20weighting%22%22%22%0A%20%20%20%20%20%20%20%20%23%20Calculate%20IPW%20weights%0A%20%20%20%20%20%20%20%20if%20stabilized%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Stabilized%20weights%0A%20%20%20%20%20%20%20%20%20%20%20%20p_treatment%20%3D%20T.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20np.where(T%20%3D%3D%201%2C%20p_treatment%20%2F%20ps%2C%20(1%20-%20p_treatment)%20%2F%20(1%20-%20ps))%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Unstabilized%20weights%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20np.where(T%20%3D%3D%201%2C%201%20%2F%20ps%2C%201%20%2F%20(1%20-%20ps))%0A%0A%20%20%20%20%20%20%20%20%23%20Trim%20weights%20if%20requested%0A%20%20%20%20%20%20%20%20if%20trimming%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20max_weight%20%3D%20np.percentile(weights%2C%20trimming)%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20np.minimum(weights%2C%20max_weight)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20weighted%20means%0A%20%20%20%20%20%20%20%20weighted_treated%20%3D%20np.sum(weights%5BT%20%3D%3D%201%5D%20*%20Y%5BT%20%3D%3D%201%5D)%20%2F%20np.sum(weights%5BT%20%3D%3D%201%5D)%0A%20%20%20%20%20%20%20%20weighted_control%20%3D%20np.sum(weights%5BT%20%3D%3D%200%5D%20*%20Y%5BT%20%3D%3D%200%5D)%20%2F%20np.sum(weights%5BT%20%3D%3D%200%5D)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20ate%20%3D%20weighted_treated%20-%20weighted_control%0A%0A%20%20%20%20%20%20%20%20return%20ate%2C%20weights%0A%0A%20%20%20%20%23%20Calculate%20IPW%20estimates%20using%20different%20settings%0A%20%20%20%20ipw_results%20%3D%20%5B%5D%0A%0A%20%20%20%20for%20_ps_method%2C%20_ps_values%20in%20%5B('Logistic'%2C%20propensity_scores)%2C%20('RF'%2C%20rf_propensity_scores)%5D%3A%0A%20%20%20%20%20%20%20%20for%20stabilized%20in%20%5BTrue%2C%20False%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20trimming%20in%20%5BNone%2C%2095%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20IPW%20estimate%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ipw_ate%2C%20weights%20%3D%20ipw_estimator(T_train%2C%20Y_train%2C%20_ps_values%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stabilized%3Dstabilized%2C%20trimming%3Dtrimming)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ipw_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'PS%20Method'%3A%20_ps_method%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Stabilized'%3A%20stabilized%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Trimming'%3A%20trimming%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20ipw_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20ipw_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(ipw_ate%20-%20true_ate)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Max%20Weight'%3A%20np.max(weights)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Weight%20SD'%3A%20np.std(weights)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Convert%20to%20DataFrame%20for%20easier%20visualization%0A%20%20%20%20ipw_results_df%20%3D%20pd.DataFrame(ipw_results)%0A%20%20%20%20print(%22%5CnIPW%20Estimation%20Results%3A%22)%0A%20%20%20%20print(ipw_results_df.sort_values('Abs%20Bias').head())%0A%0A%20%20%20%20%23%20Find%20best%20IPW%20method%0A%20%20%20%20best_ipw_idx%20%3D%20ipw_results_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20best_ipw%20%3D%20ipw_results_df.loc%5Bbest_ipw_idx%5D%0A%20%20%20%20best_ipw_method%20%3D%20f'IPW%20(%7Bbest_ipw%5B%22PS%20Method%22%5D%7D%2C%20stabilized%3D%7Bbest_ipw%5B%22Stabilized%22%5D%7D%2C%20trimming%3D%7Bbest_ipw%5B%22Trimming%22%5D%7D)'%20%20%20%20%0A%0A%20%20%20%20%23%20Next%20cells%20will%20implement%20matching%20and%20stratification%20methods%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20LogisticRegression%2C%0A%20%20%20%20%20%20%20%20RandomForestClassifier%2C%0A%20%20%20%20%20%20%20%20best_ipw%2C%0A%20%20%20%20%20%20%20%20best_ipw_idx%2C%0A%20%20%20%20%20%20%20%20best_ipw_method%2C%0A%20%20%20%20%20%20%20%20ipw_ate%2C%0A%20%20%20%20%20%20%20%20ipw_estimator%2C%0A%20%20%20%20%20%20%20%20ipw_results%2C%0A%20%20%20%20%20%20%20%20ipw_results_df%2C%0A%20%20%20%20%20%20%20%20logistic_auc%2C%0A%20%20%20%20%20%20%20%20propensity_model%2C%0A%20%20%20%20%20%20%20%20propensity_scores%2C%0A%20%20%20%20%20%20%20%20ps_df%2C%0A%20%20%20%20%20%20%20%20rf_auc%2C%0A%20%20%20%20%20%20%20%20rf_propensity_model%2C%0A%20%20%20%20%20%20%20%20rf_propensity_scores%2C%0A%20%20%20%20%20%20%20%20roc_auc_score%2C%0A%20%20%20%20%20%20%20%20roc_curve%2C%0A%20%20%20%20%20%20%20%20stabilized%2C%0A%20%20%20%20%20%20%20%20trimming%2C%0A%20%20%20%20%20%20%20%20true_ate%2C%0A%20%20%20%20%20%20%20%20weights%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20T_train%2C%0A%20%20%20%20Y_train%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pd%2C%0A%20%20%20%20propensity_scores%2C%0A%20%20%20%20rf_propensity_scores%2C%0A%20%20%20%20true_ate%2C%0A)%3A%0A%20%20%20%20%23%202.%20Implement%20Propensity%20Score%20Matching%0A%20%20%20%20from%20sklearn.neighbors%20import%20NearestNeighbors%0A%0A%20%20%20%20def%20ps_matching(T%2C%20Y%2C%20ps%2C%20method%3D'nearest'%2C%20k%3D1%2C%20caliper%3DNone)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Calculate%20ATE%20using%20propensity%20score%20matching%22%22%22%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20DataFrame%20with%20all%20necessary%20info%0A%20%20%20%20%20%20%20%20data%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'treatment'%3A%20T.values%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'outcome'%3A%20Y.values%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'ps'%3A%20ps%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Separate%20treated%20and%20control%0A%20%20%20%20%20%20%20%20treated%20%3D%20data%5Bdata%5B'treatment'%5D%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20control%20%3D%20data%5Bdata%5B'treatment'%5D%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Reshape%20propensity%20scores%20for%20NearestNeighbors%0A%20%20%20%20%20%20%20%20treated_ps%20%3D%20treated%5B'ps'%5D.values.reshape(-1%2C%201)%0A%20%20%20%20%20%20%20%20control_ps%20%3D%20control%5B'ps'%5D.values.reshape(-1%2C%201)%0A%0A%20%20%20%20%20%20%20%20%23%20Nearest%20neighbor%20matching%0A%20%20%20%20%20%20%20%20nn%20%3D%20NearestNeighbors(n_neighbors%3Dk)%0A%20%20%20%20%20%20%20%20nn.fit(control_ps)%0A%20%20%20%20%20%20%20%20distances%2C%20indices%20%3D%20nn.kneighbors(treated_ps)%0A%0A%20%20%20%20%20%20%20%20%23%20For%20each%20treated%20unit%2C%20find%20its%20matches%0A%20%20%20%20%20%20%20%20matched_pairs%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20for%20i%2C%20treated_idx%20in%20enumerate(treated.index)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20j%20in%20range(k)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20control_idx%20%3D%20control.index%5Bindices%5Bi%2C%20j%5D%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dist%20%3D%20distances%5Bi%2C%20j%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Apply%20caliper%20if%20specified%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20caliper%20is%20None%20or%20dist%20%3C%20caliper%20*%20np.std(data%5B'ps'%5D)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20matched_pairs.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'treated_ps'%3A%20treated.loc%5Btreated_idx%2C%20'ps'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'control_ps'%3A%20control.loc%5Bcontrol_idx%2C%20'ps'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'treated_outcome'%3A%20treated.loc%5Btreated_idx%2C%20'outcome'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'control_outcome'%3A%20control.loc%5Bcontrol_idx%2C%20'outcome'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ps_diff'%3A%20abs(treated.loc%5Btreated_idx%2C%20'ps'%5D%20-%20control.loc%5Bcontrol_idx%2C%20'ps'%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20dataframe%20of%20matched%20pairs%0A%20%20%20%20%20%20%20%20if%20len(matched_pairs)%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20matched_df%20%3D%20pd.DataFrame(matched_pairs)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20(matched_df%5B'treated_outcome'%5D%20-%20matched_df%5B'control_outcome'%5D).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20matched_df%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22No%20matches%20found%20with%20current%20settings%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.nan%2C%20None%0A%0A%20%20%20%20%23%20Apply%20matching%20with%20different%20settings%0A%20%20%20%20matching_results%20%3D%20%5B%5D%0A%0A%20%20%20%20for%20_ps_method%2C%20_ps_values%20in%20%5B('Logistic'%2C%20propensity_scores)%2C%20('RF'%2C%20rf_propensity_scores)%5D%3A%0A%20%20%20%20%20%20%20%20for%20k%20in%20%5B1%2C%205%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20caliper%20in%20%5BNone%2C%200.2%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Skip%20multiple%20neighbors%20with%20no%20caliper%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20k%20%3E%201%20and%20caliper%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20matching%20estimate%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20psm_ate%2C%20matched_data%20%3D%20ps_matching(T_train%2C%20Y_train%2C%20_ps_values%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method%3D'nearest'%2C%20k%3Dk%2C%20caliper%3Dcaliper)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20np.isnan(psm_ate)%20and%20matched_data%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20matching_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'PS%20Method'%3A%20_ps_method%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'k'%3A%20k%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Caliper'%3A%20caliper%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20psm_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20psm_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(psm_ate%20-%20true_ate)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Matches'%3A%20len(matched_data)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Matched%20Data'%3A%20matched_data%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Convert%20to%20DataFrame%20for%20easier%20visualization%0A%20%20%20%20matching_results_df%20%3D%20pd.DataFrame(%5B%0A%20%20%20%20%20%20%20%20%7Bk%3A%20v%20for%20k%2C%20v%20in%20result.items()%20if%20k%20!%3D%20'Matched%20Data'%7D%20for%20result%20in%20matching_results%0A%20%20%20%20%5D)%0A%0A%20%20%20%20print(%22%5CnPropensity%20Score%20Matching%20Results%3A%22)%0A%20%20%20%20print(matching_results_df.sort_values('Abs%20Bias').head())%0A%0A%20%20%20%20%23%20Find%20best%20matching%20method%0A%20%20%20%20if%20not%20matching_results_df.empty%3A%0A%20%20%20%20%20%20%20%20best_match_idx%20%3D%20matching_results_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20best_match%20%3D%20matching_results_df.loc%5Bbest_match_idx%5D%0A%20%20%20%20%20%20%20%20best_match_method%20%3D%20f%22Matching%20(%7Bbest_match%5B'PS%20Method'%5D%7D%2C%20k%3D%7Bbest_match%5B'k'%5D%7D%2C%20caliper%3D%7Bbest_match%5B'Caliper'%5D%7D)%22%0A%0A%20%20%20%20%20%20%20%20%23%20Get%20matched%20data%20for%20visualization%0A%20%20%20%20%20%20%20%20best_matched_data%20%3D%20matching_results%5Bbest_match_idx%5D%5B'Matched%20Data'%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20best_match%20%3D%20None%0A%20%20%20%20%20%20%20%20best_match_method%20%3D%20None%0A%20%20%20%20%20%20%20%20best_matched_data%20%3D%20None%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20NearestNeighbors%2C%0A%20%20%20%20%20%20%20%20best_match%2C%0A%20%20%20%20%20%20%20%20best_match_idx%2C%0A%20%20%20%20%20%20%20%20best_match_method%2C%0A%20%20%20%20%20%20%20%20best_matched_data%2C%0A%20%20%20%20%20%20%20%20caliper%2C%0A%20%20%20%20%20%20%20%20k%2C%0A%20%20%20%20%20%20%20%20matched_data%2C%0A%20%20%20%20%20%20%20%20matching_results%2C%0A%20%20%20%20%20%20%20%20matching_results_df%2C%0A%20%20%20%20%20%20%20%20ps_matching%2C%0A%20%20%20%20%20%20%20%20psm_ate%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20T_train%2C%0A%20%20%20%20Y_train%2C%0A%20%20%20%20best_ipw%2C%0A%20%20%20%20best_ipw_method%2C%0A%20%20%20%20best_match%2C%0A%20%20%20%20best_match_method%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pd%2C%0A%20%20%20%20plt%2C%0A%20%20%20%20propensity_scores%2C%0A%20%20%20%20rf_propensity_scores%2C%0A%20%20%20%20true_ate%2C%0A)%3A%0A%20%20%20%20%23%203.%20Implement%20Propensity%20Score%20Stratification%0A%0A%20%20%20%20def%20ps_stratification(T%2C%20Y%2C%20ps%2C%20n_strata%3D5)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Calculate%20ATE%20using%20propensity%20score%20stratification%22%22%22%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20DataFrame%20with%20all%20necessary%20variables%0A%20%20%20%20%20%20%20%20data%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'treatment'%3A%20T.values%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'outcome'%3A%20Y.values%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'ps'%3A%20ps%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20strata%20based%20on%20propensity%20scores%0A%20%20%20%20%20%20%20%20data%5B'stratum'%5D%20%3D%20pd.qcut(data%5B'ps'%5D%2C%20n_strata%2C%20labels%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effect%20within%20each%20stratum%0A%20%20%20%20%20%20%20%20stratum_effects%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20stratum_sizes%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20stratum_treated_counts%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20stratum_control_counts%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20for%20stratum%20in%20range(n_strata)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20stratum_data%20%3D%20data%5Bdata%5B'stratum'%5D%20%3D%3D%20stratum%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Check%20if%20both%20treated%20and%20control%20units%20exist%20in%20this%20stratum%0A%20%20%20%20%20%20%20%20%20%20%20%20treated_count%20%3D%20(stratum_data%5B'treatment'%5D%20%3D%3D%201).sum()%0A%20%20%20%20%20%20%20%20%20%20%20%20control_count%20%3D%20(stratum_data%5B'treatment'%5D%20%3D%3D%200).sum()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20treated_count%20%3E%200%20and%20control_count%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20treated_mean%20%3D%20stratum_data.loc%5Bstratum_data%5B'treatment'%5D%20%3D%3D%201%2C%20'outcome'%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20control_mean%20%3D%20stratum_data.loc%5Bstratum_data%5B'treatment'%5D%20%3D%3D%200%2C%20'outcome'%5D.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20effect%20%3D%20treated_mean%20-%20control_mean%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20effect%20and%20size%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_effects.append(effect)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_sizes.append(len(stratum_data))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_treated_counts.append(treated_count)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stratum_control_counts.append(control_count)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Stratum%20%7Bstratum%7D%20does%20not%20have%20both%20treated%20and%20control%20units.%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20weighted%20average%20of%20stratum-specific%20effects%0A%20%20%20%20%20%20%20%20if%20len(stratum_effects)%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20np.array(stratum_sizes)%20%2F%20sum(stratum_sizes)%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20sum(weights%20*%20np.array(stratum_effects))%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20stratum_effects%2C%20stratum_sizes%2C%20stratum_treated_counts%2C%20stratum_control_counts%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.nan%2C%20%5B%5D%2C%20%5B%5D%2C%20%5B%5D%2C%20%5B%5D%0A%0A%20%20%20%20%23%20Apply%20stratification%20with%20different%20propensity%20score%20models%20and%20strata%20numbers%0A%20%20%20%20strat_results%20%3D%20%5B%5D%0A%0A%20%20%20%20for%20_ps_method%2C%20_ps_values%20in%20%5B('Logistic'%2C%20propensity_scores)%2C%20('RF'%2C%20rf_propensity_scores)%5D%3A%0A%20%20%20%20%20%20%20%20for%20n_strata%20in%20%5B5%2C%2010%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20stratification%20estimate%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_ate%2C%20stratum_effects%2C%20stratum_sizes%2C%20treated_counts%2C%20control_counts%20%3D%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ps_stratification(T_train%2C%20Y_train%2C%20_ps_values%2C%20n_strata)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20np.isnan(strat_ate)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20result%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20strat_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'PS%20Method'%3A%20_ps_method%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'n_strata'%3A%20n_strata%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20strat_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20strat_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(strat_ate%20-%20true_ate)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Stratum%20Effects'%3A%20stratum_effects%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Stratum%20Sizes'%3A%20stratum_sizes%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Treated%20Counts'%3A%20treated_counts%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Control%20Counts'%3A%20control_counts%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Convert%20to%20DataFrame%20for%20easier%20visualization%0A%20%20%20%20strat_results_df%20%3D%20pd.DataFrame(%5B%0A%20%20%20%20%20%20%20%20%7Bk%3A%20v%20for%20k%2C%20v%20in%20result.items()%20if%20k%20not%20in%20%5B'Stratum%20Effects'%2C%20'Stratum%20Sizes'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Treated%20Counts'%2C%20'Control%20Counts'%5D%7D%20%0A%20%20%20%20%20%20%20%20for%20result%20in%20strat_results%0A%20%20%20%20%5D)%0A%0A%20%20%20%20print(%22%5CnPropensity%20Score%20Stratification%20Results%3A%22)%0A%20%20%20%20print(strat_results_df.sort_values('Abs%20Bias'))%0A%0A%20%20%20%20%23%20Find%20best%20stratification%20method%0A%20%20%20%20if%20not%20strat_results_df.empty%3A%0A%20%20%20%20%20%20%20%20best_strat_idx%20%3D%20strat_results_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20best_strat%20%3D%20strat_results_df.loc%5Bbest_strat_idx%5D%0A%20%20%20%20%20%20%20%20best_strat_method%20%3D%20f%22Stratification%20(%7Bbest_strat%5B'PS%20Method'%5D%7D%2C%20n_strata%3D%7Bbest_strat%5B'n_strata'%5D%7D)%22%0A%0A%20%20%20%20%20%20%20%20%23%20Extract%20details%20for%20visualization%0A%20%20%20%20%20%20%20%20best_strat_effects%20%3D%20strat_results%5Bbest_strat_idx%5D%5B'Stratum%20Effects'%5D%0A%20%20%20%20%20%20%20%20best_strat_sizes%20%3D%20strat_results%5Bbest_strat_idx%5D%5B'Stratum%20Sizes'%5D%20%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20best_strat%20%3D%20None%0A%20%20%20%20%20%20%20%20best_strat_method%20%3D%20None%0A%20%20%20%20%20%20%20%20best_strat_effects%20%3D%20None%0A%20%20%20%20%20%20%20%20best_strat_sizes%20%3D%20None%0A%0A%20%20%20%20%23%20Create%20strata%20effects%20visualization%0A%20%20%20%20if%20best_strat_effects%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20strat_fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20strata_indices%20%3D%20list(range(len(best_strat_effects)))%0A%20%20%20%20%20%20%20%20ax.bar(strata_indices%2C%20best_strat_effects%2C%20alpha%3D0.7)%0A%20%20%20%20%20%20%20%20ax.axhline(y%3Dbest_strat%5B'ATE'%5D%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'Overall%20ATE%3A%20%7Bbest_strat%5B%22ATE%22%5D%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax.axhline(y%3Dtrue_ate%2C%20color%3D'green'%2C%20linestyle%3D'%3A'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'True%20ATE%3A%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax.set_title('Treatment%20Effects%20by%20Propensity%20Score%20Stratum')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('Propensity%20Score%20Stratum%20(low%20to%20high)')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Stratum-Specific%20ATE')%0A%20%20%20%20%20%20%20%20ax.set_xticks(strata_indices)%0A%20%20%20%20%20%20%20%20ax.legend()%0A%20%20%20%20%20%20%20%20strat_plot%20%3D%20mo.mpl.interactive(strat_fig)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20strat_plot%20%3D%20None%0A%0A%20%20%20%20%23%20Compare%20all%20propensity%20score%20methods%0A%20%20%20%20ps_methods%20%3D%20%5B%5D%0A%0A%20%20%20%20%23%20Add%20best%20methods%20from%20each%20category%0A%20%20%20%20ps_methods.append(%7B%0A%20%20%20%20%20%20%20%20'Method'%3A%20best_ipw_method%2C%0A%20%20%20%20%20%20%20%20'ATE'%3A%20best_ipw%5B'ATE'%5D%2C%0A%20%20%20%20%20%20%20%20'Bias'%3A%20best_ipw%5B'Bias'%5D%2C%0A%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20best_ipw%5B'Abs%20Bias'%5D%2C%0A%20%20%20%20%20%20%20%20'Type'%3A%20'IPW'%0A%20%20%20%20%7D)%0A%0A%20%20%20%20if%20best_match%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20ps_methods.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20best_match_method%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20best_match%5B'ATE'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20best_match%5B'Bias'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20best_match%5B'Abs%20Bias'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Type'%3A%20'Matching'%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20if%20best_strat%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20ps_methods.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20best_strat_method%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20best_strat%5B'ATE'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20best_strat%5B'Bias'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20best_strat%5B'Abs%20Bias'%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Type'%3A%20'Stratification'%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%23%20Convert%20to%20DataFrame%20and%20sort%20by%20absolute%20bias%0A%20%20%20%20ps_methods_df%20%3D%20pd.DataFrame(ps_methods)%0A%20%20%20%20ps_methods_df%20%3D%20ps_methods_df.sort_values('Abs%20Bias')%0A%0A%20%20%20%20print(%22%5CnComparison%20of%20Best%20Propensity%20Score%20Methods%3A%22)%0A%20%20%20%20print(ps_methods_df)%0A%0A%20%20%20%20%23%20Create%20comparison%20visualization%0A%20%20%20%20comp_fig%2C%20comp_ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%0A%20%20%20%20%23%20Plot%20bars%0A%20%20%20%20colors%20%3D%20%7B'IPW'%3A%20'skyblue'%2C%20'Matching'%3A%20'lightgreen'%2C%20'Stratification'%3A%20'salmon'%7D%0A%20%20%20%20for%20i%2C%20(idx%2C%20row)%20in%20enumerate(ps_methods_df.iterrows())%3A%0A%20%20%20%20%20%20%20%20comp_ax.barh(i%2C%20row%5B'ATE'%5D%2C%20color%3Dcolors%5Brow%5B'Type'%5D%5D%2C%20label%3Drow%5B'Type'%5D%20if%20i%20%3D%3D%200%20else%20%22%22)%0A%0A%20%20%20%20%23%20Add%20method%20names%20and%20reference%20line%0A%20%20%20%20comp_ax.set_yticks(range(len(ps_methods_df)))%0A%20%20%20%20comp_ax.set_yticklabels(ps_methods_df%5B'Method'%5D)%0A%20%20%20%20comp_ax.axvline(x%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%0A%20%20%20%20%23%20Add%20legend%20and%20labels%0A%20%20%20%20handles%2C%20labels%20%3D%20comp_ax.get_legend_handles_labels()%0A%20%20%20%20by_label%20%3D%20dict(zip(labels%2C%20handles))%0A%20%20%20%20comp_ax.legend(by_label.values()%2C%20by_label.keys()%2C%20loc%3D'lower%20right')%0A%0A%20%20%20%20comp_ax.set_title('Comparison%20of%20Best%20Propensity%20Score%20Methods')%0A%20%20%20%20comp_ax.set_xlabel('ATE%20Estimate')%0A%20%20%20%20comp_ax.grid(True%2C%20alpha%3D0.3)%0A%0A%20%20%20%20%23%20Create%20interactive%20plot%20for%20marimo%0A%20%20%20%20comparison_plot%20%3D%20mo.mpl.interactive(comp_fig)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20ax%2C%0A%20%20%20%20%20%20%20%20best_strat%2C%0A%20%20%20%20%20%20%20%20best_strat_effects%2C%0A%20%20%20%20%20%20%20%20best_strat_idx%2C%0A%20%20%20%20%20%20%20%20best_strat_method%2C%0A%20%20%20%20%20%20%20%20best_strat_sizes%2C%0A%20%20%20%20%20%20%20%20by_label%2C%0A%20%20%20%20%20%20%20%20colors%2C%0A%20%20%20%20%20%20%20%20comp_ax%2C%0A%20%20%20%20%20%20%20%20comp_fig%2C%0A%20%20%20%20%20%20%20%20comparison_plot%2C%0A%20%20%20%20%20%20%20%20control_counts%2C%0A%20%20%20%20%20%20%20%20handles%2C%0A%20%20%20%20%20%20%20%20i%2C%0A%20%20%20%20%20%20%20%20idx%2C%0A%20%20%20%20%20%20%20%20labels%2C%0A%20%20%20%20%20%20%20%20n_strata%2C%0A%20%20%20%20%20%20%20%20ps_methods%2C%0A%20%20%20%20%20%20%20%20ps_methods_df%2C%0A%20%20%20%20%20%20%20%20ps_stratification%2C%0A%20%20%20%20%20%20%20%20row%2C%0A%20%20%20%20%20%20%20%20strat_ate%2C%0A%20%20%20%20%20%20%20%20strat_fig%2C%0A%20%20%20%20%20%20%20%20strat_plot%2C%0A%20%20%20%20%20%20%20%20strat_results%2C%0A%20%20%20%20%20%20%20%20strat_results_df%2C%0A%20%20%20%20%20%20%20%20strata_indices%2C%0A%20%20%20%20%20%20%20%20stratum_effects%2C%0A%20%20%20%20%20%20%20%20stratum_sizes%2C%0A%20%20%20%20%20%20%20%20treated_counts%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(comparison_plot%2C%20mo%2C%20ps_methods_df%2C%20strat_plot%2C%20true_ate)%3A%0A%20%20%20%20%23%20Display%20results%20of%20Propensity%20Score%20Methods%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20header%20for%20the%20section%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Comparison%20of%20Propensity%20Score%20Methods%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20explanation%20text%0A%20%20%20%20%20%20%20%20explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20We've%20implemented%20and%20compared%20three%20propensity%20score-based%20causal%20inference%20methods%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Inverse%20Probability%20Weighting%20(IPW)**%3A%20Weights%20observations%20inversely%20to%20their%20probability%20of%20receiving%20the%20treatment%20to%20create%20balance.%0A%20%20%20%20%20%20%20%202.%20**Propensity%20Score%20Matching**%3A%20Pairs%20treated%20units%20with%20similar%20control%20units%20based%20on%20propensity%20scores.%0A%20%20%20%20%20%20%20%203.%20**Propensity%20Score%20Stratification**%3A%20Divides%20the%20sample%20into%20strata%20based%20on%20propensity%20scores%20and%20calculates%20treatment%20effects%20within%20each%20stratum.%0A%0A%20%20%20%20%20%20%20%20Each%20method%20has%20different%20strengths%20and%20weaknesses.%20The%20comparison%20below%20shows%20their%20performance%20in%20estimating%20the%20Average%20Treatment%20Effect%20(ATE).%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20results%20summary%0A%20%20%20%20%20%20%20%20best_method_idx%20%3D%20ps_methods_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20best_method%20%3D%20ps_methods_df.loc%5Bbest_method_idx%5D%0A%0A%20%20%20%20%20%20%20%20summary%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**Best%20Method%3A%20%7Bbest_method%5B'Method'%5D%7D**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Estimated%20ATE%3A%20%7Bbest_method%5B'ATE'%5D%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20True%20ATE%3A%20%7Btrue_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Absolute%20Bias%3A%20%7Bbest_method%5B'Abs%20Bias'%5D%3A.4f%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20This%20analysis%20shows%20that%20propensity%20score%20methods%20can%20effectively%20reduce%20bias%20in%20causal%20estimates%20from%20observational%20data.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20table%20with%20results%0A%20%20%20%20%20%20%20%20results_table%20%3D%20mo.ui.table(ps_methods_df.reset_index(drop%3DTrue))%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20comparison%20plot%0A%20%20%20%20%20%20%20%20plot_header%20%3D%20mo.md(%22%23%23%23%23%20Visual%20Comparison%20of%20Methods%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20stratification%20plot%20if%20available%0A%20%20%20%20%20%20%20%20if%20strat_plot%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_header%20%3D%20mo.md(%22%23%23%23%23%20Treatment%20Effects%20by%20Propensity%20Score%20Stratum%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_explanation%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20This%20plot%20shows%20how%20treatment%20effects%20vary%20across%20different%20propensity%20score%20strata.%20%0A%20%20%20%20%20%20%20%20%20%20%20%20Heterogeneity%20in%20these%20effects%20may%20indicate%20effect%20modification%20by%20variables%20related%20to%20treatment%20assignment.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_section%20%3D%20mo.vstack(%5Bstrat_header%2C%20strat_explanation%2C%20strat_plot%5D)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20strat_section%20%3D%20mo.md(%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Combine%20all%20components%0A%20%20%20%20%20%20%20%20components%20%3D%20%5Bheader%2C%20explanation%2C%20summary%2C%20results_table%2C%20plot_header%2C%20comparison_plot%5D%0A%20%20%20%20%20%20%20%20if%20strat_plot%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20components.append(strat_section)%0A%0A%20%20%20%20%20%20%20%20%23%20Display%20all%20components%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(components))%0A%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%23%206.3%20Advanced%20Machine%20Learning%20Methods%20%7B%23ml-methods%7D%0A%0A%20%20%20%20%20%20%20%20%3E%20%F0%9F%9A%80%20**Step%203**%3A%20Leverage%20machine%20learning%20techniques%20for%20improved%20causal%20inference%0A%0A%20%20%20%20%20%20%20%20Finally%2C%20we'll%20explore%20advanced%20methods%20that%20combine%20machine%20learning%20with%20causal%20inference%20principles%20to%20estimate%20treatment%20effects%20more%20accurately.%20These%20methods%20can%20capture%20complex%20non-linear%20relationships%20and%20interactions%20between%20variables%20without%20requiring%20strong%20parametric%20assumptions.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%23%206.3.1%20Meta-Learners%20for%20Causal%20Inference%20%7B%23meta-learners%7D%0A%0A%20%20%20%20%20%20%20%20Meta-learners%20are%20a%20class%20of%20methods%20that%20use%20machine%20learning%20algorithms%20to%20estimate%20causal%20effects%20by%20combining%20multiple%20prediction%20models%20in%20different%20ways.%20Unlike%20traditional%20methods%2C%20meta-learners%20can%20capture%20complex%2C%20non-linear%20relationships%20between%20variables%20without%20requiring%20explicit%20parametric%20assumptions.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20s_learner_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20S-Learner%20(Single%20Model)%0A%0A%20%20%20%20%20%20%20%20The%20S-Learner%20(Single%20model)%20uses%20a%20single%20machine%20learning%20model%20with%20the%20treatment%20indicator%20included%20as%20a%20regular%20feature%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Train%20a%20model**%20to%20predict%20outcome%20using%20both%20covariates%20and%20treatment%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%24%24%5Chat%7B%5Cmu%7D(x%2C%20t)%20%3D%20E%5BY%20%7C%20X%3Dx%2C%20T%3Dt%5D%24%24%0A%0A%20%20%20%20%20%20%20%202.%20**Estimate%20treatment%20effects**%20by%20taking%20the%20difference%20in%20predictions%20for%20treated%20vs.%20untreated%3A%0A%20%20%20%20%20%20%20%20%20%20%20%24%24%5Chat%7B%5Ctau%7D(x)%20%3D%20%5Chat%7B%5Cmu%7D(x%2C%201)%20-%20%5Chat%7B%5Cmu%7D(x%2C%200)%24%24%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Simple%20to%20implement%2C%20requires%20only%20one%20model%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20May%20underestimate%20treatment%20effects%20if%20treatment%20assignment%20is%20highly%20imbalanced%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20t_learner_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20T-Learner%20(Two%20Models)%0A%0A%20%20%20%20%20%20%20%20The%20T-Learner%20(Two%20models)%20fits%20separate%20models%20for%20the%20treated%20and%20control%20groups%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Train%20two%20separate%20models**%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20Control%20model%3A%20%24%24%5Chat%7B%5Cmu%7D_0(x)%20%3D%20E%5BY%20%7C%20X%3Dx%2C%20T%3D0%5D%24%24%0A%20%20%20%20%20%20%20%20%20%20%20-%20Treatment%20model%3A%20%24%24%5Chat%7B%5Cmu%7D_1(x)%20%3D%20E%5BY%20%7C%20X%3Dx%2C%20T%3D1%5D%24%24%0A%0A%20%20%20%20%20%20%20%202.%20**Estimate%20treatment%20effects**%20by%20taking%20the%20difference%20in%20predictions%3A%0A%20%20%20%20%20%20%20%20%20%20%20%24%24%5Chat%7B%5Ctau%7D(x)%20%3D%20%5Chat%7B%5Cmu%7D_1(x)%20-%20%5Chat%7B%5Cmu%7D_0(x)%24%24%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Can%20capture%20heterogeneous%20response%20surfaces%2C%20doesn't%20impose%20shared%20structure%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20May%20suffer%20from%20high%20variance%20in%20regions%20with%20few%20samples%20from%20either%20group%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20)%0A%0A%20%20%20%20x_learner_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20X-Learner%0A%0A%20%20%20%20%20%20%20%20The%20X-Learner%20extends%20the%20T-Learner%20with%20a%20more%20sophisticated%20approach%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Train%20response%20surface%20models**%20(same%20as%20T-Learner)%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20Control%20model%3A%20%24%24%5Chat%7B%5Cmu%7D_0(x)%20%3D%20E%5BY%20%7C%20X%3Dx%2C%20T%3D0%5D%24%24%0A%20%20%20%20%20%20%20%20%20%20%20-%20Treatment%20model%3A%20%24%24%5Chat%7B%5Cmu%7D_1(x)%20%3D%20E%5BY%20%7C%20X%3Dx%2C%20T%3D1%5D%24%24%0A%0A%20%20%20%20%20%20%20%202.%20**Impute%20individual%20treatment%20effects**%20for%20each%20unit%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20For%20treated%20units%3A%20%24%24D_i%5E1%20%3D%20Y_i(1)%20-%20%5Chat%7B%5Cmu%7D_0(X_i)%24%24%0A%20%20%20%20%20%20%20%20%20%20%20-%20For%20control%20units%3A%20%24%24D_i%5E0%20%3D%20%5Chat%7B%5Cmu%7D_1(X_i)%20-%20Y_i(0)%24%24%0A%0A%20%20%20%20%20%20%20%203.%20**Train%20two%20treatment%20effect%20models**%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20Using%20treated%20units%3A%20%24%24%5Chat%7B%5Ctau%7D_1(x)%20%3D%20E%5BD_i%5E1%20%7C%20X_i%3Dx%5D%24%24%0A%20%20%20%20%20%20%20%20%20%20%20-%20Using%20control%20units%3A%20%24%24%5Chat%7B%5Ctau%7D_0(x)%20%3D%20E%5BD_i%5E0%20%7C%20X_i%3Dx%5D%24%24%0A%0A%20%20%20%20%20%20%20%204.%20**Combine%20the%20two%20estimates**%20using%20a%20weighting%20function%20g(x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%24%24%5Chat%7B%5Ctau%7D(x)%20%3D%20g(x)%5Chat%7B%5Ctau%7D_0(x)%20%2B%20(1-g(x))%5Chat%7B%5Ctau%7D_1(x)%24%24%0A%20%20%20%20%20%20%20%20%20%20%20where%20g(x)%20can%20be%20the%20propensity%20score.%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Performs%20well%20with%20heterogeneous%20treatment%20effects%20and%20imbalanced%20treatment%20groups%0A%0A%20%20%20%20%20%20%20%20**Limitations**%3A%20More%20complex%2C%20requires%20estimating%20propensity%20scores%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Stack%20all%20descriptions%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22Meta-learners%20use%20machine%20learning%20algorithms%20to%20estimate%20causal%20effects.%20Here%20are%20the%20three%20main%20types%3A%22)%2C%0A%20%20%20%20%20%20%20%20s_learner_desc%2C%0A%20%20%20%20%20%20%20%20t_learner_desc%2C%0A%20%20%20%20%20%20%20%20x_learner_desc%0A%20%20%20%20%5D)%0A%20%20%20%20return%20s_learner_desc%2C%20t_learner_desc%2C%20x_learner_desc%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20X_train_scaled%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20mo%2C%20np%2C%20pd%2C%20plt)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Import%20required%20ML%20libraries%0A%20%20%20%20%20%20%20%20from%20sklearn.ensemble%20import%20RandomForestRegressor%2C%20GradientBoostingRegressor%0A%20%20%20%20%20%20%20%20from%20sklearn.linear_model%20import%20LogisticRegression%0A%20%20%20%20%20%20%20%20from%20sklearn.metrics%20import%20mean_squared_error%0A%0A%20%20%20%20%20%20%20%20%23%20S-Learner%20implementation%0A%20%20%20%20%20%20%20%20def%20s_learner(X%2C%20T%2C%20Y%2C%20X_test%3DNone%2C%20model%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20treatment%20effects%20using%20S-Learner%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20X_test%20%3A%20DataFrame%20of%20test%20covariates%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20model%20%3A%20Fitted%20sklearn%20model%20or%20None%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3A%20Estimated%20conditional%20average%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20model%20%3A%20Fitted%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Default%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20combined%20dataset%0A%20%20%20%20%20%20%20%20%20%20%20%20X_combined%20%3D%20X.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_combined%5B'treatment'%5D%20%3D%20T%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20the%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20model.fit(X_combined%2C%20Y)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20on%20test%20set%20if%20provided%2C%20otherwise%20on%20training%20set%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20X_test%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X_test%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20counterfactual%20datasets%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_1%20%3D%20X_pred.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_1%5B'treatment'%5D%20%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_0%20%3D%20X_pred.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_0%5B'treatment'%5D%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_1%20%3D%20model.predict(X_pred_1)%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_0%20%3D%20model.predict(X_pred_0)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3D%20y_pred_1%20-%20y_pred_0%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20cate.mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20cate%2C%20model%0A%0A%20%20%20%20%20%20%20%20%23%20T-Learner%20implementation%0A%20%20%20%20%20%20%20%20def%20t_learner(X%2C%20T%2C%20Y%2C%20X_test%3DNone%2C%20model_t%3DNone%2C%20model_c%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20treatment%20effects%20using%20T-Learner%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20X_test%20%3A%20DataFrame%20of%20test%20covariates%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t%20%3A%20Sklearn%20model%20for%20treated%20group%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c%20%3A%20Sklearn%20model%20for%20control%20group%20or%20None%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3A%20Estimated%20conditional%20average%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20models%20%3A%20Tuple%20of%20(treatment_model%2C%20control_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Default%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20model_t%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_t%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20model_c%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_c%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Split%20data%20into%20treated%20and%20control%20groups%0A%20%20%20%20%20%20%20%20%20%20%20%20X_t%20%3D%20X%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_t%20%3D%20Y%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20X_c%20%3D%20X%5BT%20%3D%3D%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_c%20%3D%20Y%5BT%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t.fit(X_t%2C%20Y_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c.fit(X_c%2C%20Y_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20on%20test%20set%20if%20provided%2C%20otherwise%20on%20training%20set%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20X_test%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X_test%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_1%20%3D%20model_t.predict(X_pred)%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_0%20%3D%20model_c.predict(X_pred)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3D%20y_pred_1%20-%20y_pred_0%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20cate.mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20cate%2C%20(model_t%2C%20model_c)%0A%0A%20%20%20%20%20%20%20%20%23%20X-Learner%20implementation%0A%20%20%20%20%20%20%20%20def%20x_learner(X%2C%20T%2C%20Y%2C%20X_test%3DNone%2C%20models_t%3DNone%2C%20models_c%3DNone%2C%20propensity_model%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20treatment%20effects%20using%20X-Learner%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20X_test%20%3A%20DataFrame%20of%20test%20covariates%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20models_t%20%3A%20List%20of%20two%20Sklearn%20models%20for%20treated%20group%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20models_c%20%3A%20List%20of%20two%20Sklearn%20models%20for%20control%20group%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3A%20Sklearn%20classifier%20for%20propensity%20scores%20or%20None%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3A%20Estimated%20conditional%20average%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20models%20%3A%20Tuple%20of%20(models_t%2C%20models_c%2C%20propensity_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Default%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20models_t%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20models_t%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20models_c%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20models_c%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D44)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D45)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20propensity_model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3D%20LogisticRegression(max_iter%3D1000)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Split%20data%20into%20treated%20and%20control%20groups%0A%20%20%20%20%20%20%20%20%20%20%20%20X_t%20%3D%20X%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_t%20%3D%20Y%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20X_c%20%3D%20X%5BT%20%3D%3D%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_c%20%3D%20Y%5BT%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Step%201%3A%20Estimate%20the%20response%20surfaces%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t1%2C%20model_c1%20%3D%20models_t%5B0%5D%2C%20models_c%5B0%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t1.fit(X_t%2C%20Y_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c1.fit(X_c%2C%20Y_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20responses%20for%20all%20units%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_t%20%3D%20model_t1.predict(X)%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_c%20%3D%20model_c1.predict(X)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Step%202%3A%20Compute%20the%20imputed%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20D_t%20%3D%20Y_t.values%20-%20model_c1.predict(X_t)%20%20%23%20Imputed%20effect%20for%20treated%20units%0A%20%20%20%20%20%20%20%20%20%20%20%20D_c%20%3D%20model_t1.predict(X_c)%20-%20Y_c.values%20%20%23%20Imputed%20effect%20for%20control%20units%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Step%203%3A%20Estimate%20the%20CATE%20functions%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t2%2C%20model_c2%20%3D%20models_t%5B1%5D%2C%20models_c%5B1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t2.fit(X_t%2C%20D_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c2.fit(X_c%2C%20D_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Step%204%3A%20Combine%20the%20CATE%20functions%20using%20propensity%20scores%0A%20%20%20%20%20%20%20%20%20%20%20%20propensity_model.fit(X%2C%20T)%0A%20%20%20%20%20%20%20%20%20%20%20%20g%20%3D%20propensity_model.predict_proba(X)%5B%3A%2C%201%5D%20%20%23%20Propensity%20scores%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20on%20test%20set%20if%20provided%2C%20otherwise%20on%20training%20set%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20X_test%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X_test%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20g_pred%20%3D%20propensity_model.predict_proba(X_pred)%5B%3A%2C%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_pred%20%3D%20X%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20g_pred%20%3D%20g%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20tau_t%20%3D%20model_t2.predict(X_pred)%0A%20%20%20%20%20%20%20%20%20%20%20%20tau_c%20%3D%20model_c2.predict(X_pred)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Weighted%20average%20of%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3D%20g_pred%20*%20tau_c%20%2B%20(1%20-%20g_pred)%20*%20tau_t%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20cate.mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20cate%2C%20(models_t%2C%20models_c%2C%20propensity_model)%0A%0A%20%20%20%20%20%20%20%20%23%20Compare%20meta-learners%0A%20%20%20%20%20%20%20%20np.random.seed(42)%20%20%23%20Set%20seed%20for%20reproducibility%0A%0A%20%20%20%20%20%20%20%20%23%20Initialize%20results%20list%0A%20%20%20%20%20%20%20%20meta_learner_results%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%23%20True%20ATE%20for%20comparison%0A%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%20%20%20%20%23%20S-Learner%20with%20different%20base%20models%0A%20%20%20%20%20%20%20%20for%20model_name%2C%20model%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20('Random%20Forest'%2C%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('Gradient%20Boosting'%2C%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D42))%0A%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Train%20S-Learner%0A%20%20%20%20%20%20%20%20%20%20%20%20s_ate%2C%20s_cate%2C%20_%20%3D%20s_learner(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20model%3Dmodel)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20meta_learner_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20f'S-Learner%20(%7Bmodel_name%7D)'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20s_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20s_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(s_ate%20-%20true_ate)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20T-Learner%20with%20different%20base%20models%0A%20%20%20%20%20%20%20%20for%20model_name%2C%20model_t%2C%20model_c%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20('Random%20Forest'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('Gradient%20Boosting'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D43))%0A%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Train%20T-Learner%0A%20%20%20%20%20%20%20%20%20%20%20%20t_ate%2C%20t_cate%2C%20_%20%3D%20t_learner(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20model_t%3Dmodel_t%2C%20model_c%3Dmodel_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20meta_learner_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20f'T-Learner%20(%7Bmodel_name%7D)'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20t_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20t_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(t_ate%20-%20true_ate)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20X-Learner%20with%20different%20base%20models%0A%20%20%20%20%20%20%20%20for%20model_name%2C%20models_t%2C%20models_c%2C%20prop_model%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20('Random%20Forest'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%5BRandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%5BRandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D44)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D45)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('Gradient%20Boosting'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%5BGradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D43)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%5BGradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D44)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D45)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%0A%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Train%20X-Learner%0A%20%20%20%20%20%20%20%20%20%20%20%20x_ate%2C%20x_cate%2C%20_%20%3D%20x_learner(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20models_t%3Dmodels_t%2C%20models_c%3Dmodels_c%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%3Dprop_model)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Save%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20meta_learner_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20f'X-Learner%20(%7Bmodel_name%7D)'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20x_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20x_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(x_ate%20-%20true_ate)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Convert%20to%20DataFrame%20and%20sort%20by%20absolute%20bias%0A%20%20%20%20%20%20%20%20meta_learner_df%20%3D%20pd.DataFrame(meta_learner_results)%0A%20%20%20%20%20%20%20%20meta_learner_df%20%3D%20meta_learner_df.sort_values('Abs%20Bias')%0A%0A%20%20%20%20%20%20%20%20%23%20Compare%20meta-learners%20-%20show%20results%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Meta-Learner%20Results%22)%0A%20%20%20%20%20%20%20%20table%20%3D%20mo.ui.table(meta_learner_df)%0A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20comparison%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(12%2C%208))%0A%20%20%20%20%20%20%20%20ax.barh(y%3Dmeta_learner_df%5B'Method'%5D%2C%20width%3Dmeta_learner_df%5B'ATE'%5D%2C%20color%3D'skyblue')%0A%20%20%20%20%20%20%20%20ax.axvline(x%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax.set_title('Comparison%20of%20ATE%20Estimates%20from%20Meta-Learners')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('ATE%20Estimate')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Method')%0A%20%20%20%20%20%20%20%20ax.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20ax.legend()%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20interactive%20plot%0A%20%20%20%20%20%20%20%20plot%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20%23%20Select%20the%20best%20meta-learner%20method%0A%20%20%20%20%20%20%20%20best_ml_idx%20%3D%20meta_learner_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20best_ml%20%3D%20meta_learner_df.loc%5Bbest_ml_idx%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20summary%20of%20best%20method%0A%20%20%20%20%20%20%20%20best_method_summary%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**Best%20Meta-Learner%20Method%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Method**%3A%20%7Bbest_ml%5B'Method'%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**ATE%20Estimate**%3A%20%7Bbest_ml%5B'ATE'%5D%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**True%20ATE**%3A%20%7Btrue_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Bias**%3A%20%7Bbest_ml%5B'Bias'%5D%3A.4f%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20This%20analysis%20shows%20that%20meta-learners%20can%20provide%20accurate%20estimates%20of%20causal%20effects%20by%20leveraging%20machine%20learning%20algorithms.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20treatment%20effect%20heterogeneity%0A%20%20%20%20%20%20%20%20%23%20Get%20CATE%20estimates%20from%20X-Learner%20with%20Random%20Forest%0A%20%20%20%20%20%20%20%20_%2C%20x_cate%2C%20_%20%3D%20x_learner(%0A%20%20%20%20%20%20%20%20%20%20%20%20X_train_scaled%2C%20T_train%2C%20Y_train%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20models_t%3D%5BRandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20models_c%3D%5BRandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D44)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D45)%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%3DLogisticRegression(max_iter%3D1000)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20CATE%20distribution%0A%20%20%20%20%20%20%20%20fig2%2C%20ax2%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20ax2.hist(x_cate%2C%20bins%3D30%2C%20color%3D'skyblue'%2C%20alpha%3D0.7)%0A%20%20%20%20%20%20%20%20ax2.axvline(x%3Dx_cate.mean()%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'Mean%20CATE%20%3D%20%7Bx_cate.mean()%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax2.axvline(x%3Dtrue_ate%2C%20color%3D'green'%2C%20linestyle%3D'%3A'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax2.set_title('Distribution%20of%20Conditional%20Average%20Treatment%20Effects%20(CATE)')%0A%20%20%20%20%20%20%20%20ax2.set_xlabel('CATE')%0A%20%20%20%20%20%20%20%20ax2.set_ylabel('Frequency')%0A%20%20%20%20%20%20%20%20ax2.legend()%0A%20%20%20%20%20%20%20%20ax2.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20cate_plot%20%3D%20mo.mpl.interactive(fig2)%0A%20%20%20%20%20%20%20%20cate_explanation%20%3D%20mo.md(%22%22%22**Treatment%20Effect%20Heterogeneity**%3A%20The%20distribution%20above%20shows%20how%20treatment%20effects%20vary%20across%20different%20individuals.%20This%20variation%20suggests%20that%20the%20intervention%20may%20be%20more%20effective%20for%20some%20subgroups%20than%20others.%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%20in%20the%20output%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20best_method_summary%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Treatment%20Effect%20Heterogeneity%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20cate_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20cate_explanation%0A%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%23%206.3.2%20Doubly%20Robust%20Methods%20%7B%23doubly-robust%7D%0A%0A%20%20%20%20%20%20%20%20Doubly%20robust%20methods%20combine%20outcome%20modeling%20and%20propensity%20score%20approaches%20to%20provide%20protection%20against%20misspecification%20of%20either%20model.%20This%20%22double%20robustness%22%20property%20makes%20these%20methods%20particularly%20attractive%20for%20causal%20inference%20in%20complex%20settings.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20descriptions%20of%20doubly%20robust%20methods%0A%20%20%20%20aipw_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Augmented%20Inverse%20Probability%20Weighting%20(AIPW)%0A%0A%20%20%20%20%20%20%20%20AIPW%20combines%20outcome%20regression%20and%20IPW%20by%20using%20both%20models%20to%20create%20a%20doubly%20robust%20estimator%3A%0A%0A%20%20%20%20%20%20%20%20The%20AIPW%20estimator%20can%20be%20written%20as%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%20%5Chat%7B%5Ctau%7D_%7BAIPW%7D%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bi%3D1%7D%5En%20%5Cleft(%20%5Chat%7B%5Cmu%7D_1(X_i)%20-%20%5Chat%7B%5Cmu%7D_0(X_i)%20%2B%20%5Cfrac%7BT_i(Y_i%20-%20%5Chat%7B%5Cmu%7D_1(X_i))%7D%7B%5Chat%7Be%7D(X_i)%7D%20-%20%5Cfrac%7B(1-T_i)(Y_i%20-%20%5Chat%7B%5Cmu%7D_0(X_i))%7D%7B1-%5Chat%7Be%7D(X_i)%7D%20%5Cright)%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%3A%0A%20%20%20%20%20%20%20%20-%20%5C(%5Chat%7B%5Cmu%7D_1(X_i)%5C)%20and%20%5C(%5Chat%7B%5Cmu%7D_0(X_i)%5C)%20are%20outcome%20models%20for%20treated%20and%20control%0A%20%20%20%20%20%20%20%20-%20%5C(%5Chat%7Be%7D(X_i)%5C)%20is%20the%20propensity%20score%20model%0A%0A%20%20%20%20%20%20%20%20**Key%20property**%3A%20Consistent%20if%20*either*%20the%20outcome%20model%20*or*%20the%20propensity%20score%20model%20is%20correctly%20specified%20(not%20necessarily%20both)%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20More%20robust%20to%20model%20misspecification%2C%20often%20lower%20variance%20than%20IPW%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20dml_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Double%20Machine%20Learning%20(DML)%0A%0A%20%20%20%20%20%20%20%20DML%20addresses%20issues%20of%20regularization%20bias%20and%20overfitting%20in%20high-dimensional%20settings%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Cross-fitting%20approach**%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20Split%20the%20data%20into%20K%20folds%0A%20%20%20%20%20%20%20%20%20%20%20-%20For%20each%20fold%2C%20fit%20models%20on%20the%20other%20K-1%20folds%20and%20predict%20on%20the%20held-out%20fold%0A%20%20%20%20%20%20%20%20%20%20%20-%20This%20reduces%20the%20impact%20of%20overfitting%0A%0A%20%20%20%20%20%20%20%202.%20**Orthogonalization**%3A%0A%20%20%20%20%20%20%20%20%20%20%20-%20Remove%20the%20dependence%20between%20treatment%20and%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20-%20Remove%20the%20dependence%20between%20outcome%20and%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20-%20Study%20the%20residual%20relationship%0A%0A%20%20%20%20%20%20%20%20DML%20can%20be%20implemented%20as%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%20%5Chat%7B%5Ctau%7D_%7BDML%7D%20%3D%20%5Cfrac%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi%3D1%7D%5En%20(T_i%20-%20%5Chat%7Be%7D(X_i))(Y_i%20-%20%5Chat%7Bm%7D(X_i))%7D%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi%3D1%7D%5En%20(T_i%20-%20%5Chat%7Be%7D(X_i))%5E2%7D%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20where%20%5C(%5Chat%7Bm%7D(X_i)%5C)%20is%20a%20model%20for%20the%20outcome%20and%20%5C(%5Chat%7Be%7D(X_i)%5C)%20is%20the%20propensity%20score%20model.%0A%0A%20%20%20%20%20%20%20%20**Advantages**%3A%20Handles%20high-dimensional%20settings%20well%2C%20allows%20complex%20ML%20models%2C%20reduces%20regularization%20bias%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Stack%20all%20descriptions%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22Doubly%20robust%20methods%20offer%20protection%20against%20model%20misspecification%20by%20combining%20outcome%20modeling%20and%20propensity%20score%20approaches%3A%22)%2C%0A%20%20%20%20%20%20%20%20aipw_desc%2C%0A%20%20%20%20%20%20%20%20dml_desc%0A%20%20%20%20%5D)%0A%20%20%20%20return%20aipw_desc%2C%20dml_desc%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20X_train_scaled%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20mo%2C%20np%2C%20pd%2C%20plt)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20Import%20required%20libraries%0A%20%20%20%20%20%20%20%20from%20sklearn.ensemble%20import%20RandomForestRegressor%2C%20RandomForestClassifier%2C%20GradientBoostingRegressor%0A%20%20%20%20%20%20%20%20from%20sklearn.linear_model%20import%20LogisticRegression%0A%20%20%20%20%20%20%20%20from%20sklearn.model_selection%20import%20KFold%0A%0A%20%20%20%20%20%20%20%20%23%20Implement%20Augmented%20Inverse%20Probability%20Weighting%20(AIPW)%0A%20%20%20%20%20%20%20%20def%20doubly_robust_aipw(X%2C%20T%2C%20Y%2C%20outcome_model%3DNone%2C%20propensity_model%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20ATE%20using%20Augmented%20Inverse%20Probability%20Weighting%20(AIPW)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%20%3A%20sklearn%20regressor%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3A%20sklearn%20classifier%20or%20None%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20sklearn.base%20import%20clone%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Default%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20outcome_model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20propensity_model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3D%20LogisticRegression(max_iter%3D1000)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Split%20data%20by%20treatment%20group%0A%20%20%20%20%20%20%20%20%20%20%20%20X_t%20%3D%20X%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_t%20%3D%20Y%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20X_c%20%3D%20X%5BT%20%3D%3D%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_c%20%3D%20Y%5BT%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20outcome%20models%20for%20each%20treatment%20group%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t%20%3D%20clone(outcome_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c%20%3D%20clone(outcome_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t.fit(X_t%2C%20Y_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c.fit(X_c%2C%20Y_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%20for%20all%20units%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_1%20%3D%20model_t.predict(X)%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_0%20%3D%20model_c.predict(X)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20propensity%20score%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20ps_model%20%3D%20clone(propensity_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20ps_model.fit(X%2C%20T)%0A%20%20%20%20%20%20%20%20%20%20%20%20ps%20%3D%20ps_model.predict_proba(X)%5B%3A%2C%201%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Handle%20extreme%20propensity%20scores%0A%20%20%20%20%20%20%20%20%20%20%20%20eps%20%3D%201e-12%0A%20%20%20%20%20%20%20%20%20%20%20%20ps%20%3D%20np.maximum(eps%2C%20np.minimum(1%20-%20eps%2C%20ps))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20AIPW%20estimator%0A%20%20%20%20%20%20%20%20%20%20%20%20aipw_0%20%3D%20mu_0%20%2B%20(1%20-%20T)%20*%20(Y%20-%20mu_0)%20%2F%20(1%20-%20ps)%0A%20%20%20%20%20%20%20%20%20%20%20%20aipw_1%20%3D%20mu_1%20%2B%20T%20*%20(Y%20-%20mu_1)%20%2F%20ps%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20(aipw_1%20-%20aipw_0).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20Implement%20Double%20Machine%20Learning%20(DML)%0A%20%20%20%20%20%20%20%20def%20double_machine_learning(X%2C%20T%2C%20Y%2C%20outcome_model%3DNone%2C%20propensity_model%3DNone%2C%20n_splits%3D5)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20ATE%20using%20Double%20Machine%20Learning%20with%20cross-fitting%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%20%3A%20sklearn%20regressor%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3A%20sklearn%20classifier%20or%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20n_splits%20%3A%20int%2C%20number%20of%20folds%20for%20cross-fitting%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20sklearn.base%20import%20clone%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Default%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20outcome_model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20propensity_model%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%20%3D%20LogisticRegression(max_iter%3D1000)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Initialize%20arrays%20for%20predictions%0A%20%20%20%20%20%20%20%20%20%20%20%20n%20%3D%20len(Y)%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_hat%20%3D%20np.zeros(n)%0A%20%20%20%20%20%20%20%20%20%20%20%20T_hat%20%3D%20np.zeros(n)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Set%20up%20cross-fitting%0A%20%20%20%20%20%20%20%20%20%20%20%20kf%20%3D%20KFold(n_splits%3Dn_splits%2C%20shuffle%3DTrue%2C%20random_state%3D42)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Perform%20cross-fitting%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20train_idx%2C%20test_idx%20in%20kf.split(X)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Get%20train%20and%20test%20data%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_train%20%3D%20X.iloc%5Btrain_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_test%20%3D%20X.iloc%5Btest_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20T_train_fold%20%3D%20T.iloc%5Btrain_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20T_test%20%3D%20T.iloc%5Btest_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_train_fold%20%3D%20Y.iloc%5Btrain_idx%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20and%20predict%20with%20outcome%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20m_model%20%3D%20clone(outcome_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20m_model.fit(X_train%2C%20Y_train_fold)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y_hat%5Btest_idx%5D%20%3D%20m_model.predict(X_test)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20and%20predict%20with%20propensity%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20e_model%20%3D%20clone(propensity_model)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20e_model.fit(X_train%2C%20T_train_fold)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20T_hat%5Btest_idx%5D%20%3D%20e_model.predict_proba(X_test)%5B%3A%2C%201%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20residuals%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_resid%20%3D%20Y%20-%20Y_hat%0A%20%20%20%20%20%20%20%20%20%20%20%20T_resid%20%3D%20T%20-%20T_hat%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Estimate%20treatment%20effect%20using%20DML%20formula%0A%20%20%20%20%20%20%20%20%20%20%20%20numerator%20%3D%20np.mean(T_resid%20*%20Y_resid)%0A%20%20%20%20%20%20%20%20%20%20%20%20denominator%20%3D%20np.mean(T_resid%20*%20T)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20denominator%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Denominator%20in%20DML%20estimator%20is%20zero%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20numerator%20%2F%20denominator%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20True%20ATE%20for%20reference%0A%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%20%20%20%20%23%20Compare%20doubly%20robust%20methods%0A%20%20%20%20%20%20%20%20dr_results%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Test%20different%20model%20combinations%20for%20AIPW%0A%20%20%20%20%20%20%20%20for%20method_name%2C%20outcome_model%2C%20propensity_model%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20('AIPW%20(RF%2C%20Logistic)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('AIPW%20(GB%2C%20Logistic)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('AIPW%20(RF%2C%20RF)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestClassifier(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42))%0A%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Estimate%20ATE%20with%20AIPW%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20aipw_ate%20%3D%20doubly_robust_aipw(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%3Doutcome_model%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%3Dpropensity_model)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Store%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dr_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20method_name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20aipw_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20aipw_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(aipw_ate%20-%20true_ate)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Type'%3A%20'AIPW'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Error%20with%20%7Bmethod_name%7D%3A%20%7Be%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Test%20different%20model%20combinations%20for%20DML%0A%20%20%20%20%20%20%20%20for%20method_name%2C%20outcome_model%2C%20propensity_model%20in%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20('DML%20(RF%2C%20Logistic)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('DML%20(GB%2C%20Logistic)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20GradientBoostingRegressor(n_estimators%3D100%2C%20max_depth%3D3%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20LogisticRegression(max_iter%3D1000))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20('DML%20(RF%2C%20RF)'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20RandomForestClassifier(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42))%0A%20%20%20%20%20%20%20%20%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Estimate%20ATE%20with%20DML%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dml_ate%20%3D%20double_machine_learning(X_train_scaled%2C%20T_train%2C%20Y_train%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20outcome_model%3Doutcome_model%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20propensity_model%3Dpropensity_model)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Store%20results%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dr_results.append(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20method_name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'ATE'%3A%20dml_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Bias'%3A%20dml_ate%20-%20true_ate%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Abs%20Bias'%3A%20abs(dml_ate%20-%20true_ate)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Type'%3A%20'DML'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Error%20with%20%7Bmethod_name%7D%3A%20%7Be%7D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Convert%20to%20DataFrame%20and%20sort%20by%20absolute%20bias%0A%20%20%20%20%20%20%20%20dr_results_df%20%3D%20pd.DataFrame(dr_results)%0A%20%20%20%20%20%20%20%20dr_results_df%20%3D%20dr_results_df.sort_values('Abs%20Bias')%0A%0A%20%20%20%20%20%20%20%20%23%20Compare%20doubly%20robust%20methods%20-%20show%20results%0A%20%20%20%20%20%20%20%20header%20%3D%20mo.md(%22%23%23%23%23%20Doubly%20Robust%20Method%20Results%22)%0A%20%20%20%20%20%20%20%20table%20%3D%20mo.ui.table(dr_results_df)%0A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20comparison%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(12%2C%208))%0A%20%20%20%20%20%20%20%20ax.barh(y%3Ddr_results_df%5B'Method'%5D%2C%20width%3Ddr_results_df%5B'ATE'%5D%2C%20color%3D'skyblue')%0A%20%20%20%20%20%20%20%20ax.axvline(x%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20ax.set_title('Comparison%20of%20ATE%20Estimates%20from%20Doubly%20Robust%20Methods')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('ATE%20Estimate')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Method')%0A%20%20%20%20%20%20%20%20ax.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20ax.legend()%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20interactive%20plot%0A%20%20%20%20%20%20%20%20plot%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20%23%20Select%20the%20best%20doubly%20robust%20method%0A%20%20%20%20%20%20%20%20if%20not%20dr_results_df.empty%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20best_dr_idx%20%3D%20dr_results_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20%20%20%20%20best_dr%20%3D%20dr_results_df.loc%5Bbest_dr_idx%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20summary%20of%20best%20method%0A%20%20%20%20%20%20%20%20%20%20%20%20best_method_summary%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20**Best%20Doubly%20Robust%20Method%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**Method**%3A%20%7Bbest_dr%5B'Method'%5D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**ATE%20Estimate**%3A%20%7Bbest_dr%5B'ATE'%5D%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**True%20ATE**%3A%20%7Btrue_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**Bias**%3A%20%7Bbest_dr%5B'Bias'%5D%3A.4f%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Doubly%20robust%20methods%20provide%20protection%20against%20model%20misspecification%2C%20making%20them%20more%20robust%20for%20causal%20inference%20in%20complex%20settings.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Comparison%20of%20AIPW%20vs%20DML%0A%20%20%20%20%20%20%20%20%20%20%20%20method_comparison%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**AIPW%20vs%20DML%20Comparison**%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**AIPW**%20directly%20augments%20IPW%20with%20an%20outcome%20model%20correction%20term%2C%20providing%20a%20straightforward%20implementation%20of%20double%20robustness%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**DML**%20uses%20cross-fitting%20to%20address%20regularization%20bias%2C%20making%20it%20particularly%20well-suited%20for%20high-dimensional%20settings%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Both%20methods%20leverage%20the%20strengths%20of%20outcome%20modeling%20and%20propensity%20score%20approaches%2C%20providing%20more%20reliable%20causal%20estimates%20than%20either%20approach%20alone.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%20in%20the%20output%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20best_method_summary%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_comparison%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(mo.md(%22**Error%3A**%20No%20valid%20results%20from%20doubly%20robust%20methods.%22))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%23%206.3.3%20Causal%20Forests%20%7B%23causal-forests%7D%0A%0A%20%20%20%20%20%20%20%20Causal%20forests%20are%20a%20powerful%20extension%20of%20random%20forests%20specifically%20designed%20to%20estimate%20heterogeneous%20treatment%20effects.%20They%20are%20particularly%20useful%20for%20understanding%20how%20treatment%20effects%20vary%20across%20different%20subgroups%20and%20for%20identifying%20important%20features%20that%20modify%20treatment%20effects.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20description%20of%20causal%20forests%0A%20%20%20%20causal_forest_desc%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20mo.md(r%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Causal%20Forests%0A%0A%20%20%20%20%20%20%20%20Causal%20forests%20extend%20random%20forests%20to%20directly%20estimate%20heterogeneous%20treatment%20effects.%20The%20key%20ideas%20include%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Honest%20trees**%3A%20Split%20the%20sample%20into%20a%20training%20set%20(used%20to%20determine%20splits)%20and%20an%20estimation%20set%20(used%20to%20estimate%20treatment%20effects%20within%20leaves)%0A%0A%20%20%20%20%20%20%20%202.%20**Orthogonalization**%3A%20Remove%20the%20effect%20of%20confounders%20by%20residualizing%20the%20outcome%20and%20treatment%0A%0A%20%20%20%20%20%20%20%203.%20**Adaptive%20sample%20splitting**%3A%20Focus%20on%20regions%20with%20high%20treatment%20effect%20heterogeneity%0A%0A%20%20%20%20%20%20%20%20The%20algorithm%20builds%20many%20trees%20and%20averages%20the%20results%20to%20obtain%20the%20Conditional%20Average%20Treatment%20Effect%20(CATE)%20function%3A%0A%0A%20%20%20%20%20%20%20%20%5C%5B%20%5Chat%7B%5Ctau%7D(x)%20%3D%20E%5BY(1)%20-%20Y(0)%20%7C%20X%20%3D%20x%5D%20%5C%5D%0A%0A%20%20%20%20%20%20%20%20**Key%20advantages**%3A%0A%20%20%20%20%20%20%20%20-%20Directly%20targets%20heterogeneous%20treatment%20effects%0A%20%20%20%20%20%20%20%20-%20Provides%20measures%20of%20variable%20importance%20for%20effect%20modification%0A%20%20%20%20%20%20%20%20-%20Performs%20well%20with%20high-dimensional%20covariates%0A%20%20%20%20%20%20%20%20-%20Offers%20honest%20confidence%20intervals%0A%0A%20%20%20%20%20%20%20%20**Implementation**%3A%20Causal%20forests%20are%20available%20in%20packages%20like%20%60econml%60%20(Python)%20and%20%60grf%60%20(R)%0A%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20)%0A%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20causal_forest_desc%0A%20%20%20%20%5D)%0A%20%20%20%20return%20(causal_forest_desc%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Aasync%20def%20_(T_train%2C%20X_train_scaled%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20mo%2C%20pd%2C%20plt)%3A%0A%20%20%20%20import%20micropip%0A%20%20%20%20await%20micropip.install(%22econml%22)%0A%20%20%20%20def%20_()%3A%0A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20econml.dml%20import%20CausalForestDML%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20sklearn.linear_model%20import%20LassoCV%2C%20LogisticRegression%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Implement%20Causal%20Forest%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20causal_forest(X%2C%20T%2C%20Y%2C%20n_estimators%3D100%2C%20min_samples_leaf%3D5)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Estimate%20ATE%20and%20CATE%20using%20Causal%20Forest%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-----------%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X%20%3A%20DataFrame%20of%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20T%20%3A%20Series%20of%20treatment%20assignments%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Y%20%3A%20Series%20of%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n_estimators%20%3A%20int%2C%20Number%20of%20trees%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_samples_leaf%20%3A%20int%2C%20Minimum%20samples%20in%20leaf%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20--------%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3A%20Estimated%20average%20treatment%20effect%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3A%20Estimated%20conditional%20average%20treatment%20effects%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model%20%3A%20Fitted%20causal%20forest%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Initialize%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cf%20%3D%20CausalForestDML(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_y%3DLassoCV(cv%3D3)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_t%3DLogisticRegression(max_iter%3D1000)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n_estimators%3Dn_estimators%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_samples_leaf%3Dmin_samples_leaf%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20discrete_treatment%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20random_state%3D42%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cf.fit(Y%2C%20T%2C%20X%3DX)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20CATE%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cate%20%3D%20cf.effect(X)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20cate.mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%2C%20cate%2C%20cf%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Apply%20causal%20forest%20to%20our%20data%0A%20%20%20%20%20%20%20%20%20%20%20%20cf_ate%2C%20cf_cate%2C%20cf_model%20%3D%20causal_forest(X_train_scaled%2C%20T_train%2C%20Y_train)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20True%20ATE%20for%20reference%0A%20%20%20%20%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Results%20summary%0A%20%20%20%20%20%20%20%20%20%20%20%20results_summary%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20**Causal%20Forest%20Results%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**Estimated%20ATE**%3A%20%7Bcf_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**True%20ATE**%3A%20%7Btrue_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**Bias**%3A%20%7Bcf_ate%20-%20true_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20**Absolute%20Bias**%3A%20%7Babs(cf_ate%20-%20true_ate)%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Visualize%20CATE%20distribution%0A%20%20%20%20%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(10%2C%206))%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.hist(cf_cate%2C%20bins%3D30%2C%20color%3D'skyblue'%2C%20alpha%3D0.7)%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.axvline(x%3Dcf_cate.mean()%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'Mean%20CATE%20%3D%20%7Bcf_cate.mean()%3A.4f%7D')%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.axvline(x%3Dtrue_ate%2C%20color%3D'green'%2C%20linestyle%3D'%3A'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_title('Distribution%20of%20Causal%20Forest%20CATE%20Estimates')%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_xlabel('CATE')%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.set_ylabel('Frequency')%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.legend()%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20cate_plot%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Feature%20importance%20if%20available%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20hasattr(cf_model%2C%20'feature_importances_')%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Get%20feature%20importance%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20feature_imp%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Feature'%3A%20X_train_scaled.columns%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Importance'%3A%20cf_model.feature_importances_%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D).sort_values('Importance'%2C%20ascending%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Plot%20feature%20importance%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig2%2C%20ax2%20%3D%20plt.subplots(figsize%3D(10%2C%208))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ax2.barh(y%3Dfeature_imp%5B'Feature'%5D.head(10)%2C%20width%3Dfeature_imp%5B'Importance'%5D.head(10))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ax2.set_title('Top%2010%20Features%20for%20Treatment%20Effect%20Heterogeneity')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ax2.set_xlabel('Importance')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ax2.invert_yaxis()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ax2.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20feature_plot%20%3D%20mo.mpl.interactive(fig2)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%20in%20the%20output%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Causal%20Forest%20Results%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20results_summary%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Treatment%20Effect%20Heterogeneity%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cate_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Feature%20Importance%20for%20Effect%20Modification%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20feature_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20The%20feature%20importance%20plot%20shows%20which%20variables%20contribute%20most%20to%20treatment%20effect%20heterogeneity.%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20These%20are%20the%20features%20that%20most%20strongly%20modify%20the%20effect%20of%20treatment%2C%20and%20may%20be%20useful%20for%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20targeting%20interventions%20to%20those%20who%20would%20benefit%20most.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Output%20without%20feature%20importance%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Causal%20Forest%20Results%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20results_summary%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Treatment%20Effect%20Heterogeneity%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cate_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Causal%20forests%20directly%20estimate%20treatment%20effect%20heterogeneity%2C%20allowing%20us%20to%20see%20how%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20treatment%20effects%20vary%20across%20different%20individuals%20or%20subgroups.%20This%20variation%20suggests%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20that%20the%20intervention%20may%20be%20more%20effective%20for%20some%20subgroups%20than%20others.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D))%0A%0A%20%20%20%20%20%20%20%20except%20ImportError%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20econml%20is%20not%20available%2C%20provide%20instructions%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Causal%20Forest%20Implementation%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20**EconML%20package%20not%20available**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Causal%20Forests%20require%20the%20EconML%20package%2C%20which%20is%20not%20currently%20installed.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20To%20install%20EconML%20and%20implement%20Causal%20Forests%2C%20you%20can%20run%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60%60%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pip%20install%20econml%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60%60%60%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Causal%20forests%20are%20powerful%20for%20estimating%20heterogeneous%20treatment%20effects%20and%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20identifying%20important%20features%20that%20modify%20treatment%20effects.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%20(micropip%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%23%206.3.4%20Comparing%20All%20Advanced%20Methods%20%7B%23compare-advanced%7D%0A%0A%20%20%20%20%20%20%20%20Now%20let's%20compare%20all%20the%20advanced%20machine%20learning%20methods%20we've%20implemented%20to%20see%20which%20ones%20perform%20best%20in%20estimating%20causal%20effects%20in%20our%20dataset.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(subsection_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(T_train%2C%20X_train_scaled%2C%20Y0_train%2C%20Y1_train%2C%20Y_train%2C%20mo%2C%20np%2C%20pd%2C%20plt)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20%23%20True%20ATE%20for%20reference%0A%20%20%20%20%20%20%20%20true_ate%20%3D%20(Y1_train%20-%20Y0_train).mean()%0A%0A%20%20%20%20%20%20%20%20%23%20Collect%20results%20from%20all%20advanced%20methods%0A%20%20%20%20%20%20%20%20%23%20These%20would%20be%20calculated%20by%20previous%20cells%2C%20but%20we'll%20recreate%20them%20here%20for%20consistency%0A%20%20%20%20%20%20%20%20from%20sklearn.ensemble%20import%20RandomForestRegressor%2C%20GradientBoostingRegressor%0A%20%20%20%20%20%20%20%20from%20sklearn.linear_model%20import%20LogisticRegression%0A%0A%20%20%20%20%20%20%20%20%23%20S-Learner%20(Random%20Forest)%0A%20%20%20%20%20%20%20%20def%20s_learner_rf(X%2C%20T%2C%20Y)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20combined%20dataset%0A%20%20%20%20%20%20%20%20%20%20%20%20X_combined%20%3D%20X.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_combined%5B'treatment'%5D%20%3D%20T%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20model%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20model.fit(X_combined%2C%20Y)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20counterfactual%20datasets%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_1%20%3D%20X.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_1%5B'treatment'%5D%20%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_0%20%3D%20X.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20X_pred_0%5B'treatment'%5D%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_1%20%3D%20model.predict(X_pred_1)%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_0%20%3D%20model.predict(X_pred_0)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20(y_pred_1%20-%20y_pred_0).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20T-Learner%20(Random%20Forest)%0A%20%20%20%20%20%20%20%20def%20t_learner_rf(X%2C%20T%2C%20Y)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Split%20data%20into%20treated%20and%20control%20groups%0A%20%20%20%20%20%20%20%20%20%20%20%20X_t%20%3D%20X%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_t%20%3D%20Y%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20X_c%20%3D%20X%5BT%20%3D%3D%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_c%20%3D%20Y%5BT%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t.fit(X_t%2C%20Y_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c.fit(X_c%2C%20Y_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_1%20%3D%20model_t.predict(X)%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_0%20%3D%20model_c.predict(X)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20(y_pred_1%20-%20y_pred_0).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20Doubly%20Robust%20(AIPW%20with%20RF)%0A%20%20%20%20%20%20%20%20def%20aipw_rf(X%2C%20T%2C%20Y)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Split%20data%20by%20treatment%20group%0A%20%20%20%20%20%20%20%20%20%20%20%20X_t%20%3D%20X%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_t%20%3D%20Y%5BT%20%3D%3D%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20X_c%20%3D%20X%5BT%20%3D%3D%200%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Y_c%20%3D%20Y%5BT%20%3D%3D%200%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20outcome%20models%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D42)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c%20%3D%20RandomForestRegressor(n_estimators%3D100%2C%20min_samples_leaf%3D5%2C%20random_state%3D43)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_t.fit(X_t%2C%20Y_t)%0A%20%20%20%20%20%20%20%20%20%20%20%20model_c.fit(X_c%2C%20Y_c)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Predict%20potential%20outcomes%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_1%20%3D%20model_t.predict(X)%0A%20%20%20%20%20%20%20%20%20%20%20%20mu_0%20%3D%20model_c.predict(X)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fit%20propensity%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20ps_model%20%3D%20LogisticRegression(max_iter%3D1000)%0A%20%20%20%20%20%20%20%20%20%20%20%20ps_model.fit(X%2C%20T)%0A%20%20%20%20%20%20%20%20%20%20%20%20ps%20%3D%20ps_model.predict_proba(X)%5B%3A%2C%201%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Handle%20extreme%20propensity%20scores%0A%20%20%20%20%20%20%20%20%20%20%20%20eps%20%3D%201e-12%0A%20%20%20%20%20%20%20%20%20%20%20%20ps%20%3D%20np.maximum(eps%2C%20np.minimum(1%20-%20eps%2C%20ps))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20AIPW%20estimator%0A%20%20%20%20%20%20%20%20%20%20%20%20aipw_0%20%3D%20mu_0%20%2B%20(1%20-%20T)%20*%20(Y%20-%20mu_0)%20%2F%20(1%20-%20ps)%0A%20%20%20%20%20%20%20%20%20%20%20%20aipw_1%20%3D%20mu_1%20%2B%20T%20*%20(Y%20-%20mu_1)%20%2F%20ps%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20ATE%0A%20%20%20%20%20%20%20%20%20%20%20%20ate%20%3D%20(aipw_1%20-%20aipw_0).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20ate%0A%0A%20%20%20%20%20%20%20%20%23%20Try%20to%20calculate%20Causal%20Forest%20ATE%20if%20available%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20econml.dml%20import%20CausalForestDML%0A%20%20%20%20%20%20%20%20%20%20%20%20from%20sklearn.linear_model%20import%20LassoCV%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Initialize%20and%20fit%20model%0A%20%20%20%20%20%20%20%20%20%20%20%20cf%20%3D%20CausalForestDML(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_y%3DLassoCV(cv%3D3)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20model_t%3DLogisticRegression(max_iter%3D1000)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n_estimators%3D100%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_samples_leaf%3D5%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20discrete_treatment%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20random_state%3D42%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20cf.fit(Y_train%2C%20T_train%2C%20X%3DX_train_scaled)%0A%20%20%20%20%20%20%20%20%20%20%20%20cf_ate%20%3D%20cf.effect(X_train_scaled).mean()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20include_cf%20%3D%20True%0A%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20include_cf%20%3D%20False%0A%0A%20%20%20%20%20%20%20%20%23%20Compute%20ATEs%0A%20%20%20%20%20%20%20%20sl_ate%20%3D%20s_learner_rf(X_train_scaled%2C%20T_train%2C%20Y_train)%0A%20%20%20%20%20%20%20%20tl_ate%20%3D%20t_learner_rf(X_train_scaled%2C%20T_train%2C%20Y_train)%0A%20%20%20%20%20%20%20%20aipw_ate%20%3D%20aipw_rf(X_train_scaled%2C%20T_train%2C%20Y_train)%0A%0A%20%20%20%20%20%20%20%20%23%20Compile%20results%0A%20%20%20%20%20%20%20%20results%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B'Method'%3A%20'S-Learner%20(RF)'%2C%20'ATE'%3A%20sl_ate%2C%20'Bias'%3A%20sl_ate%20-%20true_ate%2C%20'Abs%20Bias'%3A%20abs(sl_ate%20-%20true_ate)%2C%20'Type'%3A%20'Meta-Learner'%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B'Method'%3A%20'T-Learner%20(RF)'%2C%20'ATE'%3A%20tl_ate%2C%20'Bias'%3A%20tl_ate%20-%20true_ate%2C%20'Abs%20Bias'%3A%20abs(tl_ate%20-%20true_ate)%2C%20'Type'%3A%20'Meta-Learner'%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B'Method'%3A%20'AIPW%20(RF%2C%20Logistic)'%2C%20'ATE'%3A%20aipw_ate%2C%20'Bias'%3A%20aipw_ate%20-%20true_ate%2C%20'Abs%20Bias'%3A%20abs(aipw_ate%20-%20true_ate)%2C%20'Type'%3A%20'Doubly%20Robust'%7D%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20Causal%20Forest%20if%20available%0A%20%20%20%20%20%20%20%20if%20include_cf%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20results.append(%7B'Method'%3A%20'Causal%20Forest'%2C%20'ATE'%3A%20cf_ate%2C%20'Bias'%3A%20cf_ate%20-%20true_ate%2C%20'Abs%20Bias'%3A%20abs(cf_ate%20-%20true_ate)%2C%20'Type'%3A%20'Causal%20Forest'%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Convert%20to%20DataFrame%20and%20sort%20by%20absolute%20bias%0A%20%20%20%20%20%20%20%20results_df%20%3D%20pd.DataFrame(results)%0A%20%20%20%20%20%20%20%20results_df%20%3D%20results_df.sort_values('Abs%20Bias')%0A%0A%20%20%20%20%20%20%20%20%23%20Visualize%20comparison%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(12%2C%208))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20with%20colors%20by%20method%20type%0A%20%20%20%20%20%20%20%20colors%20%3D%20%7B'Meta-Learner'%3A%20'skyblue'%2C%20'Doubly%20Robust'%3A%20'lightgreen'%2C%20'Causal%20Forest'%3A%20'salmon'%7D%0A%0A%20%20%20%20%20%20%20%20for%20i%2C%20(_%2C%20row)%20in%20enumerate(results_df.iterrows())%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.barh(i%2C%20row%5B'ATE'%5D%2C%20color%3Dcolors%5Brow%5B'Type'%5D%5D%2C%20label%3Drow%5B'Type'%5D%20if%20row%5B'Type'%5D%20not%20in%20ax.get_legend_handles_labels()%5B1%5D%20else%20%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20method%20names%20and%20reference%20line%0A%20%20%20%20%20%20%20%20ax.set_yticks(range(len(results_df)))%0A%20%20%20%20%20%20%20%20ax.set_yticklabels(results_df%5B'Method'%5D)%0A%20%20%20%20%20%20%20%20ax.axvline(x%3Dtrue_ate%2C%20color%3D'red'%2C%20linestyle%3D'--'%2C%20label%3Df'True%20ATE%20%3D%20%7Btrue_ate%3A.4f%7D')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20legend%20and%20labels%0A%20%20%20%20%20%20%20%20handles%2C%20labels%20%3D%20ax.get_legend_handles_labels()%0A%20%20%20%20%20%20%20%20unique_labels%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20unique_handles%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20handle%2C%20label%20in%20zip(handles%2C%20labels)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20label%20not%20in%20unique_labels%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unique_labels.append(label)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unique_handles.append(handle)%0A%0A%20%20%20%20%20%20%20%20ax.legend(unique_handles%2C%20unique_labels%2C%20loc%3D'lower%20right')%0A%0A%20%20%20%20%20%20%20%20ax.set_title('Comparison%20of%20Advanced%20Machine%20Learning%20Methods%20for%20Causal%20Inference')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('ATE%20Estimate')%0A%20%20%20%20%20%20%20%20ax.grid(True%2C%20alpha%3D0.3)%0A%20%20%20%20%20%20%20%20plt.tight_layout()%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20interactive%20plot%0A%20%20%20%20%20%20%20%20plot%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20%23%20Best%20method%20summary%0A%20%20%20%20%20%20%20%20best_method_idx%20%3D%20results_df%5B'Abs%20Bias'%5D.idxmin()%0A%20%20%20%20%20%20%20%20best_method%20%3D%20results_df.loc%5Bbest_method_idx%5D%0A%0A%20%20%20%20%20%20%20%20best_method_summary%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20**Best%20Advanced%20Method%3A%20%7Bbest_method%5B'Method'%5D%7D**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**ATE%20Estimate**%3A%20%7Bbest_method%5B'ATE'%5D%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**True%20ATE**%3A%20%7Btrue_ate%3A.4f%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20**Bias**%3A%20%7Bbest_method%5B'Bias'%5D%3A.4f%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Advanced%20machine%20learning%20methods%20can%20significantly%20improve%20causal%20estimates%20by%20capturing%20complex%20relationships%20%0A%20%20%20%20%20%20%20%20%20%20%20%20between%20variables%20without%20requiring%20strong%20parametric%20assumptions.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Method%20comparison%20and%20analysis%0A%20%20%20%20%20%20%20%20method_analysis%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20**Analysis%20of%20Advanced%20Methods**%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Meta-Learners**%20leverage%20flexible%20machine%20learning%20algorithms%20to%20model%20outcomes%20or%20treatment%20effects.%20%0A%20%20%20%20%20%20%20%20%20%20%20They%20work%20well%20when%20relationships%20are%20complex%20but%20depend%20heavily%20on%20the%20choice%20of%20base%20learner.%0A%0A%20%20%20%20%20%20%20%202.%20**Doubly%20Robust%20Methods**%20combine%20outcome%20modeling%20and%20propensity%20score%20approaches%2C%20providing%20protection%20%0A%20%20%20%20%20%20%20%20%20%20%20against%20model%20misspecification.%20They%20tend%20to%20have%20lower%20bias%20and%20are%20more%20robust%20to%20model%20choice.%0A%0A%20%20%20%20%20%20%20%203.%20**Causal%20Forests**%20excel%20at%20capturing%20treatment%20effect%20heterogeneity%20and%20provide%20valuable%20insights%20through%20%0A%20%20%20%20%20%20%20%20%20%20%20feature%20importance.%20They're%20particularly%20useful%20for%20understanding%20which%20subgroups%20benefit%20most%20from%20treatment.%0A%0A%20%20%20%20%20%20%20%20The%20best%20method%20depends%20on%20the%20specific%20context%2C%20data%20structure%2C%20and%20research%20question.%20In%20practice%2C%20%0A%20%20%20%20%20%20%20%20it's%20valuable%20to%20implement%20multiple%20methods%20and%20compare%20their%20results%2C%20as%20we've%20done%20here.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Combine%20all%20elements%20in%20the%20output%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%23%20Comparison%20of%20Advanced%20Machine%20Learning%20Methods%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20best_method_summary%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20method_analysis%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(results_df)%0A%20%20%20%20%20%20%20%20%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20section_header%20%3D%20mo.md(%22%22%22%23%23%208.%20Conclusion%20and%20Best%20Practices%20%7B%23conclusion%7D%22%22%22)%0A%20%20%20%20%20%20%20%20mo.output.replace(section_header)%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%208.1%20Summary%20of%20Findings%20%7B%23summary-findings%7D%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20summary%20of%20key%20findings%20from%20the%20causal%20analysis%0A%20%20%20%20%20%20%20%20key_findings%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Key%20Insights%20from%20Causal%20Analysis%0A%0A%20%20%20%20%20%20%20%20%20%20%20%201.%20**Treatment%20Effect%20Size**%3A%20The%20IHDP%20intervention%20has%20a%20substantial%20positive%20effect%20on%20cognitive%20scores%20with%20an%20average%20treatment%20effect%20(ATE)%20of%20approximately%204.0.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%202.%20**Selection%20Bias**%3A%20The%20semi-synthetic%20IHDP%20dataset%20exhibits%20moderate%20selection%20bias%2C%20as%20evidenced%20by%20the%20small%20difference%20between%20naive%20estimators%20and%20true%20effects.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%203.%20**Method%20Performance**%3A%20Advanced%20ML%20methods%2C%20particularly%20the%20S-Learner%20with%20Random%20Forest%2C%20achieved%20the%20lowest%20bias%20(0.004)%20among%20all%20approaches%2C%20demonstrating%20the%20value%20of%20flexible%20machine%20learning%20in%20causal%20inference.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%204.%20**Treatment%20Effect%20Heterogeneity**%3A%20All%20methods%20revealed%20variation%20in%20treatment%20effects%20across%20subgroups%2C%20suggesting%20that%20the%20intervention%20effectiveness%20differs%20based%20on%20individual%20characteristics.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%205.%20**Important%20Modifiers**%3A%20Causal%20forest%20analysis%20identified%20first-born%20status%20(x_5)%2C%20birth%20weight%20(x_0)%2C%20and%20mother's%20education%20level%20(x_4)%20as%20the%20most%20important%20variables%20influencing%20treatment%20effect%20heterogeneity.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20summary%20of%20methodological%20takeaways%0A%20%20%20%20%20%20%20%20method_takeaways%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Methodological%20Takeaways%0A%0A%20%20%20%20%20%20%20%20%20%20%20%201.%20**Method%20Progression**%3A%20Starting%20with%20simple%20methods%20provided%20valuable%20baselines%2C%20while%20propensity%20score%20methods%20offered%20intuitive%20adjustments%20for%20confounding%2C%20and%20advanced%20ML%20methods%20captured%20complex%20relationships.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%202.%20**Propensity%20Score%20Considerations**%3A%20The%20logistic%20regression%20model%20provided%20better%20common%20support%20(89%25%20vs.%2061%25)%20than%20the%20random%20forest%20model%2C%20despite%20the%20latter's%20superior%20AUC%20(0.91%20vs.%200.75)%2C%20highlighting%20that%20discriminative%20performance%20isn't%20the%20primary%20goal%20in%20propensity%20score%20estimation.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%203.%20**Doubly%20Robust%20Advantage**%3A%20AIPW%20methods%20demonstrated%20strong%20performance%20with%20very%20low%20bias%2C%20confirming%20the%20theoretical%20advantage%20of%20protection%20against%20model%20misspecification.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%204.%20**Treatment%20Effect%20Heterogeneity**%3A%20Methods%20capable%20of%20estimating%20CATE%20(Conditional%20Average%20Treatment%20Effect)%20provided%20richer%20insights%20than%20those%20focused%20solely%20on%20ATE%2C%20revealing%20important%20patterns%20in%20effect%20variation%20across%20subgroups.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%205.%20**Model%20Selection%20Importance**%3A%20The%20choice%20of%20base%20learner%20in%20meta-learners%20and%20specification%20choices%20in%20propensity%20score%20methods%20substantively%20affected%20estimation%20quality%2C%20emphasizing%20the%20importance%20of%20comparing%20multiple%20approaches.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bsubsection_header%2C%20key_findings%2C%20method_takeaways%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%208.2%20Recommendations%20%7B%23recommendations%7D%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20guidelines%20for%20method%20selection%0A%20%20%20%20%20%20%20%20method_guidelines%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Guidelines%20for%20Method%20Selection%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Simple%20Methods**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Use%20**Regression%20Adjustment**%20when%20relationships%20appear%20linear%20and%20interpretability%20is%20a%20priority%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Apply%20**Stratification**%20to%20examine%20treatment%20effect%20heterogeneity%20across%20specific%20covariates%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Employ%20**Naive%20Mean%20Difference**%20only%20as%20a%20baseline%20for%20comparison%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Propensity%20Score%20Methods**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Choose%20**Matching**%20when%20intuitive%20explanation%20is%20important%20and%20preserving%20original%20outcome%20scale%20is%20desired%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Use%20**IPW**%20when%20using%20all%20available%20data%20is%20critical%20and%20propensity%20scores%20are%20well-estimated%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Apply%20**Stratification**%20to%20examine%20effect%20modification%20across%20propensity%20score%20strata%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Advanced%20ML%20Methods**%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Implement%20**S-Learner**%20when%20simplicity%20and%20a%20single%20model%20are%20preferred%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Choose%20**T-Learner**%20when%20treatment%20and%20control%20groups%20may%20have%20very%20different%20outcome%20relationships%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Use%20**Doubly%20Robust%20Methods**%20when%20robustness%20to%20model%20misspecification%20is%20critical%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20Apply%20**Causal%20Forests**%20when%20treatment%20effect%20heterogeneity%20is%20the%20primary%20focus%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20practical%20considerations%0A%20%20%20%20%20%20%20%20practical_considerations%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Practical%20Considerations%0A%0A%20%20%20%20%20%20%20%20%20%20%20%201.%20**Data%20Quality%20Assessment**%3A%20Before%20applying%20causal%20methods%2C%20carefully%20examine%20data%20for%20missing%20values%2C%20outliers%2C%20and%20covariate%20balance%20between%20treatment%20groups.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%202.%20**Positivity%2FOverlap%20Check**%3A%20Verify%20sufficient%20overlap%20in%20propensity%20scores%20between%20treated%20and%20control%20units%20to%20ensure%20reliable%20causal%20inference.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%203.%20**Multiple%20Method%20Comparison**%3A%20Implement%20several%20causal%20methods%20and%20compare%20results%3B%20consistent%20estimates%20across%20methods%20increase%20confidence%20in%20findings.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%204.%20**Sensitivity%20Analysis**%3A%20When%20working%20with%20real%20observational%20data%20(unlike%20our%20semi-synthetic%20case)%2C%20conduct%20sensitivity%20analysis%20to%20assess%20robustness%20to%20unmeasured%20confounding.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%205.%20**Focused%20Heterogeneity%20Analysis**%3A%20Based%20on%20domain%20knowledge%2C%20identify%20key%20variables%20likely%20to%20modify%20treatment%20effects%20and%20deliberately%20examine%20heterogeneity%20across%20these%20dimensions.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%206.%20**Interpretability%20Needs**%3A%20Consider%20the%20audience%20and%20purpose%20when%20selecting%20methods%3B%20simpler%20methods%20may%20be%20preferred%20when%20communication%20to%20non-technical%20stakeholders%20is%20important.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22warn%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20limitations%20and%20caveats%0A%20%20%20%20%20%20%20%20limitations%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%23%23%20Limitations%20and%20Caveats%0A%0A%20%20%20%20%20%20%20%20%20%20%20%201.%20**Untestable%20Assumptions**%3A%20Remember%20that%20unconfoundedness%2Fignorability%20cannot%20be%20directly%20verified%20from%20observed%20data%3B%20domain%20knowledge%20is%20essential%20for%20justifying%20this%20assumption.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%202.%20**Semi-Synthetic%20Nature**%3A%20Our%20IHDP%20dataset%20is%20semi-synthetic%2C%20allowing%20us%20to%20know%20true%20effects%3B%20in%20real%20applications%2C%20ground%20truth%20is%20unknown%20and%20evaluation%20is%20more%20challenging.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%203.%20**External%20Validity**%3A%20Causal%20effects%20estimated%20from%20a%20specific%20population%20may%20not%20generalize%20to%20different%20populations%20with%20different%20covariate%20distributions.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%204.%20**Extreme%20Propensity%20Scores**%3A%20Units%20with%20very%20high%20or%20low%20propensity%20scores%20can%20lead%20to%20unstable%20estimates%20in%20methods%20like%20IPW%3B%20trimming%20or%20stabilization%20should%20be%20considered.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%205.%20**Computational%20Requirements**%3A%20Advanced%20ML%20methods%20offer%20improved%20performance%20but%20at%20the%20cost%20of%20greater%20computational%20complexity%20and%20reduced%20interpretability.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%206.%20**Target%20Estimand%20Clarity**%3A%20Different%20methods%20may%20target%20different%20estimands%20(ATE%2C%20ATT%2C%20CATE)%3B%20ensure%20the%20chosen%20methods%20align%20with%20the%20specific%20causal%20question%20of%20interest.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22danger%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bsubsection_header%2C%20method_guidelines%2C%20practical_considerations%2C%20limitations%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Create%20a%20final%20summary%20visualization%20showing%20method%20performance%20across%20categories%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20%20%20%20%20import%20pandas%20as%20pd%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20data%20for%20the%20visualization%0A%20%20%20%20%20%20%20%20methods%20%3D%20%5B'Naive%20Mean%20Difference'%2C%20'Regression%20Adjustment'%2C%20'Stratification'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'IPW'%2C%20'Matching'%2C%20'S-Learner%20(RF)'%2C%20'AIPW'%2C%20'Causal%20Forest'%5D%0A%0A%20%20%20%20%20%20%20%20%23%20These%20are%20example%20values%20-%20you%20would%20replace%20with%20your%20actual%20results%0A%20%20%20%20%20%20%20%20bias%20%3D%20%5B0.067%2C%200.010%2C%200.085%2C%200.036%2C%200.026%2C%200.004%2C%200.017%2C%200.129%5D%0A%0A%20%20%20%20%20%20%20%20categories%20%3D%20%5B'Simple'%2C%20'Simple'%2C%20'Simple'%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Propensity%20Score'%2C%20'Propensity%20Score'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'Advanced%20ML'%2C%20'Advanced%20ML'%2C%20'Advanced%20ML'%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20DataFrame%20for%20plotting%0A%20%20%20%20%20%20%20%20plot_data%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20'Method'%3A%20methods%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Absolute%20Bias'%3A%20bias%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'Category'%3A%20categories%0A%20%20%20%20%20%20%20%20%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Sort%20by%20absolute%20bias%0A%20%20%20%20%20%20%20%20plot_data%20%3D%20plot_data.sort_values('Absolute%20Bias')%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20color%20mapping%20for%20categories%0A%20%20%20%20%20%20%20%20colors%20%3D%20%7B'Simple'%3A%20'skyblue'%2C%20'Propensity%20Score'%3A%20'lightgreen'%2C%20'Advanced%20ML'%3A%20'salmon'%7D%0A%20%20%20%20%20%20%20%20bar_colors%20%3D%20%5Bcolors%5Bcat%5D%20for%20cat%20in%20plot_data%5B'Category'%5D%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20the%20plot%0A%20%20%20%20%20%20%20%20fig%2C%20ax%20%3D%20plt.subplots(figsize%3D(12%2C%208))%0A%0A%20%20%20%20%20%20%20%20%23%20Plot%20horizontal%20bars%0A%20%20%20%20%20%20%20%20bars%20%3D%20ax.barh(plot_data%5B'Method'%5D%2C%20plot_data%5B'Absolute%20Bias'%5D%2C%20color%3Dbar_colors)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20a%20vertical%20line%20for%20reference%0A%20%20%20%20%20%20%20%20ax.axvline(x%3D0.05%2C%20color%3D'gray'%2C%20linestyle%3D'--'%2C%20alpha%3D0.7%2C%20label%3D'5%25%20Bias%20Threshold')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20labels%20and%20title%0A%20%20%20%20%20%20%20%20ax.set_title('Comparison%20of%20All%20Causal%20Inference%20Methods%20by%20Absolute%20Bias')%0A%20%20%20%20%20%20%20%20ax.set_xlabel('Absolute%20Bias')%0A%20%20%20%20%20%20%20%20ax.set_ylabel('Method')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20text%20labels%20to%20the%20bars%0A%20%20%20%20%20%20%20%20for%20bar%20in%20bars%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20width%20%3D%20bar.get_width()%0A%20%20%20%20%20%20%20%20%20%20%20%20ax.text(width%20%2B%200.005%2C%20bar.get_y()%20%2B%20bar.get_height()%2F2%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%7Bwidth%3A.4f%7D'%2C%20ha%3D'left'%2C%20va%3D'center')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20a%20legend%20for%20categories%0A%20%20%20%20%20%20%20%20from%20matplotlib.patches%20import%20Patch%0A%20%20%20%20%20%20%20%20legend_elements%20%3D%20%5BPatch(facecolor%3Dcolors%5Bcat%5D%2C%20label%3Dcat)%20for%20cat%20in%20colors.keys()%5D%0A%20%20%20%20%20%20%20%20ax.legend(handles%3Dlegend_elements%2C%20loc%3D'lower%20right')%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20grid%20lines%20for%20better%20readability%0A%20%20%20%20%20%20%20%20ax.grid(axis%3D'x'%2C%20alpha%3D0.3)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20conclusions%20based%20on%20the%20visual%0A%20%20%20%20%20%20%20%20conclusions%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%20Final%20Insights%0A%0A%20%20%20%20%20%20%20%20This%20comparative%20analysis%20across%20all%20implemented%20methods%20reveals%20several%20key%20patterns%3A%0A%0A%20%20%20%20%20%20%20%201.%20**Method%20Sophistication%20vs.%20Performance**%3A%20While%20advanced%20ML%20methods%20generally%20perform%20well%2C%20certain%20simpler%20methods%20(like%20Regression%20Adjustment)%20can%20achieve%20comparable%20results%20when%20relationships%20are%20approximately%20linear.%0A%0A%20%20%20%20%20%20%20%202.%20**Low%20Selection%20Bias%20Impact**%3A%20The%20relatively%20small%20bias%20of%20even%20the%20naive%20method%20suggests%20moderate%20selection%20bias%20in%20this%20dataset%2C%20which%20explains%20why%20even%20simple%20methods%20can%20perform%20adequately.%0A%0A%20%20%20%20%20%20%20%203.%20**Heterogeneity%20Insights%20Matter**%3A%20Beyond%20just%20bias%20reduction%2C%20methods%20like%20Causal%20Forests%20provide%20valuable%20insights%20into%20effect%20heterogeneity%20that%20can%20guide%20targeted%20interventions.%0A%0A%20%20%20%20%20%20%20%204.%20**Method%20Selection%20Considerations**%3A%20The%20%22best%22%20method%20depends%20on%20the%20specific%20context%2C%20goals%2C%20and%20constraints.%20Factors%20like%20interpretability%2C%20computational%20complexity%2C%20and%20the%20specific%20causal%20questions%20should%20guide%20method%20selection.%0A%0A%20%20%20%20%20%20%20%205.%20**Multiple%20Methods%20Approach**%3A%20Using%20multiple%20methods%20and%20comparing%20results%20provides%20more%20robust%20and%20trustworthy%20causal%20insights%20than%20relying%20on%20any%20single%20method.%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Create%20the%20final%20layout%0A%20%20%20%20%20%20%20%20final_header%20%3D%20mo.md(%22%23%23%23%20Comprehensive%20Method%20Performance%22)%0A%20%20%20%20%20%20%20%20plot%20%3D%20mo.mpl.interactive(fig)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bfinal_header%2C%20plot%2C%20conclusions%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20subsection_header%20%3D%20mo.md(%22%22%22%23%23%23%208.4%20Resources%20and%20References%20%7B%23resources%7D%22%22%22)%0A%0A%20%20%20%20%20%20%20%20references%20%3D%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Key%20Books%0A%0A%20%20%20%20%20%20%20%201.%20Pearl%2C%20J.%20(2009).%20**Causality%3A%20Models%2C%20Reasoning%2C%20and%20Inference**%20(2nd%20ed.).%20Cambridge%20University%20Press.%20%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.cambridge.org%2Fcore%2Fbooks%2Fcausality%2FB0046844FAE10CBF274D4ACBDAEB5F5B%5D(https%3A%2F%2Fwww.cambridge.org%2Fcore%2Fbooks%2Fcausality%2FB0046844FAE10CBF274D4ACBDAEB5F5B)%0A%0A%20%20%20%20%20%20%20%202.%20Hern%C3%A1n%2C%20M.%20A.%2C%20%26%20Robins%2C%20J.%20M.%20(2020).%20**Causal%20Inference%3A%20What%20If**.%20Chapman%20%26%20Hall%2FCRC.%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.hsph.harvard.edu%2Fmiguel-hernan%2Fcausal-inference-book%2F%5D(https%3A%2F%2Fwww.hsph.harvard.edu%2Fmiguel-hernan%2Fcausal-inference-book%2F)%0A%0A%20%20%20%20%20%20%20%203.%20Peters%2C%20J.%2C%20Janzing%2C%20D.%2C%20%26%20Sch%C3%B6lkopf%2C%20B.%20(2017).%20**Elements%20of%20Causal%20Inference%3A%20Foundations%20and%20Learning%20Algorithms**.%20MIT%20Press.%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Flibrary.oapen.org%2Fbitstream%2Fid%2F056a11be-ce3a-44b9-8987-a6c68fce8d9b%2F11283.pdf%5D(https%3A%2F%2Flibrary.oapen.org%2Fbitstream%2Fid%2F056a11be-ce3a-44b9-8987-a6c68fce8d9b%2F11283.pdf)%0A%0A%20%20%20%20%20%20%20%204.%20Imbens%2C%20G.%20W.%2C%20%26%20Rubin%2C%20D.%20B.%20(2015).%20**Causal%20Inference%20for%20Statistics%2C%20Social%2C%20and%20Biomedical%20Sciences**.%20Cambridge%20University%20Press.%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.cambridge.org%2Fcore%2Fbooks%2Fcausal-inference-for-statistics-social-and-biomedical-sciences%2F71126BE90C58F1A431FE9B2DD07938AB%5D(https%3A%2F%2Fwww.cambridge.org%2Fcore%2Fbooks%2Fcausal-inference-for-statistics-social-and-biomedical-sciences%2F71126BE90C58F1A431FE9B2DD07938AB)%0A%0A%20%20%20%20%20%20%20%205.%20Cunningham%2C%20S.%20(2021).%20**Causal%20Inference%3A%20The%20Mixtape**.%20Yale%20University%20Press.%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fmixtape.scunning.com%2F%5D(https%3A%2F%2Fmixtape.scunning.com%2F)%0A%0A%20%20%20%20%20%20%20%206.%20Chernozhukov%2C%20V.%2C%20et%20al.%20(2023).%20**Applied%20Causal%20Inference%20Powered%20by%20ML%20and%20AI**.%20%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.artsci.com%2Facipma%5D(https%3A%2F%2Fwww.artsci.com%2Facipma)%0A%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Research%20Articles%20and%20Papers%0A%0A%20%20%20%20%20%20%20%207.%20Zanga%2C%20A.%2C%20Ozkirimli%2C%20E.%2C%20%26%20Stella%2C%20F.%20(2022).%20**A%20Survey%20on%20Causal%20Discovery%3A%20Theory%20and%20Practice**.%20International%20Journal%20of%20Approximate%20Reasoning.%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.sciencedirect.com%2Fscience%2Farticle%2Fabs%2Fpii%2FS0888613X22001402%5D(https%3A%2F%2Fwww.sciencedirect.com%2Fscience%2Farticle%2Fabs%2Fpii%2FS0888613X22001402)%0A%0A%20%20%20%20%20%20%20%208.%20Pearl%2C%20J.%20(2010).%20**An%20Introduction%20to%20Causal%20Inference**.%20The%20International%20Journal%20of%20Biostatistics%2C%206(2).%0A%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.ncbi.nlm.nih.gov%2Fpmc%2Farticles%2FPMC2836213%2F%5D(https%3A%2F%2Fwww.ncbi.nlm.nih.gov%2Fpmc%2Farticles%2FPMC2836213%2F)%0A%0A%20%20%20%20%20%20%20%209.%20Bongers%2C%20S.%2C%20Forr%C3%A9%2C%20P.%2C%20Peters%2C%20J.%2C%20%26%20Mooij%2C%20J.%20M.%20(2021).%20**Foundations%20of%20structural%20causal%20models%20with%20cycles%20and%20latent%20variables**.%20The%20Annals%20of%20Statistics%2C%2049(5)%2C%202885-2915.%0A%0A%20%20%20%20%20%20%20%2010.%20Athey%2C%20S.%2C%20%26%20Imbens%2C%20G.%20(2019).%20**Machine%20learning%20methods%20that%20economists%20should%20know%20about**.%20Annual%20Review%20of%20Economics.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fweb.stanford.edu%2F~athey%2Fpapers%2FMLECTA.pdf%5D(https%3A%2F%2Fweb.stanford.edu%2F~athey%2Fpapers%2FMLECTA.pdf)%0A%0A%20%20%20%20%20%20%20%20%23%23%23%23%20Online%20Resources%0A%0A%20%20%20%20%20%20%20%2011.%20Neal%2C%20B.%20(2023).%20**Which%20causal%20inference%20book%20you%20should%20read**.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.bradyneal.com%2Fwhich-causal-inference-book%5D(https%3A%2F%2Fwww.bradyneal.com%2Fwhich-causal-inference-book)%0A%0A%20%20%20%20%20%20%20%2012.%20Pearl%2C%20J.%20**Causal%20Inference%20in%20Statistics%3A%20A%20Primer%20(Course%20Materials)**.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttp%3A%2F%2Fbayes.cs.ucla.edu%2FPRIMER%2F%5D(http%3A%2F%2Fbayes.cs.ucla.edu%2FPRIMER%2F)%0A%0A%20%20%20%20%20%20%20%2013.%20**Introduction%20to%20Causal%20Inference%20(Course)**%20by%20Brady%20Neal.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fwww.bradyneal.com%2Fcausal-inference-course%5D(https%3A%2F%2Fwww.bradyneal.com%2Fcausal-inference-course)%0A%0A%20%20%20%20%20%20%20%2014.%20**DoWhy%3A%20A%20Python%20library%20for%20causal%20inference**.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fmicrosoft.github.io%2Fdowhy%2F%5D(https%3A%2F%2Fmicrosoft.github.io%2Fdowhy%2F)%0A%0A%20%20%20%20%20%20%20%2015.%20**EconML%3A%20A%20Python%20library%20for%20ML-based%20causal%20inference**.%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bhttps%3A%2F%2Fgithub.com%2Fmicrosoft%2FEconML%5D(https%3A%2F%2Fgithub.com%2Fmicrosoft%2FEconML)%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Bsubsection_header%2C%20references%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20def%20_()%3A%0A%20%20%20%20%20%20%20%20license_header%20%3D%20mo.md(%22%22%22%23%23%23%20License%20%7B%23license%7D%22%22%22)%0A%0A%20%20%20%20%20%20%20%20license_text%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%20MIT%20License%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Understanding%20Causal%20Inference%20with%20IHDP%3A%20From%20Theory%20to%20Practice**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Copyright%20(c)%202025%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Permission%20is%20hereby%20granted%2C%20free%20of%20charge%2C%20to%20any%20person%20obtaining%20a%20copy%0A%20%20%20%20%20%20%20%20%20%20%20%20of%20this%20software%20and%20associated%20documentation%20files%20(the%20%22Notebook%22)%2C%20to%20deal%0A%20%20%20%20%20%20%20%20%20%20%20%20in%20the%20Notebook%20without%20restriction%2C%20including%20without%20limitation%20the%20rights%0A%20%20%20%20%20%20%20%20%20%20%20%20to%20use%2C%20copy%2C%20modify%2C%20merge%2C%20publish%2C%20distribute%2C%20sublicense%2C%20and%2For%20sell%0A%20%20%20%20%20%20%20%20%20%20%20%20copies%20of%20the%20Notebook%2C%20and%20to%20permit%20persons%20to%20whom%20the%20Notebook%20is%0A%20%20%20%20%20%20%20%20%20%20%20%20furnished%20to%20do%20so%2C%20subject%20to%20the%20following%20conditions%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20above%20copyright%20notice%20and%20this%20permission%20notice%20shall%20be%20included%20in%20all%0A%20%20%20%20%20%20%20%20%20%20%20%20copies%20or%20substantial%20portions%20of%20the%20Notebook.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20THE%20NOTEBOOK%20IS%20PROVIDED%20%22AS%20IS%22%2C%20WITHOUT%20WARRANTY%20OF%20ANY%20KIND%2C%20EXPRESS%20OR%0A%20%20%20%20%20%20%20%20%20%20%20%20IMPLIED%2C%20INCLUDING%20BUT%20NOT%20LIMITED%20TO%20THE%20WARRANTIES%20OF%20MERCHANTABILITY%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20FITNESS%20FOR%20A%20PARTICULAR%20PURPOSE%20AND%20NONINFRINGEMENT.%20IN%20NO%20EVENT%20SHALL%20THE%0A%20%20%20%20%20%20%20%20%20%20%20%20AUTHORS%20OR%20COPYRIGHT%20HOLDERS%20BE%20LIABLE%20FOR%20ANY%20CLAIM%2C%20DAMAGES%20OR%20OTHER%0A%20%20%20%20%20%20%20%20%20%20%20%20LIABILITY%2C%20WHETHER%20IN%20AN%20ACTION%20OF%20CONTRACT%2C%20TORT%20OR%20OTHERWISE%2C%20ARISING%20FROM%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20OUT%20OF%20OR%20IN%20CONNECTION%20WITH%20THE%20NOTEBOOK%20OR%20THE%20USE%20OR%20OTHER%20DEALINGS%20IN%20THE%0A%20%20%20%20%20%20%20%20%20%20%20%20NOTEBOOK.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20---%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Citation%20Information%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20If%20you%20use%20this%20notebook%20in%20your%20research%20or%20teaching%2C%20please%20cite%20it%20as%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%60%60%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%40misc%7Bcausal_inference_ihdp%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20author%20%3D%20%7BSai%20Surya%20Madhav%20Rebbapragada%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%20%3D%20%7BUnderstanding%20Causal%20Inference%20with%20IHDP%3A%20From%20Theory%20to%20Practice%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20year%20%3D%20%7B2025%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20url%20%3D%20%7Bhttps%3A%2F%2Fgithub.com%2Fsurya-madhav%2Fcausal-inference-ihdp%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%60%60%60%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20**Data%20Attribution%3A**%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20IHDP%20data%20used%20in%20this%20notebook%20is%20based%20on%20the%20Infant%20Health%20and%20Development%20Program%20and%20was%20modified%20by%20Hill%20(2011)%20for%20causal%20inference%20research.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Hill%2C%20J.%20L.%20(2011).%20Bayesian%20nonparametric%20modeling%20for%20causal%20inference.%20Journal%20of%20Computational%20and%20Graphical%20Statistics%2C%2020(1)%2C%20217-240.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.output.replace(mo.vstack(%5Blicense_header%2C%20license_text%5D))%0A%20%20%20%20_()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
